{% extends "base.html" %}
{% from 'partials/stat_card.html' import stat_card %}
{% block content %}

<div class="dashboard-top-section">
  <div class="dashboard-left">
    <div class="section-header">
      <div>
        <h2 class="h-title">Overzicht</h2>
        <div class="h-sub">Overzicht van materieelbeheer</div>
      </div>
    </div>

    <!-- KPI's -->
    <div class="grid grid-top">
      {{ stat_card(
        title="Totaal materiaal",
        value=total_items,
        subtitle="Items in het systeem",
        icon="bi bi-box-seam"
      ) }}
      
      {{ stat_card(
        title="Keuring vereiste",
        value=to_inspect,
        subtitle="Items te keuren",
        icon="bi bi-exclamation-triangle kpi-alert",
        color="warn"
      ) }}
    </div>
  </div>

  <div class="hero-image">
    <img src="{{ url_for('static', filename='img/dashboard-hero.jpg.png') }}" alt="Overzicht hero" class="hero-image-img">
  </div>
</div>

<!-- Zoekbalk: zoekt via API en toont popup -->
<form class="card search" id="searchForm" onsubmit="return false;">
  <div class="search-wrap">
    <span class="search-icon"><i class="bi bi-search"></i></span>
    <input
      type="text"
      id="searchInput"
      class="search-input form-control"
      placeholder="Zoek een item in het systeem"
      aria-label="Zoek in materiaal"
    >
    <button class="btn btn-primary" type="submit" id="searchBtn">Zoeken</button>
  </div>
</form>

<!-- Panelen -->
<div class="grid grid-bottom">
  <div class="card panel">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <div class="panel-title">Recente Activiteit</div>
        <div class="panel-sub">Laatste wijzigingen in het systeem</div>
      </div>
      <a href="{{ url_for('geschiedenis.geschiedenis') }}" class="btn btn-sm btn-outline-primary">
        <i class="bi bi-clock-history me-1"></i>Geschiedenis
      </a>
    </div>

    {% if recent_activity and recent_activity|length > 0 %}
      <ul class="list-group list-group-flush">
        {% for a in recent_activity %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ a.user_name or 'Onbekende gebruiker' }}</strong>
              heeft
              <strong>{{ a.action }}</strong>:
              {{ a.name }}
              <span class="text-muted">({{ a.serial }})</span>
            </div>
            <small class="text-muted">
              {{ a.created_at.strftime("%Y-%m-%d %H:%M") if a.created_at }}
            </small>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Nog geen activiteit…</div>
    {% endif %}
  </div>

  <div class="card panel">
    <div class="panel-title">Aankomende Keuringen</div>
    <div class="panel-sub">Overzicht van geplande keuringen</div>

    {% if geplande_keuringen and geplande_keuringen|length > 0 %}
      <ul class="list-group list-group-flush">
        {% for keuring in geplande_keuringen %}
          {% set material = all_materials|selectattr("serial", "equalto", keuring.serienummer)|first %}
          {% set days_until = (keuring.volgende_controle - today).days if keuring.volgende_controle and today else 0 %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ material.name if material else 'Onbekend materiaal' }}</strong>
              <span class="text-muted">({{ keuring.serienummer }})</span>
              <br>
              <small class="text-muted">
                {{ keuring.volgende_controle.strftime('%Y-%m-%d') if keuring.volgende_controle else '-' }}
                {% if days_until > 0 %}
                  - over {{ days_until }} dag{% if days_until != 1 %}en{% endif %}
                {% endif %}
              </small>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Nog geen keuringen gepland…</div>
    {% endif %}
  </div>
</div>

<!-- Search Results Modal -->
<div class="modal fade" id="searchResultsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchModalTitle">Zoekresultaten</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>
      <div class="modal-body" id="searchModalBody">
        <div class="text-muted">Zoeken...</div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Gebruik Materieel -->
{% include 'partials/modals/gebruik_materieel.html' %}

<!-- Modal: Bewerken Materieel -->
<div class="modal fade" id="editMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Materieel Bewerken</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('materiaal.materiaal_bewerken') }}" enctype="multipart/form-data">
        <div class="modal-body">
          <input type="hidden" name="original_serial" id="edit-original-serial">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Naam*</label>
              <input name="name" id="edit-name" required class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Serienummer*</label>
              <input name="serial" id="edit-serial" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Nummer op Materieel (optioneel)</label>
              <input name="nummer_op_materieel" id="edit-nummer_op_materieel" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Type*</label>
              <input name="type" id="edit-type" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Aankoopdatum*</label>
              <input name="purchase_date" id="edit-purchase_date" type="date" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Laatste keuring (optioneel)</label>
              <input name="laatste_keuring" id="edit-laatste_keuring" type="date" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Werf (optioneel, vrije tekst)</label>
              <input name="site" id="edit-site" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Toegewezen aan (optioneel)</label>
              <input name="assigned_to" id="edit-assigned_to" class="form-control">
            </div>

            <div class="col-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="note" id="edit-note" class="form-control" rows="3"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label">Keuring*</label>
              <select name="status" id="edit-status" class="form-select" required>
                {% for status_key, status_data in inspection_statuses.items() %}
                <option value="{{ status_data.value }}">{{ status_data.label }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Keuringstatus (optioneel)</label>
              <input name="inspection_status" id="edit-inspection_status" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Documentatie (foto of PDF)</label>
              <input
                type="file"
                name="documentation"
                class="form-control"
                accept="image/*,.pdf"
              >
            </div>

            <div class="col-md-6">
              <label class="form-label">Veiligheidsfiche (handleiding)</label>
              <input
                type="file"
                name="safety_sheet"
                class="form-control"
                accept="image/*,.pdf"
              >
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
  // Helper function to escape HTML - handles all types safely
  function escapeHtml(value) {
    if (value === null || value === undefined) return '';
    
    // If it's already a string, use it; otherwise try to stringify safely.
    const text =
      typeof value === 'string'
        ? value
        : (typeof value === 'number' || typeof value === 'boolean')
          ? String(value)
          : Array.isArray(value)
            ? value.join(', ')
            : (typeof value === 'object')
              ? JSON.stringify(value)
              : String(value);
    
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }
  
  // Normalize API response to flat object of strings for safe rendering
  function normalizeMateriaalDetail(raw) {
    if (!raw) return {};
    
    return {
      id: raw.id != null ? String(raw.id) : '',
      material_id: raw.material_id != null ? String(raw.material_id) : (raw.id != null ? String(raw.id) : ''),
      serial: raw.serial != null ? String(raw.serial) : '',
      serienummer: raw.serial != null ? String(raw.serial) : '',
      name: raw.name != null ? String(raw.name) : '',
      type: raw.type != null ? String(raw.type) : '',
      status: raw.status != null ? String(raw.status) : '',
      is_in_use: raw.is_in_use === true,
      assigned_to: raw.assigned_to != null ? String(raw.assigned_to) : '',
      toegewezen_aan: raw.assigned_to != null ? String(raw.assigned_to) : '',
      site: raw.site != null ? String(raw.site) : '',
      werf: raw.site != null ? String(raw.site) : '',
      purchase_date: raw.purchase_date != null ? String(raw.purchase_date) : '',
      aankoop_datum: raw.purchase_date != null ? String(raw.purchase_date) : '',
      note: raw.note != null ? String(raw.note) : '',
      opmerking: raw.note != null ? String(raw.note) : '',
      nummer_op_materieel: raw.nummer_op_materieel != null ? String(raw.nummer_op_materieel) : '',
      documentation_path: raw.documentation_path != null ? String(raw.documentation_path) : '',
      documentation_url: raw.documentation_url != null ? String(raw.documentation_url) : '',
      safety_sheet_path: raw.safety_sheet_path != null ? String(raw.safety_sheet_path) : '',
      safety_sheet_url: raw.safety_sheet_url != null ? String(raw.safety_sheet_url) : '',
      veiligheidsfiche_pad: raw.safety_sheet_path != null ? String(raw.safety_sheet_path) : (raw.documentation_path != null ? String(raw.documentation_path) : ''),
      inspection_status: raw.inspection_status != null ? String(raw.inspection_status) : '',
      keuring_gepland: raw.keuring_gepland != null ? String(raw.keuring_gepland) : '',
      laatste_keuring: raw.laatste_keuring != null ? String(raw.laatste_keuring) : '',
      laatste_keuring_material: raw.laatste_keuring_material != null ? String(raw.laatste_keuring_material) : '',
      laatste_keuring_raw: raw.laatste_keuring_raw != null ? String(raw.laatste_keuring_raw) : '',
      inspection_validity_days: raw.inspection_validity_days != null ? (typeof raw.inspection_validity_days === 'number' ? raw.inspection_validity_days : parseInt(raw.inspection_validity_days) || 0) : null,
      documents: Array.isArray(raw.documents) ? raw.documents : []
    };
  }

  // Central function to open material detail modal from search
  // This function matches the working implementation from materiaal.html
  window.openMaterialDetailFromSearch = function(serial, options = {}) {
    if (!serial) {
      console.error('[Overzicht] No serial provided to openMaterialDetailFromSearch');
      return;
    }
    openMaterialDetailModal(serial, { ...options, from: 'search' });
  };
  
  // Central modal function that handles both table and search
  function openMaterialDetailModal(serial, options = {}) {
    const from = options.from || 'table';
    const showUseButton = from === 'search'; // Only show "Materiaal in gebruik nemen" when from search
    
    // Use the search results modal for consistency (same as dashboard)
    const modalElement = document.getElementById('searchResultsModal');
    if (!modalElement) {
      console.error('[Overzicht] Search results modal not found');
      return;
    }
    
    const modalBody = document.getElementById('searchModalBody');
    const modalTitle = document.getElementById('searchModalTitle');
    
    if (!modalBody || !modalTitle) {
      console.error('[Overzicht] Modal elements not found');
      return;
    }
    
    // Initialize modal
    let searchModal = null;
    if (typeof bootstrap !== 'undefined') {
      searchModal = bootstrap.Modal.getOrCreateInstance(modalElement);
    }
    
    if (!searchModal) {
      console.error('[Overzicht] Modal not available');
      return;
    }
    
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Laden...</span></div></div>';
    modalTitle.textContent = 'Materieel Details';
    searchModal.show();
    
    // Fetch material data using the same API endpoint as materiaal page
    console.log('[Overzicht] Fetching material data from /api/search?q=' + encodeURIComponent(serial));
    fetch(`/api/search?q=${encodeURIComponent(serial)}`)
      .then(response => {
        console.log('[Overzicht] API response status:', response.status, response.statusText);
        if (!response.ok) {
          // Try to get error details from response
          return response.json().then(errData => {
            console.error('[Overzicht] API error response:', errData);
            throw new Error(errData.error || `HTTP error! status: ${response.status}`);
          }).catch(() => {
            throw new Error(`HTTP error! status: ${response.status}`);
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('[Overzicht] API response data:', data);
        if (data.error) {
          console.error('[Overzicht] API returned error:', data.error);
          throw new Error(data.error);
        }
        if (!data.items || data.items.length === 0) {
          console.warn('[Overzicht] No items found in API response');
          modalBody.innerHTML = '<div class="text-muted text-center py-4">Item niet gevonden.</div>';
          return;
        }
        
        const rawItem = data.items[0];
        console.log('[Overzicht] Processing raw item:', rawItem);
        
        // Normalize the item to ensure all fields are safe strings/primitives
        const item = normalizeMateriaalDetail(rawItem);
        console.log('[Overzicht] Normalized item:', item);
        
        // Status: "in gebruik" or "niet in gebruik" - based on is_in_use from API
        const isInUse = item.is_in_use === true;
        const statusClass = isInUse ? 'bg-success' : 'bg-danger';
        const statusText = isInUse ? 'In gebruik' : 'Niet in gebruik';
        
        // Keuring: altijd gebaseerd op inspection_status (keuring_status in database)
        let keuringStatus = (item.inspection_status || '').trim();
          
          // Normalize keuring status values
          if (keuringStatus) {
            keuringStatus = keuringStatus.toLowerCase();
          } else {
            keuringStatus = '';
          }
          
          // Determine badge text based on keuring status
          let keuringText = '';
          
          if (keuringStatus === 'goedgekeurd') {
            keuringText = 'Goedgekeurd';
          } else if (keuringStatus === 'afgekeurd') {
            keuringText = 'Afgekeurd';
          } else if (keuringStatus === 'keuring verlopen') {
            keuringText = 'Keuring verlopen';
          } else if (keuringStatus === 'keuring gepland') {
            keuringText = 'Keuring gepland';
          } else if (keuringStatus === 'onder voorbehoud') {
            keuringText = 'Onder voorbehoud';
          } else if (keuringStatus) {
            // If there's a value but not recognized, use it as-is (capitalize first letter)
            keuringText = keuringStatus.charAt(0).toUpperCase() + keuringStatus.slice(1);
          } else {
            keuringText = 'Niet van toepassing';
          }
          
          // Create badge HTML for keuring status using CSS classes
          let keuringBadgeHtml = '';
          let badgeClass = '';
          
          if (keuringStatus === 'goedgekeurd') {
            badgeClass = 'badge-keuring-goedgekeurd';
          } else if (keuringStatus === 'afgekeurd') {
            badgeClass = 'badge-keuring-afgekeurd';
          } else if (keuringStatus === 'keuring verlopen') {
            badgeClass = 'badge-keuring-verlopen';
          } else if (keuringStatus === 'keuring gepland') {
            badgeClass = 'badge-keuring-gepland';
          } else if (keuringStatus === 'onder voorbehoud') {
            badgeClass = 'badge-keuring-onder-voorbehoud';
          } else {
            // Geen keuring - grijs
            badgeClass = 'badge-keuring-none';
          }
          
        // Always show badge, even if status is empty
        if (item.keuring_gepland) {
          keuringBadgeHtml = `<span class="badge ${badgeClass}">Keuring gepland: ${escapeHtml(item.keuring_gepland)}</span>`;
        } else {
          keuringBadgeHtml = `<span class="badge ${badgeClass}">${escapeHtml(keuringText)}</span>`;
        }
        
        // Helper function to display value or "onbekend" - handles all types safely
        // Note: item is already normalized, so values are always strings
        const displayValue = (value) => {
          if (value == null || value === '') return 'onbekend';
          // Convert to string safely before checking trim
          const str = typeof value === 'string' ? value : String(value);
          return str.trim() !== '' ? escapeHtml(str) : 'onbekend';
        };
        
        modalTitle.textContent = escapeHtml(item.name || 'Onbekend');
        
        // Build buttons HTML - conditionally show "Materiaal in gebruik nemen"
        let buttonsHtml = `
            <button type="button" 
                    class="btn btn-outline-secondary edit-material-btn" 
                    data-item-serial="${escapeHtml(item.serial || '')}"
                    onclick="openEditModalFromSearchSerial('${escapeHtml(item.serial || '')}')">
              Bewerken
            </button>`;
          
          if (showUseButton) {
            buttonsHtml += `
              <button type="button" 
                      class="btn btn-dark gebruik-btn" 
                      data-bs-toggle="modal" 
                      data-bs-target="#gebruikMaterieelModal"
                      data-item-name="${escapeHtml(item.name || '')}"
                      data-item-nummer="${escapeHtml(item.nummer_op_materieel || '')}">
                Materiaal in gebruik nemen
              </button>`;
          }
          
          modalBody.innerHTML = `
            <div class="material-detail">
              <div class="mb-3">
                <strong>Serienummer:</strong> ${displayValue(item.serial)}
              </div>
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <strong>Type:</strong><br>
                  ${displayValue(item.type)}
                </div>
                <div class="col-md-6">
                  <strong>Status:</strong><br>
                  <span class="badge ${statusClass}">${escapeHtml(statusText)}</span>
                </div>
                <div class="col-md-6">
                  <strong>Keuring:</strong><br>
                  ${keuringBadgeHtml}
                  ${item.laatste_keuring ? `
                    <br><small class="text-muted">Laatste keuring: ${escapeHtml(item.laatste_keuring)}</small>
                  ` : ''}
                </div>
                ${item.laatste_keuring_material ? `
                <div class="col-md-6">
                  <strong>Laatste keuring:</strong><br>
                  <span>${escapeHtml(item.laatste_keuring_material)}</span>
                </div>
                ` : ''}
                ${item.inspection_validity_days != null ? `
                <div class="col-md-6">
                  <strong>Keuring geldig (dagen):</strong><br>
                  <span>${escapeHtml(String(item.inspection_validity_days))} dagen</span>
                </div>
                ` : ''}
                <div class="col-md-6">
                  <strong>Toegewezen aan:</strong><br>
                  ${displayValue(item.assigned_to)}
                </div>
                <div class="col-md-6">
                  <strong>Werf:</strong><br>
                  ${displayValue(item.site)}
                </div>
                <div class="col-md-6">
                  <strong>Aankoopdatum:</strong><br>
                  ${displayValue(item.purchase_date)}
                </div>
                <div class="col-md-6">
                  <strong>Nummer op Materieel:</strong><br>
                  ${displayValue(item.nummer_op_materieel)}
                </div>
              </div>
              <div class="mb-3">
                <strong>Opmerking:</strong><br>
                ${displayValue(item.note)}
              </div>
              ${(() => {
                // Groepeer documenten per bucket/type
                const docsByBucket = {};
                if (item.documents && item.documents.length > 0) {
                  item.documents.forEach(doc => {
                    let bucketName = '';
                    if (doc.document_type === 'Aankoopfactuur' || doc.document_type === 'Verkoopfactuur') {
                      bucketName = 'Aankoop-Verkoop documenten';
                    } else if (doc.document_type === 'Keuringstatus') {
                      bucketName = 'Keuringsstatus documenten';
                    } else if (doc.document_type === 'Veiligheidsfiche') {
                      bucketName = 'Veiligheidsfiche';
                    } else {
                      bucketName = 'Aankoop-Verkoop documenten'; // default
                    }
                    
                    if (!docsByBucket[bucketName]) {
                      docsByBucket[bucketName] = [];
                    }
                    docsByBucket[bucketName].push(doc);
                  });
                }
                
                // Voeg ook legacy documentation_path en safety_sheet_path toe
                if (item.documentation_path) {
                  if (!docsByBucket['Aankoop-Verkoop documenten']) {
                    docsByBucket['Aankoop-Verkoop documenten'] = [];
                  }
                  docsByBucket['Aankoop-Verkoop documenten'].push({
                    file_name: 'Documentatie',
                    file_url: item.documentation_url || item.documentation_path,
                    document_type: 'Documentatie',
                    id: null  // Legacy document heeft geen ID
                  });
                }
                
                if (item.safety_sheet_path) {
                  if (!docsByBucket['Veiligheidsfiche']) {
                    docsByBucket['Veiligheidsfiche'] = [];
                  }
                  docsByBucket['Veiligheidsfiche'].push({
                    file_name: 'Veiligheidsfiche',
                    file_url: item.safety_sheet_url || item.safety_sheet_path,
                    document_type: 'Veiligheidsfiche',
                    id: null  // Legacy document heeft geen ID
                  });
                }
                
                let html = '';
                Object.keys(docsByBucket).forEach(bucketName => {
                  const docs = docsByBucket[bucketName];
                  if (docs.length > 0) {
                    html += `
                      <div class="mb-3">
                        <strong>${escapeHtml(bucketName)}:</strong><br>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                    `;
                    docs.forEach(doc => {
                      // Safely extract document properties
                      const docId = doc.id != null ? String(doc.id) : null;
                      const docFileUrl = doc.file_url != null ? String(doc.file_url) : '';
                      const docFileName = doc.file_name != null ? String(doc.file_name) : (doc.document_type != null ? String(doc.document_type) : 'Bekijk');
                      
                      if (docFileUrl || docId) {
                        // Gebruik download route als document ID beschikbaar is, anders directe URL
                        const viewUrl = docId ? `/documenten/download/${docId}` : escapeHtml(docFileUrl);
                        const downloadUrl = docId ? `/documenten/download/${docId}` : escapeHtml(docFileUrl);
                        html += `
                          <a href="${viewUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye me-1"></i>${escapeHtml(docFileName)}
                          </a>
                          <a href="${downloadUrl}" download="${escapeHtml(docFileName)}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-download me-1"></i>Download
                          </a>
                        `;
                      }
                    });
                    html += `
                        </div>
                      </div>
                    `;
                  }
                });
                return html;
              })()}
              <div class="d-flex gap-2 mt-4">
                ${buttonsHtml}
              </div>
            </div>
          `;
          
          // Set up event handlers for buttons
          const gebruikBtn = modalBody.querySelector('.gebruik-btn');
          if (gebruikBtn) {
            gebruikBtn.addEventListener('click', function() {
              const name = this.getAttribute('data-item-name') || '';
              const nummer = this.getAttribute('data-item-nummer') || '';
              const gebruikModal = document.getElementById('gebruikMaterieelModal');
              if (gebruikModal) {
                const nameInput = document.getElementById('use-name');
                const nummerInput = document.getElementById('use-nummer_op_materieel');
                if (nameInput) nameInput.value = name;
                if (nummerInput) nummerInput.value = nummer;
              }
            });
          }
      })
      .catch(error => {
        if (error.name !== 'AbortError') {
          console.error('[Overzicht details] Error loading material detail:', error);
          console.error('[Overzicht details] Error details:', {
            name: error.name,
            message: error.message,
            stack: error.stack,
            response: error.response
          });
          
          // Show more informative error message
          const errorMessage = error.message || 'Er is een fout opgetreden bij het laden van de details.';
          const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          
          modalBody.innerHTML = `<div class="alert alert-danger">
            <strong>Details konden niet geladen worden.</strong>
            ${isDev ? `<br><small>Fout: ${escapeHtml(errorMessage)}</small>` : ''}
            <br><small>Controleer de console voor meer details.</small>
          </div>`;
        }
      });
  };
  
  // Override with materiaal.html's implementation if available (it's more complete)
  // This ensures both pages use the same working code
  document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for materiaal.html's script to load if it's on the same page
    setTimeout(() => {
      if (window.openMaterialDetailFromSearch && 
          window.openMaterialDetailFromSearch.toString().includes('openMaterialDetailModal')) {
        console.log('[Overzicht] Using materiaal.html implementation of openMaterialDetailFromSearch');
        // The function is already overridden by materiaal.html, so we're good
      }
    }, 100);
  });

document.addEventListener('DOMContentLoaded', function() {
  const searchForm = document.getElementById('searchForm');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  
  // Initialize modal only when Bootstrap is available
  let searchModal = null;
  const modalElement = document.getElementById('searchResultsModal');
  if (modalElement && typeof bootstrap !== 'undefined') {
    searchModal = bootstrap.Modal.getOrCreateInstance(modalElement);
  } else if (modalElement) {
    // Fallback if Bootstrap not yet loaded
    searchModal = new bootstrap.Modal(modalElement);
  }
  
  function performSearch() {
    const query = searchInput.value.trim();
    if (!query) {
      return;
    }
    
    // Ensure modal is initialized
    if (!searchModal && modalElement && typeof bootstrap !== 'undefined') {
      searchModal = bootstrap.Modal.getOrCreateInstance(modalElement);
    }
    
    if (!searchModal) {
      console.error('Search modal not available');
      alert('Zoekfunctionaliteit is niet beschikbaar. Herlaad de pagina.');
      return;
    }
    
    const modalBody = document.getElementById('searchModalBody');
    const modalTitle = document.getElementById('searchModalTitle');
    
    if (!modalBody || !modalTitle) {
      console.error('Modal elements not found');
      return;
    }
    
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Laden...</span></div></div>';
    modalTitle.textContent = `Zoekresultaten voor "${query}"`;
    searchModal.show();
    
    fetch(`/api/search?q=${encodeURIComponent(query)}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        if (data.items && data.items.length > 0) {
          // If single result, show detailed view; otherwise show list
          if (data.items.length === 1) {
            const item = data.items[0];
            // Status: "in gebruik" or "niet in gebruik" - based on is_in_use from API
            const isInUse = item.is_in_use === true;
            const statusClass = isInUse ? 'bg-success' : 'bg-danger';
            const statusText = isInUse ? 'In gebruik' : 'Niet in gebruik';
            
            // Keuring: altijd gebaseerd op inspection_status (keuring_status in database)
            let keuringStatus = (item.inspection_status || '').toString().trim();
            
            // Normalize keuring status values
            if (keuringStatus) {
              keuringStatus = keuringStatus.toLowerCase();
            } else {
              keuringStatus = '';
            }
            
            // Determine badge text based on keuring status
            let keuringText = '';
            
            if (keuringStatus === 'goedgekeurd') {
              keuringText = 'Goedgekeurd';
            } else if (keuringStatus === 'afgekeurd') {
              keuringText = 'Afgekeurd';
            } else if (keuringStatus === 'keuring verlopen') {
              keuringText = 'Keuring verlopen';
            } else if (keuringStatus === 'keuring gepland') {
              keuringText = 'Keuring gepland';
            } else if (keuringStatus === 'onder voorbehoud') {
              keuringText = 'Onder voorbehoud';
            } else if (keuringStatus) {
              // If there's a value but not recognized, use it as-is (capitalize first letter)
              keuringText = keuringStatus.charAt(0).toUpperCase() + keuringStatus.slice(1);
            } else {
              keuringText = 'Niet van toepassing';
            }
            
            // Create badge HTML for keuring status using CSS classes
            let keuringBadgeHtml = '';
            let badgeClass = '';
            
            if (keuringStatus === 'goedgekeurd') {
              badgeClass = 'badge-keuring-goedgekeurd';
            } else if (keuringStatus === 'afgekeurd') {
              badgeClass = 'badge-keuring-afgekeurd';
            } else if (keuringStatus === 'keuring verlopen') {
              badgeClass = 'badge-keuring-verlopen';
            } else if (keuringStatus === 'keuring gepland') {
              badgeClass = 'badge-keuring-gepland';
            } else if (keuringStatus === 'onder voorbehoud') {
              badgeClass = 'badge-keuring-onder-voorbehoud';
            } else {
              // Geen keuring - grijs
              badgeClass = 'badge-keuring-none';
            }
            
            // Always show badge, even if status is empty
            if (item.keuring_gepland) {
              keuringBadgeHtml = `<span class="badge ${badgeClass}">Keuring gepland: ${escapeHtml(item.keuring_gepland)}</span>`;
            } else {
              keuringBadgeHtml = `<span class="badge ${badgeClass}">${escapeHtml(keuringText)}</span>`;
            }
            
            // Use central function (defined above)
            // Close search results modal first
            searchModal.hide();
            // Use central function which will show the detail
            window.openMaterialDetailFromSearch(item.serial, { from: 'search' });
            return; // Exit early, central function handles everything
            
            // Fallback: inline implementation (should not happen if materiaal.html is loaded)
            // Helper function to display value or "onbekend" - handles all types safely
            const displayValue = (value) => {
              if (value == null || value === '') return 'onbekend';
              // Convert to string safely before checking trim
              const str = typeof value === 'string' ? value : String(value);
              return str.trim() !== '' ? escapeHtml(str) : 'onbekend';
            };
            
            modalTitle.textContent = escapeHtml(item.name || 'Onbekend');
            modalBody.innerHTML = `
              <div class="material-detail">
                <div class="mb-3">
                  <strong>Serienummer:</strong> ${displayValue(item.serial)}
                </div>
                <div class="row g-3 mb-3">
                  <div class="col-md-6">
                    <strong>Type:</strong><br>
                    ${displayValue(item.type)}
                  </div>
                  <div class="col-md-6">
                    <strong>Status:</strong><br>
                    <span class="badge ${statusClass}">${escapeHtml(statusText)}</span>
                  </div>
                  <div class="col-md-6">
                    <strong>Keuring:</strong><br>
                    ${keuringBadgeHtml}
                    ${item.laatste_keuring ? `
                      <br><small class="text-muted">Laatste keuring: ${escapeHtml(item.laatste_keuring)}</small>
                    ` : ''}
                  </div>
                  ${item.laatste_keuring_material ? `
                  <div class="col-md-6">
                    <strong>Laatste keuring:</strong><br>
                    <span>${escapeHtml(item.laatste_keuring_material)}</span>
                  </div>
                  ` : ''}
                  ${item.inspection_validity_days != null ? `
                  <div class="col-md-6">
                    <strong>Keuring geldig (dagen):</strong><br>
                    <span>${escapeHtml(item.inspection_validity_days)} dagen</span>
                  </div>
                  ` : ''}
                  <div class="col-md-6">
                    <strong>Toegewezen aan:</strong><br>
                    ${displayValue(item.assigned_to)}
                  </div>
                  <div class="col-md-6">
                    <strong>Werf:</strong><br>
                    ${displayValue(item.site)}
                  </div>
                  <div class="col-md-6">
                    <strong>Aankoopdatum:</strong><br>
                    ${displayValue(item.purchase_date)}
                  </div>
                  <div class="col-md-6">
                    <strong>Nummer op Materieel:</strong><br>
                    ${displayValue(item.nummer_op_materieel)}
                  </div>
                </div>
                <div class="mb-3">
                  <strong>Opmerking:</strong><br>
                  ${displayValue(item.note)}
                </div>
                ${(() => {
                  // Groepeer documenten per bucket/type
                  const docsByBucket = {};
                  if (item.documents && item.documents.length > 0) {
                    item.documents.forEach(doc => {
                      let bucketName = '';
                      if (doc.document_type === 'Aankoopfactuur' || doc.document_type === 'Verkoopfactuur') {
                        bucketName = 'Aankoop-Verkoop documenten';
                      } else if (doc.document_type === 'Keuringstatus') {
                        bucketName = 'Keuringsstatus documenten';
                      } else if (doc.document_type === 'Veiligheidsfiche') {
                        bucketName = 'Veiligheidsfiche';
                      } else {
                        bucketName = 'Aankoop-Verkoop documenten'; // default
                      }
                      
                      if (!docsByBucket[bucketName]) {
                        docsByBucket[bucketName] = [];
                      }
                      docsByBucket[bucketName].push(doc);
                    });
                  }
                  
                // Voeg ook legacy documentation_path en safety_sheet_path toe
                if (item.documentation_path) {
                  if (!docsByBucket['Aankoop-Verkoop documenten']) {
                    docsByBucket['Aankoop-Verkoop documenten'] = [];
                  }
                  docsByBucket['Aankoop-Verkoop documenten'].push({
                    file_name: 'Documentatie',
                    file_url: item.documentation_url || (item.documentation_path ? '/static/' + item.documentation_path : ''),
                    document_type: 'Documentatie',
                    id: null  // Legacy document heeft geen ID
                  });
                }
                
                if (item.safety_sheet_path) {
                  if (!docsByBucket['Veiligheidsfiche']) {
                    docsByBucket['Veiligheidsfiche'] = [];
                  }
                  docsByBucket['Veiligheidsfiche'].push({
                    file_name: 'Veiligheidsfiche',
                    file_url: item.safety_sheet_url || (item.safety_sheet_path ? '/static/' + item.safety_sheet_path : ''),
                    document_type: 'Veiligheidsfiche',
                    id: null  // Legacy document heeft geen ID
                  });
                }
                
                let html = '';
                Object.keys(docsByBucket).forEach(bucketName => {
                  const docs = docsByBucket[bucketName];
                  if (docs.length > 0) {
                    html += `
                      <div class="mb-3">
                        <strong>${escapeHtml(bucketName)}:</strong><br>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                    `;
                    docs.forEach(doc => {
                      // Safely extract document properties
                      const docId = doc.id != null && doc.id !== 'null' ? String(doc.id) : null;
                      const docFileUrl = doc.file_url != null ? String(doc.file_url) : '';
                      const docFileName = doc.file_name != null ? String(doc.file_name) : (doc.document_type != null ? String(doc.document_type) : 'Bekijk');
                      
                      // Gebruik download route als document ID beschikbaar is, anders directe URL
                      if (docId) {
                        const viewUrl = `/documenten/download/${docId}`;
                        const downloadUrl = `/documenten/download/${docId}`;
                        html += `
                          <a href="${viewUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye me-1"></i>${escapeHtml(docFileName)}
                          </a>
                          <a href="${downloadUrl}" download="${escapeHtml(docFileName)}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-download me-1"></i>Download
                          </a>
                        `;
                      } else if (docFileUrl && docFileUrl.trim() !== '') {
                        // Legacy documenten zonder ID - gebruik directe URL
                        html += `
                          <a href="${escapeHtml(docFileUrl)}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye me-1"></i>${escapeHtml(docFileName)}
                          </a>
                          <a href="${escapeHtml(docFileUrl)}" download="${escapeHtml(docFileName)}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-download me-1"></i>Download
                          </a>
                        `;
                      }
                    });
                    html += `
                        </div>
                      </div>
                    `;
                  }
                });
                return html;
              })()}
                <div class="d-flex gap-2 mt-4">
                  <button type="button"
                          class="btn btn-outline-secondary edit-material-btn" 
                          data-item-serial="${escapeHtml(item.serial || '')}"
                          onclick="openEditModalFromSearchSerial('${escapeHtml(item.serial || '')}')">
                    Bewerken
                  </button>
                  <button type="button" 
                          class="btn btn-dark gebruik-btn" 
                          data-bs-toggle="modal" 
                          data-bs-target="#gebruikMaterieelModal"
                          data-item-name="${escapeHtml(item.name || '')}"
                          data-item-nummer="${escapeHtml(item.nummer_op_materieel || '')}">
                    Materiaal in gebruik nemen
                  </button>
                </div>
              </div>
            `;
          } else {
            // Multiple results - show list
            let html = '<div class="list-group list-group-scrollable">';
            data.items.forEach(item => {
              // Status: "in gebruik" or "niet in gebruik" - use is_in_use from API
              const isInUse = item.is_in_use === true;
              const statusClass = isInUse ? 'bg-success' : 'bg-danger';
              const statusText = isInUse ? 'In gebruik' : 'Niet in gebruik';
              html += `
                <div class="list-group-item list-group-item-action list-group-item-hover" 
                     onclick="if (window.openMaterialDetailFromSearch) { window.openMaterialDetailFromSearch('${escapeHtml(item.serial)}'); } else { showMaterialDetail('${escapeHtml(item.serial)}'); }">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <h6 class="mb-1 fw-bold">${escapeHtml(item.name || 'Onbekend')}</h6>
                      <small class="text-muted">Serienummer: ${escapeHtml(item.serial || 'Onbekend')}</small>
                      ${item.type ? `<br><small class="text-muted">Type: ${escapeHtml(item.type)}</small>` : ''}
                    </div>
                    <span class="badge ${statusClass} ms-2">${escapeHtml(statusText)}</span>
                  </div>
                </div>
              `;
            });
            html += '</div>';
            modalBody.innerHTML = html;
          }
        } else {
          modalBody.innerHTML = '<div class="text-muted text-center py-4">Geen resultaten gevonden.</div>';
        }
      })
      .catch(error => {
        console.error('Search error:', error);
        const errorMessage = error.message || 'Er is een fout opgetreden bij het zoeken.';
        modalBody.innerHTML = `<div class="alert alert-danger">
          <strong>Zoekfout:</strong> ${escapeHtml(errorMessage)}
          <br><small>Controleer de console voor meer details.</small>
        </div>`;
      });
  }
  
  searchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    performSearch();
  });
  
  searchBtn.addEventListener('click', function(e) {
    e.preventDefault();
    performSearch();
  });
  
  // escapeHtml function - make it globally available (use the safe version defined above)
  // This is just an alias to ensure it's available globally
  if (typeof window.escapeHtml === 'undefined') {
    window.escapeHtml = escapeHtml;
  }
  
  // escapeHtml is already made globally available above
  
  // Use central function from materiaal.html if available, otherwise fallback to local implementation
  window.showMaterialDetail = function(serial) {
    if (!serial) {
      console.error('No serial provided to showMaterialDetail');
      return;
    }
    
    // Use central function if available (from materiaal.html)
    if (window.openMaterialDetailFromSearch) {
      window.openMaterialDetailFromSearch(serial);
      return;
    }
    
    // Fallback to local implementation if central function not available
    // (This should not happen if materiaal.html is loaded, but kept as safety)
    console.warn('Central material detail function not available, using fallback');
  };
  
  // Handle "Gebruik Materieel" button clicks using event delegation
  document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('gebruik-btn')) {
      const name = e.target.getAttribute('data-item-name') || '';
      
      const nameInput = document.getElementById('use-name');
      
      if (nameInput) nameInput.value = name;
    }
  });
  
  // Also handle when modal is shown via Bootstrap
  const gebruikModal = document.getElementById('gebruikMaterieelModal');
  if (gebruikModal) {
    gebruikModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      if (button && button.classList.contains('gebruik-btn')) {
        const name = button.getAttribute('data-item-name') || '';
        
        const nameInput = document.getElementById('use-name');
        
        if (nameInput) nameInput.value = name;
      }
    });
  }
  
  // Function to open edit modal and populate it with material data from search results
  window.openEditModalFromSearchSerial = function(serial) {
    if (!serial) {
      alert('Serienummer niet gevonden.');
      return;
    }
    
    // Close search results modal if open
    const searchModal = bootstrap.Modal.getInstance(document.getElementById('searchResultsModal'));
    if (searchModal) {
      searchModal.hide();
    }
    
    // Fetch material data by serial
    fetch(`/api/search?q=${encodeURIComponent(serial)}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        if (data.items && data.items.length > 0) {
          const item = data.items[0];
          
          // Populate edit modal with the material data
          const editModal = new bootstrap.Modal(document.getElementById('editMaterieelModal'));
          document.getElementById('edit-original-serial').value = item.serial || '';
          document.getElementById('edit-serial').value = item.serial || '';
          document.getElementById('edit-name').value = item.name || '';
          document.getElementById('edit-type').value = item.type || '';
          document.getElementById('edit-purchase_date').value = item.purchase_date || '';
          document.getElementById('edit-laatste_keuring').value = item.laatste_keuring_raw || item.laatste_keuring_material || '';
          document.getElementById('edit-assigned_to').value = item.assigned_to || '';
          document.getElementById('edit-site').value = item.site || '';
          document.getElementById('edit-note').value = item.note || '';
          
          // For keuring status: if status is "in gebruik", use inspection_status if available, otherwise default to "goedgekeurd"
          let keuringValue = 'goedgekeurd';
          if (item.status === 'in gebruik') {
            // Material is in use, check inspection_status for the original keuring
            keuringValue = item.inspection_status || 'goedgekeurd';
          } else {
            // Material is not in use, status is the keuring status
            keuringValue = item.status || 'goedgekeurd';
          }
          document.getElementById('edit-status').value = keuringValue;
          
          document.getElementById('edit-inspection_status').value = item.inspection_status || '';
          document.getElementById('edit-nummer_op_materieel').value = item.nummer_op_materieel || '';
          
          // Show the edit modal
          editModal.show();
        } else {
          alert('Materiaal niet gevonden.');
        }
      })
      .catch(error => {
        console.error('Error loading material for editing:', error);
        alert('Er is een fout opgetreden bij het laden van de materiaalgegevens.');
      });
  };
});
</script>

{% endblock %}
