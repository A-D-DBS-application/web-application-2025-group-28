{% extends "base.html" %}
{% from 'partials/stat_card.html' import stat_card %}
{% block content %}

<div class="section-header">
  <div>
    <h2 class="h-title">Materieelbeheer</h2>
    <div class="h-sub">Overzicht van beheer van al het bedrijfsmateriaal</div>
  </div>

  <!-- Knoppen rechts naast de paginatitel -->
  <div class="d-flex gap-2">
    <button class="btn btn-dark d-inline-flex align-items-center gap-2"
            data-bs-toggle="modal"
            data-bs-target="#gebruikMaterieelModal">
      <span class="fs-5 lh-1">+</span>
      <span>Gebruik materiaal</span>
    </button>
    <a href="{{ url_for('materiaal.materiaal_types') }}" 
       class="btn btn-outline-dark d-inline-flex align-items-center gap-2">
      <span>Types materiaal</span>
    </a>
  </div>
</div>

<!-- KPI's in Ã©Ã©n grid -->
<div class="grid grid-top">
  {{ stat_card(
    title="Totaal materiaal",
    value=total_items,
    subtitle="Items in het systeem",
    icon="bi bi-box-seam",
    position_relative=True,
    extra_button='<button class="materiaal-add-button" type="button" data-bs-toggle="modal" data-bs-target="#nieuwMaterieelModal" title="Nieuw materiaal toevoegen"><i class="bi bi-plus-lg"></i></button>'
  ) }}

  {{ stat_card(
    title="Momenteel in gebruik",
    value=in_use,
    subtitle="Items in een project",
    icon="bi bi-box-seam-fill"
  ) }}
</div>

<!-- BLOK: Materieel in gebruik â€“ zelfde breedte als "Materiaal in het systeem" -->
<div class="card panel usage-panel mt-8">
    <div class="panel-title">Materieel in gebruik</div>
    <div class="panel-sub">Overzicht van gebruikte items</div>

    <ul class="nav nav-tabs mt-6" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="my-usage-tab" data-bs-toggle="tab"
                data-bs-target="#my-usage" type="button" role="tab">
          Door mij in gebruik ({{ my_usages|length }})
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="others-usage-tab" data-bs-toggle="tab"
                data-bs-target="#others-usage" type="button" role="tab">
          Door anderen in gebruik ({{ other_usages|length }})
        </button>
      </li>
    </ul>

    <div class="tab-content mt-6">
      <!-- TAB: door mij -->
      <div class="tab-pane fade show active" id="my-usage" role="tabpanel" aria-labelledby="my-usage-tab">
        {% if my_usages %}
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr>
                  <th>Serienummer</th>
                  <th>Naam</th>
                  <th>Werf</th>
                  <th>In gebruik sinds</th>
                  <th class="text-end">Acties</th>
                </tr>
              </thead>
              <tbody>
                {% for u in my_usages %}
                  <tr>
                    <td>{{ u.serial }}</td>
                    <td>{{ u.name }}</td>
                    <td>{{ u.site or '-' }}</td>
                    <td>
                      {% if u.start_time %}
                        {{ u.start_time.strftime("%Y-%m-%d %H:%M") }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <div class="d-flex gap-2 justify-content-end">
                        <button type="button"
                                class="btn btn-sm btn-outline-dark view-edit-btn"
                                data-serial="{{ u.serial }}"
                                data-usage-id="{{ u.id }}">
                          Bekijk en bewerk
                        </button>
                        <form method="post" action="{{ url_for('materiaal.materiaal_stop_gebruik') }}" class="d-inline" onsubmit="return confirm('Materiaal niet meer in gebruik zetten?');">
                          <input type="hidden" name="usage_id" value="{{ u.id }}">
                          <button type="submit" class="btn btn-sm btn-outline-secondary">
                            Niet meer gebruiken
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted mt-2">Je hebt momenteel geen materiaal in gebruik.</div>
        {% endif %}
      </div>

      <!-- TAB: door anderen -->
      <div class="tab-pane fade" id="others-usage" role="tabpanel" aria-labelledby="others-usage-tab">
        {% if other_usages %}
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr>
                  <th>Serienummer</th>
                  <th>Naam</th>
                  <th>Werf</th>
                  <th>Gebruikt door</th>
                  <th>In gebruik sinds</th>
                  <th class="text-end">Acties</th>
                </tr>
              </thead>
              <tbody>
                {% for u in other_usages %}
                  <tr>
                    <td>{{ u.serial }}</td>
                    <td>{{ u.name }}</td>
                    <td>{{ u.site or '-' }}</td>
                    <td>{{ u.used_by or '-' }}</td>
                    <td>
                      {% if u.start_time %}
                        {{ u.start_time.strftime("%Y-%m-%d %H:%M") }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <div class="d-flex gap-2 justify-content-end">
                        <button type="button"
                                class="btn btn-sm btn-outline-dark view-edit-btn"
                                data-serial="{{ u.serial }}"
                                data-usage-id="{{ u.id }}">
                          Bekijk en bewerk
                        </button>
                        {% if current_user and current_user.is_admin %}
                        <form method="post"
                              action="{{ url_for('materiaal.materiaal_stop_gebruik') }}"
                              class="d-inline"
                              onsubmit="return confirm('Materiaal van {{ u.used_by }} niet meer in gebruik zetten?');">
                          <input type="hidden" name="usage_id" value="{{ u.id }}">
                          <button class="btn btn-sm btn-outline-danger">
                            Stop gebruik
                          </button>
                        </form>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted mt-2">Geen materiaal in gebruik door andere gebruikers.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Materiaal in gebruik zonder werf -->
{% if usages_without_project %}
<div class="card panel panel-warning-orange">
  <div class="panel-title d-flex align-items-center">
    <i class="bi bi-exclamation-triangle"></i>
    Materiaal in gebruik zonder werf
  </div>
  <div class="panel-sub">Dit materiaal is in gebruik maar niet gekoppeld aan een werf</div>

  <div class="table-responsive mt-6">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th>Serienummer</th>
          <th>Naam</th>
          <th>Gebruikt door</th>
          <th>In gebruik sinds</th>
          <th class="text-end">Acties</th>
        </tr>
      </thead>
      <tbody>
        {% for u in usages_without_project %}
          <tr>
            <td>{{ u.serial }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.used_by or '-' }}</td>
            <td>
              {% if u.start_time %}
                {{ u.start_time.strftime("%Y-%m-%d %H:%M") }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="text-end">
              <div class="d-flex gap-2 justify-content-end">
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#assignToProjectModal"
                        data-usage-id="{{ u.id }}"
                        data-mat-name="{{ u.name }}"
                        data-mat-serial="{{ u.serial }}">
                  Koppel aan werf
                </button>
                <form method="post"
                      action="{{ url_for('materiaal.materiaal_stop_gebruik') }}"
                      class="d-inline"
                      onsubmit="return confirm('Materiaal niet meer in gebruik zetten?');">
                  <input type="hidden" name="usage_id" value="{{ u.id }}">
                  <button class="btn btn-sm btn-outline-secondary">
                    Stop gebruik
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- Flash messages (worden meestal al door base.html getoond, maar kan geen kwaad) -->
<div class="container px-0 mt-6">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category=='danger' else category }} mb-2" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<!-- Materiaallijst / overzicht -->
<div class="card panel mt-8">
  <div class="panel-title d-flex align-items-center justify-content-between">
    <div>
      Materiaal in het systeem
      <div class="panel-sub">Alle geregistreerde items</div>
    </div>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('materiaal.materiaal') }}">Herstel filters</a>
  </div>

  <!-- Filterbalk -->
  <form class="row g-2 align-items-center" method="get" action="{{ url_for('materiaal.materiaal') }}">
    <div class="col-12 col-md-6">
      <div class="input-group">
        <span class="input-group-text">ðŸ”Ž</span>
        <input name="q" value="{{ request.args.get('q','') }}" type="text" class="form-control" placeholder="Zoek op naam of serienummerâ€¦">
      </div>
    </div>

    <div class="col-6 col-md-3">
      <select name="type" class="form-select">
        <option value="">Alle types</option>
        {% for t in types_list %}
          <option value="{{ t }}" {% if request.args.get('type')==t %}selected{% endif %}>{{ t|title }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-3">
      <select name="status" class="form-select">
        <option value="">Alle statussen</option>
        {% for key, status in usage_statuses.items() %}
          <option value="{{ status.value }}" {% if request.args.get('status')==status.value %}selected{% endif %}>{{ status.label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12">
      <button class="btn btn-primary">Filteren</button>
    </div>
  </form>

  <!-- Tabel -->
  <div class="table-responsive mt-6">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Serienummer</th>
          <th>Naam</th>
          <th>Type</th>
          <th>Status (in gebruik)</th>
          <th>Keuring</th>
          <th class="text-end">Acties</th>
        </tr>
      </thead>
      <tbody>
        {% if items %}
          {% for it in items %}
          {% set is_in_use = it.id in active_material_ids %}
          {% set usage_id = None %}
          {% if is_in_use %}
            {% for u in (my_usages + other_usages) %}
              {% if u.material_id == it.id %}
                {% set usage_id = u.id %}
              {% endif %}
            {% endfor %}
          {% endif %}
          <tr class="material-row material-row-clickable" 
              data-serial="{{ it.serial }}"
              data-usage-id="{{ usage_id or '' }}"
              onclick="openMaterialDetailFromTable('{{ it.serial }}')">
            <td>{{ it.serial }}</td>
            <td>{{ it.name }}</td>
            <td>{{ it.type|title if it.type else '' }}</td>
            <td>
              {% if is_in_use %}
                <span class="badge bg-success">In gebruik</span>
              {% else %}
                <span class="badge bg-danger">Niet in gebruik</span>
              {% endif %}
            </td>
            <td>
              {% set keuring_status = it.inspection_status or "Niet van toepassing" %}
              <span class="badge inspection-badge">{{ keuring_status|title }}</span>
            </td>
            <td class="text-end" onclick="event.stopPropagation();">
              {% if current_user and current_user.is_admin %}
              <button type="button"
                      class="btn btn-sm btn-outline-danger"
                      data-bs-toggle="modal"
                      data-bs-target="#deleteMaterieelModal"
                      data-serial="{{ it.serial }}"
                      data-name="{{ it.name }}">
                Verwijderen
              </button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6" class="text-muted">Nog geen materiaal gevondenâ€¦</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal: Nieuw Materieel -->
<div class="modal fade" id="nieuwMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nieuw Materiaal Toevoegen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('materiaal.materiaal_toevoegen') }}" enctype="multipart/form-data" id="nieuwMaterieelForm">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Naam*</label>
              <input name="name" required class="form-control" placeholder="Bv. Boormachine Bosch">
            </div>
            <div class="col-md-6">
              <label class="form-label">Serienummer*</label>
              <input name="serial" required class="form-control" placeholder="Bv. BH-2024-001">
            </div>

            <div class="col-md-6">
              <label class="form-label">Nummer op Materieel (optioneel)</label>
              <input name="nummer_op_materieel" class="form-control" placeholder="Sticker / nummer op toestel">
            </div>

            <div class="col-md-6">
              <label class="form-label" for="type">Type*</label>
              <select id="type" name="type" required class="form-select">
                <option value="">-- Selecteer een type --</option>
                {% if all_material_types %}
                  {% for material_type in all_material_types %}
                    <option value="{{ material_type.name }}">{{ material_type.name }}</option>
                  {% endfor %}
                {% else %}
                  <option value="" disabled>Geen materiaaltypes beschikbaar. Voeg eerst een type toe.</option>
                {% endif %}
              </select>
              {% if not all_material_types %}
                <small class="text-muted">Geen materiaaltypes beschikbaar. <a href="{{ url_for('materiaal.materiaal_types') }}">Voeg eerst een type toe</a>.</small>
              {% endif %}
            </div>

            <div class="col-md-6">
              <label class="form-label">Aankoopdatum*</label>
              <input name="purchase_date" type="date" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Laatste keuring (optioneel)</label>
              <input name="laatste_keuring" type="date" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Keuringstatus*</label>
              <select name="keuring_status" id="keuring_status" class="form-select" required>
                {% for key, status in keuring_status_options.items() %}
                  <option value="{{ status.value }}">{{ status.label }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6" id="datum_geplande_keuring_container" style="display: none;">
              <label class="form-label">Datum geplande keuring*</label>
              <input name="datum_geplande_keuring" id="datum_geplande_keuring" type="date" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Werf (optioneel)</label>
              <select name="project_id" class="form-select">
                <option value="">Geen specifieke werf</option>
                {% for p in projects %}
                  {% set is_future = p.start_date and p.start_date > today %}
                  <option value="{{ p.id }}">
                    {{ p.name or 'Werf ' ~ p.id }}
                    {% if is_future and p.start_date %}
                      (start {{ p.start_date.strftime('%Y-%m-%d') }})
                    {% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Toegewezen aan (optioneel)</label>
              <input name="assigned_to" class="form-control" placeholder="Naam gebruiker">
            </div>

            <div class="col-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="note" class="form-control" rows="3" placeholder="Extra info over het materiaalâ€¦"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label">Document type (optioneel)</label>
              <select name="document_type" class="form-select">
                <option value="Aankoopfactuur" selected>Aankoopfactuur</option>
                <option value="Verkoopfactuur">Verkoopfactuur</option>
                <option value="Keuringstatus">Keuringstatus</option>
              </select>
              <small class="text-muted">Selecteer het type document dat je uploadt</small>
            </div>

            <div class="col-md-6">
              <label class="form-label">Documentatie (foto of PDF)</label>
              <input 
                type="file"
                name="documentation"
                class="form-control"
                accept="image/*,.pdf"
              >
              <small class="text-muted">Upload een document bij het aanmaken van het materiaal</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit" id="submitMaterieelBtn" {% if not all_material_types %}disabled{% endif %}>Materieel Toevoegen</button>
        </div>
      </form>
    </div>
  </div>
            </div>

<!-- Modal: Geen toegang (voor niet-admins) -->
<div class="modal fade" id="accessDeniedModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Geen toegang</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>
      <div class="modal-body">
        <p>Je hebt geen toegang tot deze functie. Alleen admins kunnen materiaal toevoegen of verwijderen.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Materieel verwijderen -->
<div class="modal fade" id="deleteMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('materiaal.materiaal_verwijderen') }}">
        <div class="modal-header">
          <h5 class="modal-title">Materieel verwijderen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="serial" id="delete-material-serial">
          <p>
            Weet je zeker dat je het materiaal
            <strong id="delete-material-name"></strong>
            wilt verwijderen?
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button type="submit" class="btn btn-danger">Verwijderen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Search Results (used for material details from table and search) -->
<div class="modal fade" id="searchResultsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchModalTitle">Materieel Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>
      <div class="modal-body" id="searchModalBody">
        <div class="text-muted">Laden...</div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Materieel Details -->
<div class="modal fade" id="materieelDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="details-material-name">Materieel Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>
      <div class="modal-body" id="materieelDetailsBody">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Laden...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Sluiten</button>
        <form method="post" action="{{ url_for('materiaal.materiaal_stop_gebruik') }}" id="stop-gebruik-form" class="d-inline hidden-important" onsubmit="return confirm('Materiaal niet meer in gebruik zetten?');">
          <input type="hidden" name="usage_id" id="stop-usage-id">
          <button type="submit" class="btn btn-outline-secondary" id="details-stop-btn">Niet meer gebruiken</button>
        </form>
        <a href="#" id="details-documentation-btn" class="btn btn-primary d-none" target="_blank">
          <i class="bi bi-file-earmark-text me-1"></i>Bekijk documentatie
        </a>
        <button type="button" class="btn btn-outline-secondary" id="details-edit-btn">Bewerken</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal: Bewerken -->
<div class="modal fade" id="editMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Materieel Bewerken</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('materiaal.materiaal_bewerken') }}" enctype="multipart/form-data">
        <div class="modal-body">
          <input type="hidden" name="original_serial" id="edit-original-serial">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Naam*</label>
              <input name="name" id="edit-name" required class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Serienummer*</label>
              <input name="serial" id="edit-serial" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Nummer op Materieel (optioneel)</label>
              <input name="nummer_op_materieel" id="edit-nummer_op_materieel" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label" for="edit-type">Type*</label>
              <select id="edit-type" name="type" required class="form-select">
                <option value="">-- Selecteer een type --</option>
                {% if all_material_types %}
                  {% for material_type in all_material_types %}
                    <option value="{{ material_type.name }}">{{ material_type.name }}</option>
                  {% endfor %}
                {% else %}
                  <option value="" disabled>Geen materiaaltypes beschikbaar. Voeg eerst een type toe.</option>
                {% endif %}
              </select>
              {% if not all_material_types %}
                <small class="text-muted">Geen materiaaltypes beschikbaar. <a href="{{ url_for('materiaal.materiaal_types') }}">Voeg eerst een type toe</a>.</small>
              {% endif %}
            </div>

            <div class="col-md-6">
              <label class="form-label">Aankoopdatum*</label>
              <input name="purchase_date" id="edit-purchase_date" type="date" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Laatste keuring (optioneel)</label>
              <input name="laatste_keuring" id="edit-laatste_keuring" type="date" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Werf (optioneel, vrije tekst)</label>
              <input name="site" id="edit-site" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Toegewezen aan (optioneel)</label>
              <input name="assigned_to" id="edit-assigned_to" class="form-control">
            </div>

            <div class="col-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="note" id="edit-note" class="form-control" rows="3"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label">Keuring*</label>
              <select name="status" id="edit-status" class="form-select" required>
                {% for key, status in inspection_statuses.items() %}
                  <option value="{{ status.value }}">{{ status.label }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Keuringstatus (optioneel)</label>
              <input name="inspection_status" id="edit-inspection_status" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Document type (optioneel)</label>
              <select name="document_type" class="form-select">
                <option value="Aankoopfactuur" selected>Aankoopfactuur</option>
                <option value="Verkoopfactuur">Verkoopfactuur</option>
                <option value="Keuringstatus">Keuringstatus</option>
              </select>
              <small class="text-muted">Selecteer het type document dat je uploadt</small>
            </div>

            <div class="col-md-6">
              <label class="form-label">Documentatie (foto of PDF)</label>
              <input
                type="file"
                name="documentation"
                class="form-control"
                accept="image/*,.pdf"
              >
              <small class="text-muted">Upload een document bij het bewerken van het materiaal</small>
            </div>

            <div class="col-md-6">
              <label class="form-label">Veiligheidsfiche (handleiding)</label>
              <input
                type="file"
                name="safety_sheet"
                class="form-control"
                accept="image/*,.pdf"
              >
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Gebruik Materieel -->
<div class="modal fade" id="gebruikMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Materiaal in gebruik nemen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('materiaal.materiaal_gebruiken') }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Naam*</label>
              <input name="name"
                     id="use-name"
                     list="materiaal-namen"
                     class="form-control"
                     placeholder="Kies of typ een naam"
                     required>
              <datalist id="materiaal-namen">
                {# Eerst materialen die NIET in gebruik zijn #}
                {% for m in all_materials %}
                  {% if m.name and m.id not in active_material_ids %}
                    <option value="{{ m.name }}">{{ m.name }}</option>
                  {% endif %}
                {% endfor %}
                {# Dan materialen die WEL in gebruik zijn (onderaan) #}
                {% for m in all_materials %}
                  {% if m.name and m.id in active_material_ids %}
                    <option value="{{ m.name }} (in gebruik)">{{ m.name }}</option>
                  {% endif %}
                {% endfor %}
              </datalist>
            </div>

            <div class="col-md-6">
              <label class="form-label">Gebruikt door</label>
              <input name="assigned_to"
                     id="use-assigned_to"
                     class="form-control"
                     value="{{ current_user.Naam if current_user else '' }}">
            </div>

            <div class="col-md-6">
              <label class="form-label">Werf (project)</label>
              <select name="project_id" class="form-select">
                <option value="">Geen specifieke werf</option>
                {% for p in projects %}
                  {% set is_future = p.start_date and p.start_date > today %}
                  <option value="{{ p.id }}">
                    {{ p.name or 'Werf ' ~ p.id }}
                    {% if is_future and p.start_date %}
                      (start {{ p.start_date.strftime('%Y-%m-%d') }})
                    {% endif %}
                  </option>
                {% endfor %}
              </select>
              <small class="text-muted">De gekozen werf wordt gelinkt aan dit gebruik.</small>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button class="btn btn-primary" type="submit">Materieel gebruiken</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Store modal instance and fetch controller globally
  let materialDetailsModalInstance = null;
  let currentFetchController = null;

  // Helper function to escape HTML
  function escapeHtml(text) {
    if (!text) return '';
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, m => map[m]);
  }

  // Central function to open material detail modal - can be called from table or search
  window.openMaterialDetailFromTable = function(serial, options = {}) {
    if (!serial) {
      console.error('No serial provided to openMaterialDetailFromTable');
      return;
    }
    openMaterialDetailModal(serial, { ...options, from: 'table' });
  };

  // Central function to open material detail modal from search
  window.openMaterialDetailFromSearch = function(serial, options = {}) {
    if (!serial) {
      console.error('No serial provided to openMaterialDetailFromSearch');
      return;
    }
    openMaterialDetailModal(serial, { ...options, from: 'search' });
  };

  // Central modal function that handles both table and search
  function openMaterialDetailModal(serial, options = {}) {
    const from = options.from || 'table';
    const showUseButton = from === 'search'; // Only show "Materiaal in gebruik nemen" when from search
    
    // Use the search results modal for consistency (same as dashboard)
    const modalElement = document.getElementById('searchResultsModal');
    if (!modalElement) {
      console.error('Search results modal not found');
      return;
    }
    
    const modalBody = document.getElementById('searchModalBody');
    const modalTitle = document.getElementById('searchModalTitle');
    
    if (!modalBody || !modalTitle) {
      console.error('Modal elements not found');
      return;
    }
    
    // Initialize modal
    let searchModal = null;
    if (typeof bootstrap !== 'undefined') {
      searchModal = bootstrap.Modal.getOrCreateInstance(modalElement);
    }
    
    if (!searchModal) {
      console.error('Modal not available');
      return;
    }
    
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Laden...</span></div></div>';
    modalTitle.textContent = 'Materieel Details';
    searchModal.show();
    
    // Fetch material data
    fetch(`/api/search?q=${encodeURIComponent(serial)}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        if (data.items && data.items.length > 0) {
          const item = data.items[0];
          // Status: "in gebruik" or "niet in gebruik" - based on is_in_use from API
          const isInUse = item.is_in_use === true;
          const statusClass = isInUse ? 'bg-success' : 'bg-danger';
          const statusText = isInUse ? 'In gebruik' : 'Niet in gebruik';
          
          // Keuring: altijd gebaseerd op inspection_status (keuring_status in database)
          let keuringStatus = (item.inspection_status || '').toString().trim();
          
          // Normalize keuring status values
          if (keuringStatus) {
            keuringStatus = keuringStatus.toLowerCase();
          } else {
            keuringStatus = '';
          }
          
          // Determine badge text based on keuring status
          let keuringText = '';
          
          if (keuringStatus === 'goedgekeurd') {
            keuringText = 'Goedgekeurd';
          } else if (keuringStatus === 'afgekeurd') {
            keuringText = 'Afgekeurd';
          } else if (keuringStatus === 'keuring verlopen') {
            keuringText = 'Keuring verlopen';
          } else if (keuringStatus === 'keuring gepland') {
            keuringText = 'Keuring gepland';
          } else if (keuringStatus === 'onder voorbehoud') {
            keuringText = 'Onder voorbehoud';
          } else if (keuringStatus) {
            // If there's a value but not recognized, use it as-is (capitalize first letter)
            keuringText = keuringStatus.charAt(0).toUpperCase() + keuringStatus.slice(1);
          } else {
            keuringText = 'Niet van toepassing';
          }
          
          // Create badge HTML for keuring status using CSS classes
          let keuringBadgeHtml = '';
          let badgeClass = '';
          
          if (keuringStatus === 'goedgekeurd') {
            badgeClass = 'badge-keuring-goedgekeurd';
          } else if (keuringStatus === 'afgekeurd') {
            badgeClass = 'badge-keuring-afgekeurd';
          } else if (keuringStatus === 'keuring verlopen') {
            badgeClass = 'badge-keuring-verlopen';
          } else if (keuringStatus === 'keuring gepland') {
            badgeClass = 'badge-keuring-gepland';
          } else if (keuringStatus === 'onder voorbehoud') {
            badgeClass = 'badge-keuring-onder-voorbehoud';
          } else {
            // Geen keuring - grijs
            badgeClass = 'badge-keuring-none';
          }
          
          // Always show badge, even if status is empty
          if (item.keuring_gepland) {
            keuringBadgeHtml = `<span class="badge ${badgeClass}">Keuring gepland: ${escapeHtml(item.keuring_gepland)}</span>`;
          } else {
            keuringBadgeHtml = `<span class="badge ${badgeClass}">${escapeHtml(keuringText)}</span>`;
          }
          
          // Helper function to display value or "onbekend"
          const displayValue = (value) => value && value.trim() !== '' ? escapeHtml(value) : 'onbekend';
          
          modalTitle.textContent = escapeHtml(item.name || 'Onbekend');
          
          // Build buttons HTML - conditionally show "Materiaal in gebruik nemen"
          let buttonsHtml = `
            <button type="button" 
                    class="btn btn-outline-secondary edit-material-btn" 
                    data-item-serial="${escapeHtml(item.serial || '')}"
                    data-edit-serial="${escapeHtml(item.serial || '')}">
              Bewerken
            </button>`;
          
          if (showUseButton) {
            buttonsHtml += `
              <button type="button" 
                      class="btn btn-dark gebruik-btn" 
                      data-bs-toggle="modal" 
                      data-bs-target="#gebruikMaterieelModal"
                      data-item-name="${escapeHtml(item.name || '')}"
                      data-item-nummer="${escapeHtml(item.nummer_op_materieel || '')}">
                Materiaal in gebruik nemen
              </button>`;
          }
          
          modalBody.innerHTML = `
            <div class="material-detail">
              <div class="mb-3">
                <strong>Serienummer:</strong> ${displayValue(item.serial)}
              </div>
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <strong>Type:</strong><br>
                  ${displayValue(item.type)}
                </div>
                <div class="col-md-6">
                  <strong>Status:</strong><br>
                  <span class="badge ${statusClass}">${escapeHtml(statusText)}</span>
                </div>
                <div class="col-md-6">
                  <strong>Keuring:</strong><br>
                  ${keuringBadgeHtml}
                  ${item.laatste_keuring ? `
                    <br><small class="text-muted">Laatste keuring: ${escapeHtml(item.laatste_keuring)}</small>
                  ` : ''}
                </div>
                ${item.laatste_keuring_material ? `
                <div class="col-md-6">
                  <strong>Laatste keuring:</strong><br>
                  <span>${escapeHtml(item.laatste_keuring_material)}</span>
                </div>
                ` : ''}
                ${item.inspection_validity_days ? `
                <div class="col-md-6">
                  <strong>Keuring geldig (dagen):</strong><br>
                  <span>${escapeHtml(item.inspection_validity_days)} dagen</span>
                </div>
                ` : ''}
                <div class="col-md-6">
                  <strong>Toegewezen aan:</strong><br>
                  ${displayValue(item.assigned_to)}
                </div>
                <div class="col-md-6">
                  <strong>Werf:</strong><br>
                  ${displayValue(item.site)}
                </div>
                <div class="col-md-6">
                  <strong>Aankoopdatum:</strong><br>
                  ${displayValue(item.purchase_date)}
                </div>
                <div class="col-md-6">
                  <strong>Nummer op Materieel:</strong><br>
                  ${displayValue(item.nummer_op_materieel)}
                </div>
              </div>
              <div class="mb-3">
                <strong>Opmerking:</strong><br>
                ${displayValue(item.note)}
              </div>
              ${item.documents && item.documents.length > 0 ? `
                <div class="mb-3">
                  <strong>Documenten:</strong><br>
                  <ul class="list-unstyled mt-2">
                    ${item.documents.map(doc => `
                      <li class="mb-2">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        <strong>${escapeHtml(doc.document_type || 'Document')}:</strong> ${escapeHtml(doc.file_name || 'Onbekend bestand')}
                        ${doc.file_url ? `
                          <a href="${escapeHtml(doc.file_url)}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                            <i class="bi bi-eye me-1"></i>Bekijken
                          </a>
                          <a href="${escapeHtml(doc.file_url)}" download="${escapeHtml(doc.file_name || 'document')}" class="btn btn-sm btn-outline-secondary ms-1">
                            <i class="bi bi-download me-1"></i>Download
                          </a>
                        ` : ''}
                      </li>
                    `).join('')}
                  </ul>
                </div>
              ` : ''}
              ${item.documentation_path ? `
                <div class="mb-3">
                  <strong>Documentatie:</strong><br>
                  <a href="${escapeHtml(item.documentation_url || (item.documentation_path ? '/static/' + item.documentation_path : ''))}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                    <i class="bi bi-file-earmark-text me-1"></i>Bekijk documentatie
                  </a>
                  <a href="${escapeHtml(item.documentation_url || (item.documentation_path ? '/static/' + item.documentation_path : ''))}" download class="btn btn-sm btn-outline-secondary me-2">
                    <i class="bi bi-download me-1"></i>Download
                  </a>
                </div>
              ` : ''}
              ${item.safety_sheet_path ? `
                <div class="mb-3">
                  <strong>Veiligheidsfiche:</strong><br>
                  <a href="${escapeHtml(item.safety_sheet_url || (item.safety_sheet_path ? '/static/' + item.safety_sheet_path : ''))}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                    <i class="bi bi-file-earmark-text me-1"></i>Bekijk veiligheidsfiche
                  </a>
                  <a href="${escapeHtml(item.safety_sheet_url || (item.safety_sheet_path ? '/static/' + item.safety_sheet_path : ''))}" download class="btn btn-sm btn-outline-secondary me-2">
                    <i class="bi bi-download me-1"></i>Download
                  </a>
                </div>
              ` : ''}
              <div class="d-flex gap-2 mt-4">
                ${buttonsHtml}
              </div>
            </div>
          `;
          
          // Set up event listeners for dynamically added buttons
          const editBtnInModal = modalBody.querySelector('.edit-material-btn');
          if (editBtnInModal) {
            editBtnInModal.addEventListener('click', function() {
              const serial = this.getAttribute('data-edit-serial');
              if (serial) {
                // Close search modal and open edit modal
                const searchModalElement = document.getElementById('searchResultsModal');
                const searchModal = searchModalElement ? bootstrap.Modal.getInstance(searchModalElement) : null;
                if (searchModal) searchModal.hide();
                
                // Fetch material data and populate edit modal
                fetch(`/api/search?q=${encodeURIComponent(serial)}`)
                  .then(response => response.json())
                  .then(data => {
                    if (data.items && data.items.length > 0) {
                      const item = data.items[0];
                      const editModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('editMaterieelModal'));
                      document.getElementById('edit-original-serial').value = item.serial || '';
                      document.getElementById('edit-serial').value = item.serial || '';
                      document.getElementById('edit-name').value = item.name || '';
                      document.getElementById('edit-type').value = item.type || '';
                      document.getElementById('edit-purchase_date').value = item.purchase_date || '';
                      document.getElementById('edit-assigned_to').value = item.assigned_to || '';
                      document.getElementById('edit-site').value = item.site || '';
                      document.getElementById('edit-note').value = item.note || '';
                      let keuringValue = item.inspection_status || 'goedgekeurd';
                      document.getElementById('edit-status').value = keuringValue;
                      document.getElementById('edit-inspection_status').value = item.inspection_status || '';
                      document.getElementById('edit-nummer_op_materieel').value = item.nummer_op_materieel || '';
                      editModal.show();
                    }
                  })
                  .catch(err => console.error('Error loading material for edit:', err));
              }
            });
          }
        } else {
          modalBody.innerHTML = '<div class="text-muted text-center py-4">Geen resultaten gevonden.</div>';
        }
      })
      .catch(error => {
        console.error('Search error:', error);
        const errorMessage = error.message || 'Er is een fout opgetreden bij het laden van de details.';
        modalBody.innerHTML = `<div class="alert alert-danger">
          <strong>Fout:</strong> ${escapeHtml(errorMessage)}
          <br><small>Controleer de console voor meer details.</small>
        </div>`;
      });
  }

  // Make showMaterialDetails available globally immediately - simplified version
  window.showMaterialDetails = function(serial, usageId) {
    console.log('[showMaterialDetails] Function called', serial, usageId);
    if (!serial) {
      console.error('No serial provided to showMaterialDetails');
      return;
    }
    
    const modalBody = document.getElementById('materieelDetailsBody');
    const modalTitle = document.getElementById('details-material-name');
    const editBtn = document.getElementById('details-edit-btn');
    
    console.log('[showMaterialDetails] Modal elements check', modalBody, modalTitle, editBtn);
    
    if (!modalBody || !modalTitle) {
      console.error('[showMaterialDetails] Modal elements not found', modalBody, modalTitle);
      alert('Fout: Modal elementen niet gevonden. Herlaad de pagina.');
      return;
    }
    
    // Check if Bootstrap is available
    if (typeof bootstrap === 'undefined') {
      console.error('[showMaterialDetails] Bootstrap is not loaded');
      alert('Fout: Bootstrap niet geladen. Herlaad de pagina.');
      return;
    }
    
    // Cancel any previous fetch request
    if (currentFetchController) {
      currentFetchController.abort();
    }
    
    // Create new AbortController for this request
    currentFetchController = new AbortController();
    
    // Initially hide stop button, will be shown based on status from API
    const stopForm = document.getElementById('stop-gebruik-form');
    if (stopForm) stopForm.classList.add('hidden-important');
    
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Laden...</span></div></div>';
    modalTitle.textContent = 'Materieel Details';
    
    // Initialize modal if not already initialized
    if (!materialDetailsModalInstance) {
      const modalElement = document.getElementById('materieelDetailsModal');
      if (modalElement) {
        materialDetailsModalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
        
        // Cleanup when modal is hidden
        modalElement.addEventListener('hidden.bs.modal', function() {
          // Cancel any ongoing fetch requests
          if (currentFetchController) {
            currentFetchController.abort();
            currentFetchController = null;
          }
          // Clear modal body
          const modalBody = document.getElementById('materieelDetailsBody');
          if (modalBody) {
            modalBody.innerHTML = '';
          }
          // Reset edit button onclick
          const editBtn = document.getElementById('details-edit-btn');
          if (editBtn) {
            editBtn.onclick = null;
          }
        });
      } else {
        console.error('Modal element not found');
        return;
      }
    }
    
    // Show the modal
    materialDetailsModalInstance.show();
    
    // Fetch the data
    fetch(`/api/search?q=${encodeURIComponent(serial)}`, {
      signal: currentFetchController.signal
    })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        if (data.items && data.items.length > 0) {
          const item = data.items[0];
          // Status: "in gebruik" or "niet in gebruik" - based on is_in_use from API
          const isInUse = item.is_in_use === true;
          const statusClass = isInUse ? 'bg-success' : 'bg-danger';
          const statusText = isInUse ? 'In gebruik' : 'Niet in gebruik';
          
          const displayValue = (value) => value && value.trim() !== '' ? escapeHtml(value) : 'onbekend';
          
          modalTitle.textContent = escapeHtml(item.name || 'Onbekend');
          
          // Format keuring for display with badge
          // Keuring: altijd gebaseerd op inspection_status (keuring_status in database)
          let keuringStatus = (item.inspection_status || item.status || '').toString();
          
          // Normalize keuring status values
          if (keuringStatus) {
            keuringStatus = keuringStatus.trim().toLowerCase();
          } else {
            keuringStatus = '';
          }
          
          let keuringText = '';
          
          if (keuringStatus === 'goedgekeurd') {
            keuringText = 'Goedgekeurd';
          } else if (keuringStatus === 'afgekeurd') {
            keuringText = 'Afgekeurd';
          } else if (keuringStatus === 'keuring verlopen') {
            keuringText = 'Keuring verlopen';
          } else if (keuringStatus === 'keuring gepland') {
            keuringText = 'Keuring gepland';
          } else if (keuringStatus === 'onder voorbehoud') {
            keuringText = 'Onder voorbehoud';
          } else if (keuringStatus) {
            // If there's a value but not recognized, use it as-is (capitalize first letter)
            keuringText = keuringStatus.charAt(0).toUpperCase() + keuringStatus.slice(1);
          } else {
            keuringText = 'Niet van toepassing';
          }
          
          // Create badge HTML for keuring status using CSS classes
          let keuringBadgeHtml = '';
          let badgeClass = '';
          
          if (keuringStatus === 'goedgekeurd') {
            badgeClass = 'badge-keuring-goedgekeurd';
          } else if (keuringStatus === 'afgekeurd') {
            badgeClass = 'badge-keuring-afgekeurd';
          } else if (keuringStatus === 'keuring verlopen') {
            badgeClass = 'badge-keuring-verlopen';
          } else if (keuringStatus === 'keuring gepland') {
            badgeClass = 'badge-keuring-gepland';
          } else if (keuringStatus === 'onder voorbehoud') {
            badgeClass = 'badge-keuring-onder-voorbehoud';
          } else {
            // Geen keuring - grijs
            badgeClass = 'badge-keuring-none';
          }
          
          // Always show badge, even if status is empty
          if (item.keuring_gepland) {
            keuringBadgeHtml = `<span class="badge ${badgeClass}">Keuring gepland: ${escapeHtml(item.keuring_gepland)}</span>`;
          } else {
            keuringBadgeHtml = `<span class="badge ${badgeClass}">${escapeHtml(keuringText)}</span>`;
          }
          
          modalBody.innerHTML = `
            <div class="material-detail">
              <div class="row g-4">
                <!-- Left Column -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <strong>Serienummer:</strong><br>
                    <span>${displayValue(item.serial)}</span>
                  </div>
                  <div class="mb-3">
                    <strong>Type:</strong><br>
                    <span>${displayValue(item.type)}</span>
                  </div>
                  <div class="mb-3">
                    <strong>Keuring:</strong><br>
                    ${keuringBadgeHtml}
                  </div>
                  ${item.laatste_keuring_material ? `
                  <div class="mb-3">
                    <strong>Laatste keuring:</strong><br>
                    <span>${escapeHtml(item.laatste_keuring_material)}</span>
                  </div>
                  ` : ''}
                  ${item.inspection_validity_days ? `
                  <div class="mb-3">
                    <strong>Keuring geldig (dagen):</strong><br>
                    <span>${escapeHtml(item.inspection_validity_days)} dagen</span>
                  </div>
                  ` : ''}
                  <div class="mb-3">
                    <strong>Werf:</strong><br>
                    <span>${displayValue(item.site)}</span>
                  </div>
                  <div class="mb-3">
                    <strong>Nummer op Materieel:</strong><br>
                    <span>${displayValue(item.nummer_op_materieel)}</span>
                  </div>
                  <div class="mb-3">
                    <strong>Opmerking:</strong><br>
                    <span>${displayValue(item.note)}</span>
                  </div>
                </div>
                
                <!-- Right Column -->
                <div class="col-md-6">
                  <div class="mb-3">
                    <strong>Status:</strong><br>
                    <span class="badge ${statusClass}">${escapeHtml(statusText)}</span>
                  </div>
                  <div class="mb-3">
                    <strong>Toegewezen aan:</strong><br>
                    <span>${displayValue(item.assigned_to)}</span>
                  </div>
                  <div class="mb-3">
                    <strong>Aankoopdatum:</strong><br>
                    <span>${displayValue(item.purchase_date)}</span>
                  </div>
                </div>
              </div>
              
              ${item.documents && item.documents.length > 0 ? `
                <div class="mb-3 mt-3">
                  <strong>Documenten:</strong><br>
                  <ul class="list-unstyled mt-2">
                    ${item.documents.map(doc => `
                      <li class="mb-2">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        <strong>${escapeHtml(doc.document_type || 'Document')}:</strong> ${escapeHtml(doc.file_name || 'Onbekend bestand')}
                        ${doc.file_url ? `
                          <a href="${escapeHtml(doc.file_url)}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                            <i class="bi bi-eye me-1"></i>Bekijken
                          </a>
                          <a href="${escapeHtml(doc.file_url)}" download="${escapeHtml(doc.file_name || 'document')}" class="btn btn-sm btn-outline-secondary ms-1">
                            <i class="bi bi-download me-1"></i>Download
                          </a>
                        ` : ''}
                      </li>
                    `).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          `;
          
          // Show/hide stop button based on status
          const stopForm = document.getElementById('stop-gebruik-form');
          const stopBtn = document.getElementById('details-stop-btn');
          
          // Always hide first, then show if in use
          if (stopForm) {
            stopForm.classList.add('hidden-important');
          }
          if (stopBtn) {
            stopBtn.classList.add('hidden-important');
          }
          
          if (isInUse) {
            // Material is in use - show "Niet meer gebruiken" button
            if (stopForm) {
              stopForm.classList.remove('hidden-important');
              stopForm.classList.add('show-inline-block');
            }
            // Set usage_id if available (from usageId parameter or try to find it)
            const usageIdToUse = usageId || (isInUse ? findUsageIdForMaterial(item.serial) : null);
            if (usageIdToUse && document.getElementById('stop-usage-id')) {
              document.getElementById('stop-usage-id').value = usageIdToUse;
            }
          }
          
          // Helper function to find usage ID for material in use
          function findUsageIdForMaterial(serial) {
            // Try to find usageId from the row that was clicked
            const materialRows = document.querySelectorAll('.material-row');
            for (let row of materialRows) {
              if (row.getAttribute('data-serial') === serial) {
                const rowUsageId = row.getAttribute('data-usage-id');
                if (rowUsageId) return rowUsageId;
              }
            }
            return null;
          }
          
          // Show/hide documentation button
          const docBtn = document.getElementById('details-documentation-btn');
          if (docBtn) {
            if (item.documentation_path || item.documentation_url) {
              const docUrl = item.documentation_url || (item.documentation_path ? '/static/' + item.documentation_path : '');
              docBtn.href = docUrl;
              docBtn.classList.remove('d-none');
            } else {
              docBtn.classList.add('d-none');
            }
          }
          
          // Set up edit button - populate edit modal with data from API
          if (editBtn) {
            editBtn.onclick = function() {
              if (materialDetailsModalInstance) {
                materialDetailsModalInstance.hide();
              }
              // Populate edit modal with the material data
              const editModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('editMaterieelModal'));
              document.getElementById('edit-original-serial').value = item.serial || '';
              document.getElementById('edit-serial').value = item.serial || '';
              document.getElementById('edit-name').value = item.name || '';
              document.getElementById('edit-type').value = item.type || '';
              document.getElementById('edit-purchase_date').value = item.purchase_date || '';
              document.getElementById('edit-laatste_keuring').value = item.laatste_keuring_raw || item.laatste_keuring_material || '';
              document.getElementById('edit-assigned_to').value = item.assigned_to || '';
              document.getElementById('edit-site').value = item.site || '';
              document.getElementById('edit-note').value = item.note || '';
              
              // Use inspection_status directly for keuring status
              // inspection_status is the actual keuring status, not the usage status
              let keuringValue = item.inspection_status || 'goedgekeurd';
              document.getElementById('edit-status').value = keuringValue;
              
              document.getElementById('edit-inspection_status').value = item.inspection_status || '';
              document.getElementById('edit-nummer_op_materieel').value = item.nummer_op_materieel || '';
              editModal.show();
            };
          }
        } else {
          modalBody.innerHTML = '<div class="alert alert-warning">Item niet gevonden.</div>';
        }
      })
      .catch(error => {
        if (error.name !== 'AbortError') {
          console.error('Error loading material detail:', error);
          const modalBodyEl = document.getElementById('materieelDetailsBody');
          if (modalBodyEl) {
            modalBodyEl.innerHTML = '<div class="alert alert-danger">Er is een fout opgetreden bij het laden van de details.</div>';
          }
        }
      });
  };

  // Table rows now use onclick directly, no need for event delegation
  // But keep this for backward compatibility if needed

document.addEventListener('DOMContentLoaded', function () {

  // Event listeners for "Bekijk en bewerk" buttons using event delegation
  // This works even if buttons are dynamically added (e.g., in tabs)
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.view-edit-btn');
    if (btn) {
      e.preventDefault();
      e.stopPropagation();
      const serial = btn.getAttribute('data-serial');
      const usageId = btn.getAttribute('data-usage-id');
      console.log('Button clicked:', serial, usageId, typeof window.showMaterialDetails);
      
      if (!serial) {
        console.error('No serial found on button');
        alert('Fout: Serienummer niet gevonden.');
        return;
      }
      
      if (typeof window.showMaterialDetails === 'function') {
        try {
          window.showMaterialDetails(serial, usageId);
        } catch (error) {
          console.error('Error calling showMaterialDetails:', error);
          alert('Er is een fout opgetreden bij het openen van de details.');
        }
      } else {
        console.error('showMaterialDetails function not available');
        alert('Fout: Functie niet beschikbaar. Herlaad de pagina.');
      }
    }
  });

  // Validate type selection in "Nieuw Materiaal" modal
  const typeSelect = document.getElementById('type');
  const submitBtn = document.getElementById('submitMaterieelBtn');
  
  if (typeSelect && submitBtn) {
    typeSelect.addEventListener('change', function() {
      // Enable/disable submit button based on selection
      if (this.value === '' || this.options[this.selectedIndex].disabled) {
        submitBtn.disabled = true;
      } else {
        submitBtn.disabled = false;
      }
    });
    
    // Initial check on modal open
    const nieuwModal = document.getElementById('nieuwMaterieelModal');
    if (nieuwModal) {
      nieuwModal.addEventListener('show.bs.modal', function() {
        // Reset form and check if submit should be disabled
        nieuwMaterieelForm.reset();
        if (typeSelect && submitBtn) {
          if (typeSelect.value === '' || (typeSelect.options[typeSelect.selectedIndex] && typeSelect.options[typeSelect.selectedIndex].disabled)) {
            submitBtn.disabled = true;
          } else {
            submitBtn.disabled = false;
          }
        }
        // Reset keuring status conditional field visibility
        const keuringStatusSelect = document.getElementById('keuring_status');
        const datumContainer = document.getElementById('datum_geplande_keuring_container');
        const datumInput = document.getElementById('datum_geplande_keuring');
        if (keuringStatusSelect && datumContainer && datumInput) {
          if (keuringStatusSelect.value === 'keuring gepland') {
            datumContainer.style.display = 'block';
            datumInput.required = true;
          } else {
            datumContainer.style.display = 'none';
            datumInput.required = false;
            datumInput.value = '';
          }
        }
      });
    }
  }

  // Handle keuring status change to show/hide "Datum geplande keuring" field
  const keuringStatusSelect = document.getElementById('keuring_status');
  const datumContainer = document.getElementById('datum_geplande_keuring_container');
  const datumInput = document.getElementById('datum_geplande_keuring');
  
  if (keuringStatusSelect && datumContainer && datumInput) {
    keuringStatusSelect.addEventListener('change', function() {
      if (this.value === 'keuring gepland') {
        datumContainer.style.display = 'block';
        datumInput.required = true;
      } else {
        datumContainer.style.display = 'none';
        datumInput.required = false;
        datumInput.value = '';
      }
    });
    
    // Initial check on page load
    if (keuringStatusSelect.value === 'keuring gepland') {
      datumContainer.style.display = 'block';
      datumInput.required = true;
    } else {
      datumContainer.style.display = 'none';
      datumInput.required = false;
    }
  }

  // Bewerken-modal vullen
  const editModal = document.getElementById('editMaterieelModal');
  if (editModal) {
    editModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      // Only populate from button if button exists (when opened from table)
      // If opened programmatically, values are already set
      if (button) {
      const data = {
        serial: button.getAttribute('data-serial') || '',
        name: button.getAttribute('data-name') || '',
        type: button.getAttribute('data-type') || '',
        purchase_date: button.getAttribute('data-purchase_date') || '',
        assigned_to: button.getAttribute('data-assigned_to') || '',
        site: button.getAttribute('data-site') || '',
        note: button.getAttribute('data-note') || '',
        status: button.getAttribute('data-status') || 'goedgekeurd',
        inspection_status: button.getAttribute('data-inspection_status') || '',
        nummer_op_materieel: button.getAttribute('data-nummer_op_materieel') || ''
      };

      document.getElementById('edit-original-serial').value = data.serial;
      document.getElementById('edit-serial').value = data.serial;
      document.getElementById('edit-name').value = data.name;
      // Set the selected type in the dropdown
      const editTypeSelect = document.getElementById('edit-type');
      if (editTypeSelect && data.type) {
        editTypeSelect.value = data.type;
      }
      document.getElementById('edit-purchase_date').value = data.purchase_date;
      document.getElementById('edit-assigned_to').value = data.assigned_to;
      document.getElementById('edit-site').value = data.site;
      document.getElementById('edit-note').value = data.note;
      document.getElementById('edit-status').value = data.status;
      document.getElementById('edit-inspection_status').value = data.inspection_status;
      document.getElementById('edit-nummer_op_materieel').value = data.nummer_op_materieel;
      }
    });
  }

  // Password modal for "Nieuw Materieel Toevoegen"
  // Admin check voor nieuw materieel toevoegen
  // Note: submitBtn is already declared above, so we reuse it
  const nieuwMaterieelForm = document.getElementById('nieuwMaterieelForm');
  const isAdmin = {% if current_user and current_user.is_admin %}true{% else %}false{% endif %};
  const accessDeniedModal = new bootstrap.Modal(document.getElementById('accessDeniedModal'));

  if (nieuwMaterieelForm) {
    nieuwMaterieelForm.addEventListener('submit', function(e) {
      // Check if user is admin
      if (!isAdmin) {
        e.preventDefault();
        console.log('User is not admin, preventing submit');
        // Geen admin: toon melding
        accessDeniedModal.show();
        return false;
      }
      
      // Check if button is disabled (shouldn't happen with type="submit" but check anyway)
      if (submitBtn && submitBtn.disabled) {
        e.preventDefault();
        console.log('Button is disabled, preventing submit');
        const typeSelect = document.getElementById('type');
        if (typeSelect && !typeSelect.value) {
          alert('Selecteer eerst een type materiaal.');
          typeSelect.focus();
        }
        return false;
      }
      
      // Validate conditional "Datum geplande keuring" field
      const keuringStatusSelect = document.getElementById('keuring_status');
      const datumInput = document.getElementById('datum_geplande_keuring');
      if (keuringStatusSelect && datumInput) {
        if (keuringStatusSelect.value === 'keuring gepland' && !datumInput.value) {
          e.preventDefault();
          alert('Datum geplande keuring is verplicht wanneer "Keuring gepland" is geselecteerd.');
          datumInput.focus();
          return false;
        }
      }
      
      // Let native HTML5 validation handle required fields
      // If form is invalid, browser will prevent submit automatically
      console.log('Form submitting...');
      return true;
    });
  }

  // Handle "Materieel verwijderen" modal
  const deleteMaterieelModal = document.getElementById('deleteMaterieelModal');
  if (deleteMaterieelModal) {
    deleteMaterieelModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      if (!button) return;

      const serial = button.getAttribute('data-serial') || '';
      const name = button.getAttribute('data-name') || 'dit materiaal';

      const serialInput = document.getElementById('delete-material-serial');
      const nameSpan = document.getElementById('delete-material-name');

      if (serialInput) serialInput.value = serial;
      if (nameSpan) nameSpan.textContent = name;
    });
  }

  // Initialize modal and add cleanup on hide (only if not already initialized)
  const modalElement = document.getElementById('materieelDetailsModal');
  if (modalElement && !materialDetailsModalInstance) {
    materialDetailsModalInstance = new bootstrap.Modal(modalElement, {
      backdrop: true,
      keyboard: true,
      focus: true
    });
    
    // Cleanup when modal is hidden
    modalElement.addEventListener('hidden.bs.modal', function() {
      // Cancel any ongoing fetch requests
      if (currentFetchController) {
        currentFetchController.abort();
        currentFetchController = null;
      }
      // Clear modal body
      const modalBody = document.getElementById('materieelDetailsBody');
      if (modalBody) {
        modalBody.innerHTML = '';
      }
      // Reset edit button onclick
      const editBtn = document.getElementById('details-edit-btn');
      if (editBtn) {
        editBtn.onclick = null;
      }
    });
  }

});

</script>

<!-- Modal: Koppel aan werf -->
<div class="modal fade" id="assignToProjectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('materiaal.materiaal_assign_to_project') }}">
        <div class="modal-header">
          <h5 class="modal-title">Materiaal koppelen aan werf</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="usage_id" id="assign-usage-id">
          <p>
            Koppel <strong id="assign-mat-name"></strong> 
            <span class="text-muted">(<span id="assign-mat-serial"></span>)</span>
            aan een werf:
          </p>
          <div class="mb-3">
            <label class="form-label">Selecteer werf*</label>
            <select name="project_id" class="form-select" required>
              <option value="">-- Kies een werf --</option>
              {% for p in projects %}
                <option value="{{ p.id }}">{{ p.name or ('Werf ' ~ p.id) }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button type="submit" class="btn btn-primary">Koppelen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const assignModal = document.getElementById('assignToProjectModal');
  if (assignModal) {
    assignModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      if (!button) return;

      const usageId = button.getAttribute('data-usage-id');
      const matName = button.getAttribute('data-mat-name') || 'dit materiaal';
      const matSerial = button.getAttribute('data-mat-serial') || '';

      document.getElementById('assign-usage-id').value = usageId;
      document.getElementById('assign-mat-name').textContent = matName;
      document.getElementById('assign-mat-serial').textContent = matSerial;
    });
  }
});
</script>

{% endblock %}
