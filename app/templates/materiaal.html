{% extends "base.html" %}
{% block content %}

<div class="section-header">
  <div>
    <h2 class="h-title">Materieelbeheer</h2>
    <div class="h-sub">Overzicht van beheer van al het bedrijfsmateriaal</div>
  </div>

  <!-- Nieuwe knop rechtsboven -->
  <button class="btn btn-dark"
          data-bs-toggle="modal"
          data-bs-target="#gebruikMaterieelModal">
    Gebruik Materieel
  </button>
</div>

<!-- KPI's -->
<div class="grid grid-top" style="margin-top:16px;">
  <div class="card kpi kpi-with-plus">
    <div class="kpi-title">Totaal materiaal <span class="kpi-dot"></span></div>
    <div class="kpi-value">{{ total_items }}</div>
    <div class="kpi-sub">Items in het systeem</div>

    <!-- Rond plus-icoon rechtsonder -->
    <button
      type="button"
      class="kpi-plus-btn"
      data-bs-toggle="modal"
      data-bs-target="#nieuwMaterieelModal">
      +
    </button>
  </div>

  <div class="card kpi">
    <div class="kpi-title">Momenteel in gebruik <span class="kpi-dot"></span></div>
    <div class="kpi-value">{{ in_use }}</div>
    <div class="kpi-sub">Items in een project</div>
  </div>

  <div class="hero-image d-none d-md-block" aria-hidden="true"></div>
</div>

<!-- Flash messages -->
<div class="container px-0 mt-3">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category=='danger' else category }} mb-2" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<!-- Recente activiteit / Lijst -->
<div class="card panel" style="margin-top:16px;">
  <div class="panel-title d-flex align-items-center justify-content-between">
    <div>
      Recente Activiteit
      <div class="panel-sub">Laatste wijzigingen in het systeem</div>
    </div>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('materiaal') }}">Herstel filters</a>
  </div>

  <!-- Filterbalk -->
  <form class="row g-2 align-items-center" method="get" action="{{ url_for('materiaal') }}">
    <div class="col-12 col-md-6">
      <div class="input-group">
        <span class="input-group-text">üîé</span>
        <input name="q" value="{{ request.args.get('q','') }}" type="text" class="form-control" placeholder="Zoek op naam of serienummer‚Ä¶">
      </div>
    </div>

    <div class="col-6 col-md-3">
      <select name="category" class="form-select">
        <option value="">Alle categorie√´n</option>
        {% for c in ["klein materieel","middel groot materieel","groot materieel"] %}
          <option value="{{ c }}" {% if request.args.get('category')==c %}selected{% endif %}>{{ c|title }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-3">
      <select name="status" class="form-select">
        <option value="">Alle statussen</option>
        {% for s in ["goedgekeurd","afgekeurd"] %}
          <option value="{{ s }}" {% if request.args.get('status')==s %}selected{% endif %}>{{ s|title }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12">
      <button class="btn btn-primary">Filteren</button>
    </div>
  </form>

  <!-- Tabel -->
  <div class="table-responsive mt-3">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Serienummer</th>
          <th>Naam</th>
          <th>Categorie</th>
          <th>Status</th>
          <th>Keuring</th>
          <th class="text-end">Acties</th>
        </tr>
      </thead>
      <tbody>
        {% if items %}
          {% for it in items %}
          <tr>
            <td>{{ it.serial }}</td>
            <td>{{ it.name }}</td>
            <td>{{ it.category|title if it.category else '' }}</td>
            <td>
              <span class="badge {% if it.status=='goedgekeurd' %}bg-success{% else %}bg-danger{% endif %}">
                {{ it.status|title if it.status else '' }}
              </span>
            </td>
            <td>{{ it.inspection_status or "-" }}</td>
            <td class="text-end">
              <div class="btn-group">
                <button
                  class="btn btn-sm btn-outline-secondary"
                  data-bs-toggle="modal"
                  data-bs-target="#editMaterieelModal"
                  data-serial="{{ it.serial }}"
                  data-name="{{ it.name }}"
                  data-category="{{ it.category }}"
                  data-type="{{ it.type }}"
                  data-purchase_date="{{ it.purchase_date }}"
                  data-assigned_to="{{ it.assigned_to }}"
                  data-site="{{ it.site }}"
                  data-note="{{ it.note }}"
                  data-status="{{ it.status }}"
                  data-inspection_status="{{ it.inspection_status }}"
                  data-nummer_op_materieel="{{ it.nummer_op_materieel }}"
                >
                  Bewerken
                </button>
                <form method="post" action="{{ url_for('materiaal_verwijderen') }}" onsubmit="return confirm('Verwijderen?');">
                  <input type="hidden" name="serial" value="{{ it.serial }}">
                  <button class="btn btn-sm btn-outline-danger">Verwijderen</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6" class="text-muted">Nog geen materiaal gevonden‚Ä¶</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal: Nieuw Materieel -->
<div class="modal fade" id="nieuwMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nieuw Materiaal Toevoegen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('materiaal_toevoegen') }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Naam*</label>
              <input name="name" required class="form-control" placeholder="Bv. Boormachine Bosch">
            </div>
            <div class="col-md-6">
              <label class="form-label">Serienummer*</label>
              <input name="serial" required class="form-control" placeholder="Bv. BH-2024-001">
            </div>

            <div class="col-md-6">
              <label class="form-label">Nummer op Materieel (optioneel)</label>
              <input name="nummer_op_materieel" class="form-control" placeholder="Sticker / nummer op toestel">
            </div>

            <div class="col-md-6">
              <label class="form-label">Categorie*</label>
              <select name="category" class="form-select" required>
                <option value="" disabled selected>Selecteer categorie</option>
                <option>klein materieel</option>
                <option>middel groot materieel</option>
                <option>groot materieel</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Type*</label>
              <input name="type" required class="form-control" placeholder="Bv. Elektrisch gereedschap">
            </div>

            <div class="col-md-6">
              <label class="form-label">Aankoopdatum*</label>
              <input name="purchase_date" type="date" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Werf (optioneel)</label>
              <input name="site" class="form-control" placeholder="Bv. Project Turnhout">
            </div>

            <div class="col-md-6">
              <label class="form-label">Toegewezen aan (optioneel)</label>
              <input name="assigned_to" class="form-control" placeholder="Naam gebruiker">
            </div>

            <div class="col-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="note" class="form-control" rows="3" placeholder="Extra info over het materiaal‚Ä¶"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label">Status*</label>
              <select name="status" class="form-select" required>
                <option value="goedgekeurd">Goedgekeurd</option>
                <option value="afgekeurd">Afgekeurd</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Keuringstatus (optioneel)</label>
              <input name="inspection_status" class="form-control" placeholder="Bv. Keuring 2025-05">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Materieel Toevoegen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Gebruik Materieel -->
<div class="modal fade" id="gebruikMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Materiaal in gebruik nemen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('materiaal_gebruiken') }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Naam*</label>
              <input name="name"
                     id="use-name"
                     list="materiaal-namen"
                     required
                     class="form-control"
                     placeholder="Kies of typ een naam">
              <datalist id="materiaal-namen">
                {% for m in all_materials %}
                  {% if m.name %}
                    <option value="{{ m.name }}">
                  {% endif %}
                {% endfor %}
              </datalist>
            </div>

            <div class="col-md-6">
              <label class="form-label">Nummer op Materieel</label>
              <input name="nummer_op_materieel"
                     id="use-nummer"
                     class="form-control"
                     placeholder="Sticker / nummer op toestel">
            </div>

            <div class="col-md-6">
              <label class="form-label">Categorie</label>
              <input id="use-category" class="form-control" readonly>
            </div>

            <div class="col-md-6">
              <label class="form-label">Gebruikt door</label>
              <input name="assigned_to"
                     id="use-assigned_to"
                     class="form-control"
                     value="{{ current_user.Naam if current_user else '' }}">
            </div>

            <div class="col-md-6">
              <label class="form-label">Werf</label>
              <input name="site" id="use-site" class="form-control" placeholder="Bv. Werf Antwerpen">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Materieel gebruiken</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Bewerken -->
<div class="modal fade" id="editMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Materieel Bewerken</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('materiaal_bewerken') }}">
        <div class="modal-body">
          <input type="hidden" name="original_serial" id="edit-original-serial">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Naam*</label>
              <input name="name" id="edit-name" required class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Serienummer*</label>
              <input name="serial" id="edit-serial" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Nummer op Materieel (optioneel)</label>
              <input name="nummer_op_materieel" id="edit-nummer_op_materieel" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Categorie*</label>
              <select name="category" id="edit-category" class="form-select" required>
                <option>klein materieel</option>
                <option>middel groot materieel</option>
                <option>groot materieel</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Type*</label>
              <input name="type" id="edit-type" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Aankoopdatum*</label>
              <input name="purchase_date" id="edit-purchase_date" type="date" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Werf (optioneel)</label>
              <input name="site" id="edit-site" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Toegewezen aan (optioneel)</label>
              <input name="assigned_to" id="edit-assigned_to" class="form-control">
            </div>

            <div class="col-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="note" id="edit-note" class="form-control" rows="3"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label">Status*</label>
              <select name="status" id="edit-status" class="form-select" required>
                <option value="goedgekeurd">Goedgekeurd</option>
                <option value="afgekeurd">Afgekeurd</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Keuringstatus (optioneel)</label>
              <input name="inspection_status" id="edit-inspection_status" class="form-control">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
/* laat de modal rechtsboven ‚Äúinschuiven‚Äù */
.modal-dialog-end { margin-right: 0; margin-left: auto; }

/* KPI plus-knop rechtsonder */
.kpi-with-plus {
  position: relative;
}
.kpi-plus-btn {
  position: absolute;
  right: 16px;
  bottom: 16px;

  width: 48px;
  height: 48px;

  border-radius: 50%;
  border: none;

  background: #000;
  color: #fff;

  font-size: 32px;
  font-weight: bold;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
  line-height: 1;
}
.kpi-plus-btn:hover {
  opacity: 0.85;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Bewerken-modal vullen
  const editModal = document.getElementById('editMaterieelModal');
  if (editModal) {
    editModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      if (!button) return;

      const data = {
        serial: button.getAttribute('data-serial') || '',
        name: button.getAttribute('data-name') || '',
        category: button.getAttribute('data-category') || '',
        type: button.getAttribute('data-type') || '',
        purchase_date: button.getAttribute('data-purchase_date') || '',
        assigned_to: button.getAttribute('data-assigned_to') || '',
        site: button.getAttribute('data-site') || '',
        note: button.getAttribute('data-note') || '',
        status: button.getAttribute('data-status') || 'goedgekeurd',
        inspection_status: button.getAttribute('data-inspection_status') || '',
        nummer_op_materieel: button.getAttribute('data-nummer_op_materieel') || ''
      };

      document.getElementById('edit-original-serial').value = data.serial;
      document.getElementById('edit-serial').value = data.serial;
      document.getElementById('edit-name').value = data.name;
      document.getElementById('edit-category').value = data.category;
      document.getElementById('edit-type').value = data.type;
      document.getElementById('edit-purchase_date').value = data.purchase_date;
      document.getElementById('edit-assigned_to').value = data.assigned_to;
      document.getElementById('edit-site').value = data.site;
      document.getElementById('edit-note').value = data.note;
      document.getElementById('edit-status').value = data.status;
      document.getElementById('edit-inspection_status').value = data.inspection_status;
      document.getElementById('edit-nummer_op_materieel').value = data.nummer_op_materieel;
    });
  }

  // Data voor Gebruik Materieel
  const materiaalData = [
    {% for m in all_materials %}
      {
        name: "{{ m.name|e if m.name }}",
        nummer: "{{ (m.nummer_op_materieel or '')|e }}",
        category: "{{ (m.category or '')|e }}"
      }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  function updateUseCategory() {
    const nameInput = document.getElementById('use-name');
    const numInput = document.getElementById('use-nummer');
    const catInput = document.getElementById('use-category');

    const name = (nameInput?.value || '').trim();
    const nummer = (numInput?.value || '').trim();

    let found = null;
    if (nummer) {
      found = materiaalData.find(m => m.nummer === nummer);
    }
    if (!found && name) {
      found = materiaalData.find(m => m.name === name);
    }

    if (catInput) {
      catInput.value = found ? (found.category || '') : '';
    }
  }

  const useName = document.getElementById('use-name');
  const useNummer = document.getElementById('use-nummer');
  if (useName) useName.addEventListener('input', updateUseCategory);
  if (useNummer) useNummer.addEventListener('input', updateUseCategory);
});
</script>

{% endblock %}
