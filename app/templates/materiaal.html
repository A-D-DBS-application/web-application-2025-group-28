{% extends "base.html" %}
{% block content %}

<div class="section-header" style="display:flex;justify-content:space-between;align-items:flex-start;">
  <div>
    <h2 class="h-title">Materieelbeheer</h2>
    <div class="h-sub">Overzicht van beheer van al het bedrijfsmateriaal</div>
  </div>

  <!-- Knop "in gebruik nemen" rechts naast de paginatitel (zoals bij werven) -->
  <button class="btn btn-dark"
          data-bs-toggle="modal"
          data-bs-target="#gebruikMaterieelModal"
          style="display:inline-flex;align-items:center;gap:8px;">
    <span style="font-size:18px;line-height:1;">+</span>
    <span>Gebruik materiaal</span>
  </button>
</div>

<!-- KPI's in √©√©n grid -->
<div class="grid materiaal-grid" style="margin-top:16px;">
  <!-- KPI totaal -->
  <div class="card kpi kpi-with-plus">
    <div class="kpi-title">Totaal materiaal <span class="kpi-dot"></span></div>
    <div class="kpi-value">{{ total_items }}</div>
    <div class="kpi-sub">Items in het systeem</div>

    <!-- Rond plus-icoon rechtsonder -->
    <button
      type="button"
      class="kpi-plus-btn"
      data-bs-toggle="modal"
      data-bs-target="#nieuwMaterieelModal">
      +
    </button>
  </div>

  <!-- KPI in gebruik -->
  <div class="card kpi">
    <div class="kpi-title">Momenteel in gebruik <span class="kpi-dot"></span></div>
    <div class="kpi-value">{{ in_use }}</div>
    <div class="kpi-sub">Items in een project</div>
  </div>
</div>

<!-- BLOK: Materieel in gebruik ‚Äì zelfde breedte als "Materiaal in het systeem" -->
<div class="card panel usage-panel" style="margin-top:16px;">
    <div class="panel-title">Materieel in gebruik</div>
    <div class="panel-sub">Overzicht van gebruikte items</div>

    <ul class="nav nav-tabs mt-3" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="my-usage-tab" data-bs-toggle="tab"
                data-bs-target="#my-usage" type="button" role="tab">
          Door mij in gebruik ({{ my_usages|length }})
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="others-usage-tab" data-bs-toggle="tab"
                data-bs-target="#others-usage" type="button" role="tab">
          Door anderen in gebruik ({{ other_usages|length }})
        </button>
      </li>
    </ul>

    <div class="tab-content mt-3">
      <!-- TAB: door mij -->
      <div class="tab-pane fade show active" id="my-usage" role="tabpanel" aria-labelledby="my-usage-tab">
        {% if my_usages %}
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr>
                  <th>Serienummer</th>
                  <th>Naam</th>
                  <th>Werf</th>
                  <th>In gebruik sinds</th>
                  <th class="text-end">Acties</th>
                </tr>
              </thead>
              <tbody>
                {% for u in my_usages %}
                  <tr>
                    <td>{{ u.serial }}</td>
                    <td>{{ u.name }}</td>
                    <td>{{ u.site or '-' }}</td>
                    <td>
                      {% if u.start_time %}
                        {{ u.start_time.strftime("%Y-%m-%d %H:%M") }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button type="button"
                                class="btn btn-sm btn-outline-dark"
                                onclick="showMaterialDetails('{{ u.serial }}', '{{ u.id }}')">
                          Bekijk en bewerk
                        </button>
                        <form method="post" action="{{ url_for('materiaal_stop_gebruik') }}" class="d-inline" onsubmit="return confirm('Materiaal niet meer in gebruik zetten?');">
                          <input type="hidden" name="usage_id" value="{{ u.id }}">
                          <button type="submit" class="btn btn-sm btn-outline-secondary">
                            Niet meer gebruiken
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted mt-2">Je hebt momenteel geen materiaal in gebruik.</div>
        {% endif %}
      </div>

      <!-- TAB: door anderen -->
      <div class="tab-pane fade" id="others-usage" role="tabpanel" aria-labelledby="others-usage-tab">
        {% if other_usages %}
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr>
                  <th>Serienummer</th>
                  <th>Naam</th>
                  <th>Werf</th>
                  <th>Gebruikt door</th>
                  <th>In gebruik sinds</th>
                  <th class="text-end">Acties</th>
                </tr>
              </thead>
              <tbody>
                {% for u in other_usages %}
                  <tr>
                    <td>{{ u.serial }}</td>
                    <td>{{ u.name }}</td>
                    <td>{{ u.site or '-' }}</td>
                    <td>{{ u.used_by or '-' }}</td>
                    <td>
                      {% if u.start_time %}
                        {{ u.start_time.strftime("%Y-%m-%d %H:%M") }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button type="button"
                                class="btn btn-sm btn-outline-dark"
                                onclick="showMaterialDetails('{{ u.serial }}', '{{ u.id }}')">
                          Bekijk en bewerk
                        </button>
                        {% if current_user and current_user.is_admin %}
                        <form method="post"
                              action="{{ url_for('materiaal_stop_gebruik') }}"
                              class="d-inline"
                              onsubmit="return confirm('Materiaal van {{ u.used_by }} niet meer in gebruik zetten?');">
                          <input type="hidden" name="usage_id" value="{{ u.id }}">
                          <button class="btn btn-sm btn-outline-danger">
                            Stop gebruik
                          </button>
                        </form>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted mt-2">Geen materiaal in gebruik door andere gebruikers.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Materiaal in gebruik zonder werf -->
{% if usages_without_project %}
<div class="card panel" style="margin-top:16px; border-left: 4px solid #ffc107;">
  <div class="panel-title d-flex align-items-center">
    <span style="color: #ffc107; margin-right: 8px;">‚ö†Ô∏è</span>
    Materiaal in gebruik zonder werf
  </div>
  <div class="panel-sub">Dit materiaal is in gebruik maar niet gekoppeld aan een werf</div>

  <div class="table-responsive mt-3">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th>Serienummer</th>
          <th>Naam</th>
          <th>Gebruikt door</th>
          <th>In gebruik sinds</th>
          <th class="text-end">Acties</th>
        </tr>
      </thead>
      <tbody>
        {% for u in usages_without_project %}
          <tr>
            <td>{{ u.serial }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.used_by or '-' }}</td>
            <td>
              {% if u.start_time %}
                {{ u.start_time.strftime("%Y-%m-%d %H:%M") }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="text-end">
              <div class="btn-group" role="group">
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#assignToProjectModal"
                        data-usage-id="{{ u.id }}"
                        data-mat-name="{{ u.name }}"
                        data-mat-serial="{{ u.serial }}">
                  Koppel aan werf
                </button>
                <form method="post"
                      action="{{ url_for('materiaal_stop_gebruik') }}"
                      class="d-inline"
                      onsubmit="return confirm('Materiaal niet meer in gebruik zetten?');">
                  <input type="hidden" name="usage_id" value="{{ u.id }}">
                  <button class="btn btn-sm btn-outline-secondary">
                    Stop gebruik
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- Flash messages (worden meestal al door base.html getoond, maar kan geen kwaad) -->
<div class="container px-0 mt-3">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category=='danger' else category }} mb-2" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<!-- Materiaallijst / overzicht -->
<div class="card panel" style="margin-top:16px;">
  <div class="panel-title d-flex align-items-center justify-content-between">
    <div>
      Materiaal in het systeem
      <div class="panel-sub">Alle geregistreerde items</div>
    </div>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('materiaal') }}">Herstel filters</a>
  </div>

  <!-- Filterbalk -->
  <form class="row g-2 align-items-center" method="get" action="{{ url_for('materiaal') }}">
    <div class="col-12 col-md-6">
      <div class="input-group">
        <span class="input-group-text">üîé</span>
        <input name="q" value="{{ request.args.get('q','') }}" type="text" class="form-control" placeholder="Zoek op naam of serienummer‚Ä¶">
      </div>
    </div>

    <div class="col-6 col-md-3">
      <select name="type" class="form-select">
        <option value="">Alle types</option>
        {% for t in types_list %}
          <option value="{{ t }}" {% if request.args.get('type')==t %}selected{% endif %}>{{ t|title }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-6 col-md-3">
      <select name="status" class="form-select">
        <option value="">Alle statussen</option>
        <option value="in gebruik" {% if request.args.get('status')=='in gebruik' %}selected{% endif %}>In gebruik</option>
        <option value="niet in gebruik" {% if request.args.get('status')=='niet in gebruik' %}selected{% endif %}>Niet in gebruik</option>
      </select>
    </div>

    <div class="col-12">
      <button class="btn btn-primary">Filteren</button>
    </div>
  </form>

  <!-- Tabel -->
  <div class="table-responsive mt-3">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Serienummer</th>
          <th>Naam</th>
          <th>Type</th>
          <th>Status (in gebruik)</th>
          <th>Keuring</th>
          <th class="text-end">Acties</th>
        </tr>
      </thead>
      <tbody>
        {% if items %}
          {% for it in items %}
          <tr style="cursor: pointer;" 
              onclick="showMaterialDetails('{{ it.serial }}', null)"
              onmouseover="this.style.backgroundColor='#f8f9fa'" 
              onmouseout="this.style.backgroundColor=''">
            <td>{{ it.serial }}</td>
            <td>{{ it.name }}</td>
            <td>{{ it.type|title if it.type else '' }}</td>
            <td>
              {% set is_in_use = it.id in active_material_ids %}
              {% if is_in_use %}
                <span class="badge bg-success">In gebruik</span>
              {% else %}
                <span class="badge bg-danger">Niet in gebruik</span>
              {% endif %}
            </td>
            <td>
              {# Keuring status: altijd gebaseerd op inspection_status, of status als fallback (maar alleen geldige keuringswaardes) #}
              {% set keuring_status = it.inspection_status if it.inspection_status else it.status %}
              {% if keuring_status == "goedgekeurd" %}
                <span class="badge" style="background-color: white; color: #212529; border: 1px solid #198754;">Goedgekeurd</span>
              {% elif keuring_status == "afgekeurd" %}
                <span class="badge" style="background-color: white; color: #212529; border: 1px solid #dc3545;">Afgekeurd</span>
              {% elif keuring_status == "keuring verlopen" %}
                <span class="badge" style="background-color: white; color: #212529; border: 1px solid #ffc107;">Keuring verlopen</span>
              {% elif keuring_status == "keuring gepland" %}
                <span class="badge" style="background-color: white; color: #212529; border: 1px solid #a855f7;">Keuring gepland</span>
              {% elif keuring_status in ["in gebruik", "niet in gebruik"] or not keuring_status %}
                <span class="badge" style="background-color: white; color: #212529; border: 1px solid #6c757d;">Geen keuring</span>
              {% else %}
                <span class="badge" style="background-color: white; color: #212529; border: 1px solid #6c757d;">{{ keuring_status|title }}</span>
              {% endif %}
            </td>
            <td class="text-end" onclick="event.stopPropagation();">
              <button type="button"
                      class="btn btn-sm btn-outline-danger"
                  data-bs-toggle="modal"
                      data-bs-target="#deleteMaterieelModal"
                  data-serial="{{ it.serial }}"
                      data-name="{{ it.name }}">
                Verwijderen
                </button>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6" class="text-muted">Nog geen materiaal gevonden‚Ä¶</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal: Nieuw Materieel -->
<div class="modal fade" id="nieuwMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Nieuw Materiaal Toevoegen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('materiaal_toevoegen') }}" enctype="multipart/form-data" id="nieuwMaterieelForm">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Naam*</label>
              <input name="name" required class="form-control" placeholder="Bv. Boormachine Bosch">
            </div>
            <div class="col-md-6">
              <label class="form-label">Serienummer*</label>
              <input name="serial" required class="form-control" placeholder="Bv. BH-2024-001">
            </div>

            <div class="col-md-6">
              <label class="form-label">Nummer op Materieel (optioneel)</label>
              <input name="nummer_op_materieel" class="form-control" placeholder="Sticker / nummer op toestel">
            </div>

            <div class="col-md-6">
              <label class="form-label">Type*</label>
              <input name="type" required class="form-control" placeholder="Bv. Elektrisch gereedschap">
            </div>

            <div class="col-md-6">
              <label class="form-label">Aankoopdatum*</label>
              <input name="purchase_date" type="date" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Status*</label>
              <select name="status" class="form-select" required>
                <option value="goedgekeurd">Goedgekeurd</option>
                <option value="afgekeurd">Afgekeurd</option>
                <option value="keuring verlopen">Keuring verlopen</option>
                <option value="keuring gepland">Keuring gepland</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Werf (optioneel)</label>
              <select name="project_id" class="form-select">
                <option value="">Geen specifieke werf</option>
                {% for p in projects %}
                  {% set is_future = p.start_date and p.start_date > today %}
                  <option value="{{ p.id }}">
                    {{ p.name or 'Werf ' ~ p.id }}
                    {% if is_future and p.start_date %}
                      (start {{ p.start_date.strftime('%Y-%m-%d') }})
                    {% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Toegewezen aan (optioneel)</label>
              <input name="assigned_to" class="form-control" placeholder="Naam gebruiker">
            </div>

            <div class="col-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="note" class="form-control" rows="3" placeholder="Extra info over het materiaal‚Ä¶"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label">Documentatie (foto of PDF)</label>
              <input 
                type="file"
                name="documentation"
                class="form-control"
                accept="image/*,.pdf"
              >
            </div>

            <div class="col-md-6">
              <label class="form-label">Veiligheidsfiche (handleiding)</label>
              <input
                type="file"
                name="safety_sheet"
                class="form-control"
                accept="image/*,.pdf">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="button" id="submitMaterieelBtn">Materieel Toevoegen</button>
        </div>
      </form>
    </div>
  </div>
            </div>

<!-- Modal: Geen toegang (voor niet-admins) -->
<div class="modal fade" id="accessDeniedModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Geen toegang</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>
      <div class="modal-body">
        <p>Je hebt geen toegang tot deze functie. Alleen admins kunnen materiaal toevoegen of verwijderen.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Materieel verwijderen -->
<div class="modal fade" id="deleteMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('materiaal_verwijderen') }}">
        <div class="modal-header">
          <h5 class="modal-title">Materieel verwijderen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="serial" id="delete-material-serial">
          <p>
            Weet je zeker dat je het materiaal
            <strong id="delete-material-name"></strong>
            wilt verwijderen?
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button type="submit" class="btn btn-danger">Verwijderen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Materieel Details -->
<div class="modal fade" id="materieelDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="details-material-name">Materieel Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>
      <div class="modal-body" id="materieelDetailsBody">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Laden...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Sluiten</button>
        <form method="post" action="{{ url_for('materiaal_stop_gebruik') }}" id="stop-gebruik-form" class="d-inline" style="display: none !important;" onsubmit="return confirm('Materiaal niet meer in gebruik zetten?');">
          <input type="hidden" name="usage_id" id="stop-usage-id">
          <button type="submit" class="btn btn-outline-secondary" id="details-stop-btn">Niet meer gebruiken</button>
        </form>
        <button type="button" class="btn btn-primary" id="details-edit-btn">Bewerken</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Gebruik Materieel -->
<div class="modal fade" id="gebruikMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Materiaal in gebruik nemen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('materiaal_gebruiken') }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Naam*</label>
              <input name="name"
                     id="use-name"
                     list="materiaal-namen"
                     class="form-control"
                     placeholder="Kies of typ een naam">
              <datalist id="materiaal-namen">
                {% for m in all_materials %}
                  {% if m.name %}
                    <option value="{{ m.name }}">{{ m.name }}</option>
                  {% endif %}
                {% endfor %}
              </datalist>
            </div>

            <div class="col-md-6">
              <label class="form-label">Gebruikt door</label>
              <input name="assigned_to"
                     id="use-assigned_to"
                     class="form-control"
                     value="{{ current_user.Naam if current_user else '' }}">
            </div>

            <div class="col-md-6">
              <label class="form-label">Werf (project)</label>
              <select name="project_id" class="form-select">
                <option value="">Geen specifieke werf</option>
                {% for p in projects %}
                  {% set is_future = p.start_date and p.start_date > today %}
                  <option value="{{ p.id }}">
                    {{ p.name or 'Werf ' ~ p.id }}
                    {% if is_future and p.start_date %}
                      (start {{ p.start_date.strftime('%Y-%m-%d') }})
                    {% endif %}
                  </option>
                {% endfor %}
              </select>
              <small class="text-muted">De gekozen werf wordt gelinkt aan dit gebruik.</small>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Materieel gebruiken</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Bewerken -->
<div class="modal fade" id="editMaterieelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Materieel Bewerken</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('materiaal_bewerken') }}" enctype="multipart/form-data">
        <div class="modal-body">
          <input type="hidden" name="original_serial" id="edit-original-serial">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Naam*</label>
              <input name="name" id="edit-name" required class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Serienummer*</label>
              <input name="serial" id="edit-serial" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Nummer op Materieel (optioneel)</label>
              <input name="nummer_op_materieel" id="edit-nummer_op_materieel" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Type*</label>
              <input name="type" id="edit-type" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Aankoopdatum*</label>
              <input name="purchase_date" id="edit-purchase_date" type="date" required class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Werf (optioneel, vrije tekst)</label>
              <input name="site" id="edit-site" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Toegewezen aan (optioneel)</label>
              <input name="assigned_to" id="edit-assigned_to" class="form-control">
            </div>

            <div class="col-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="note" id="edit-note" class="form-control" rows="3"></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label">Keuring*</label>
              <select name="status" id="edit-status" class="form-select" required>
                <option value="goedgekeurd">Goedgekeurd</option>
                <option value="afgekeurd">Afgekeurd</option>
                <option value="keuring verlopen">Keuring verlopen</option>
                <option value="keuring gepland">Keuring gepland</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Keuringstatus (optioneel)</label>
              <input name="inspection_status" id="edit-inspection_status" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Documentatie (foto of PDF)</label>
              <input
                type="file"
                name="documentation"
                class="form-control"
                accept="image/*,.pdf"
              >
            </div>

            <div class="col-md-6">
              <label class="form-label">Veiligheidsfiche (handleiding)</label>
              <input
                type="file"
                name="safety_sheet"
                class="form-control"
                accept="image/*,.pdf"
              >
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.materiaal-grid {
  display: grid;
  /* Flexibel aantal kolommen voor KPI-/actiekaarten */
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  grid-auto-rows: minmax(0, auto);
  gap: 16px;
}

.usage-panel {
  /* Losse kaart onder de KPI-grid, volledige breedte van de content */
}

.modal-dialog-end { margin-right: 0; margin-left: auto; }

.kpi-with-plus {
  position: relative;
}
.kpi-plus-btn {
  position: absolute;
  right: 6px;
  bottom: 6px;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: #000;
  color: #fff;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  line-height: 1;
}
.kpi-plus-btn:hover {
  opacity: 0.85;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Bewerken-modal vullen
  const editModal = document.getElementById('editMaterieelModal');
  if (editModal) {
    editModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      // Only populate from button if button exists (when opened from table)
      // If opened programmatically, values are already set
      if (button) {
      const data = {
        serial: button.getAttribute('data-serial') || '',
        name: button.getAttribute('data-name') || '',
        type: button.getAttribute('data-type') || '',
        purchase_date: button.getAttribute('data-purchase_date') || '',
        assigned_to: button.getAttribute('data-assigned_to') || '',
        site: button.getAttribute('data-site') || '',
        note: button.getAttribute('data-note') || '',
        status: button.getAttribute('data-status') || 'goedgekeurd',
        inspection_status: button.getAttribute('data-inspection_status') || '',
        nummer_op_materieel: button.getAttribute('data-nummer_op_materieel') || ''
      };

      document.getElementById('edit-original-serial').value = data.serial;
      document.getElementById('edit-serial').value = data.serial;
      document.getElementById('edit-name').value = data.name;
      document.getElementById('edit-type').value = data.type;
      document.getElementById('edit-purchase_date').value = data.purchase_date;
      document.getElementById('edit-assigned_to').value = data.assigned_to;
      document.getElementById('edit-site').value = data.site;
      document.getElementById('edit-note').value = data.note;
      document.getElementById('edit-status').value = data.status;
      document.getElementById('edit-inspection_status').value = data.inspection_status;
      document.getElementById('edit-nummer_op_materieel').value = data.nummer_op_materieel;
      }
    });
  }

  // Password modal for "Nieuw Materieel Toevoegen"
  // Admin check voor nieuw materieel toevoegen
  const submitBtn = document.getElementById('submitMaterieelBtn');
  const nieuwMaterieelForm = document.getElementById('nieuwMaterieelForm');
  const isAdmin = {{ 'true' if current_user and current_user.is_admin else 'false' }};
  const accessDeniedModal = new bootstrap.Modal(document.getElementById('accessDeniedModal'));

  if (submitBtn && nieuwMaterieelForm) {
    submitBtn.addEventListener('click', function(e) {
      e.preventDefault();
      if (isAdmin) {
        // Admin: direct formulier versturen
        nieuwMaterieelForm.submit();
      } else {
        // Geen admin: toon melding
        accessDeniedModal.show();
      }
    });
  }

  // Handle "Materieel verwijderen" modal
  const deleteMaterieelModal = document.getElementById('deleteMaterieelModal');
  if (deleteMaterieelModal) {
    deleteMaterieelModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      if (!button) return;

      const serial = button.getAttribute('data-serial') || '';
      const name = button.getAttribute('data-name') || 'dit materiaal';

      const serialInput = document.getElementById('delete-material-serial');
      const nameSpan = document.getElementById('delete-material-name');

      if (serialInput) serialInput.value = serial;
      if (nameSpan) nameSpan.textContent = name;
    });
  }

  // Function to show material details
  // Store modal instance to prevent multiple instances
  let materialDetailsModalInstance = null;
  let currentFetchController = null;
  
  // Initialize modal and add cleanup on hide
  const modalElement = document.getElementById('materieelDetailsModal');
  if (modalElement && !materialDetailsModalInstance) {
    materialDetailsModalInstance = new bootstrap.Modal(modalElement, {
      backdrop: true,
      keyboard: true,
      focus: true
    });
    
    // Cleanup when modal is hidden
    modalElement.addEventListener('hidden.bs.modal', function() {
      // Cancel any ongoing fetch requests
      if (currentFetchController) {
        currentFetchController.abort();
        currentFetchController = null;
      }
      // Clear modal body
      const modalBody = document.getElementById('materieelDetailsBody');
      if (modalBody) {
        modalBody.innerHTML = '';
      }
      // Reset edit button onclick
      const editBtn = document.getElementById('details-edit-btn');
      if (editBtn) {
        editBtn.onclick = null;
      }
    });
  }
  
  window.showMaterialDetails = function(serial, usageId) {
    const modalBody = document.getElementById('materieelDetailsBody');
    const modalTitle = document.getElementById('details-material-name');
    const editBtn = document.getElementById('details-edit-btn');
    
    // Cancel any previous fetch request
    if (currentFetchController) {
      currentFetchController.abort();
    }
    
    // Create new AbortController for this request
    currentFetchController = new AbortController();
    
    // Initially hide stop button, will be shown based on status from API
    const stopForm = document.getElementById('stop-gebruik-form');
    if (stopForm) stopForm.style.display = 'none';
    
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Laden...</span></div></div>';
    modalTitle.textContent = 'Materieel Details';
    
    // Show modal
    if (materialDetailsModalInstance) {
      materialDetailsModalInstance.show();
    }
    
    fetch(`/api/search?q=${encodeURIComponent(serial)}`, {
      signal: currentFetchController.signal
    })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        if (data.items && data.items.length > 0) {
          const item = data.items[0];
          // Status: "in gebruik" or "niet in gebruik" - based on is_in_use from API
          const isInUse = item.is_in_use === true;
          const statusClass = isInUse ? 'bg-success' : 'bg-danger';
          const statusText = isInUse ? 'In gebruik' : 'Niet in gebruik';
          
          // Keuring: altijd gebaseerd op inspection_status, of status als fallback (alleen geldige keuringswaardes)
          let keuringStatus = item.inspection_status || item.status;
          const validKeuringStatuses = ['goedgekeurd', 'afgekeurd', 'keuring verlopen', 'keuring gepland'];
          
          // Als status "in gebruik" of "niet in gebruik" is, negeer het voor keuring
          if (!validKeuringStatuses.includes(keuringStatus)) {
            keuringStatus = null;
          }
          
          // Determine badge text based on keuring status
          let keuringText = 'Geen keuring';
          
          if (keuringStatus === 'goedgekeurd') {
            keuringText = 'Goedgekeurd';
          } else if (keuringStatus === 'afgekeurd') {
            keuringText = 'Afgekeurd';
          } else if (keuringStatus === 'keuring verlopen') {
            keuringText = 'Keuring verlopen';
          } else if (keuringStatus === 'keuring gepland') {
            keuringText = 'Keuring gepland';
          }
          
          // Create badge HTML for keuring status (white background with colored border and black text)
          let keuringBadgeHtml = '';
          let badgeStyle = '';
          
          if (keuringStatus === 'goedgekeurd') {
            badgeStyle = 'background-color: white; color: #212529; border: 1px solid #198754;';
          } else if (keuringStatus === 'afgekeurd') {
            badgeStyle = 'background-color: white; color: #212529; border: 1px solid #dc3545;';
          } else if (keuringStatus === 'keuring verlopen') {
            badgeStyle = 'background-color: white; color: #212529; border: 1px solid #ffc107;';
          } else if (keuringStatus === 'keuring gepland') {
            badgeStyle = 'background-color: white; color: #212529; border: 1px solid #a855f7;';
          } else {
            // Geen keuring - grijs
            badgeStyle = 'background-color: white; color: #212529; border: 1px solid #6c757d;';
          }
          
          if (item.keuring_gepland) {
            keuringBadgeHtml = `<span class="badge" style="${badgeStyle}">Keuring gepland: ${escapeHtml(item.keuring_gepland)}</span>`;
          } else {
            keuringBadgeHtml = `<span class="badge" style="${badgeStyle}">${escapeHtml(keuringText)}</span>`;
          }
          
          const displayValue = (value) => value && value.trim() !== '' ? escapeHtml(value) : 'onbekend';
          
          modalTitle.textContent = escapeHtml(item.name || 'Onbekend');
          
          modalBody.innerHTML = `
            <div class="material-detail">
              <div class="mb-3">
                <strong>Serienummer:</strong> ${displayValue(item.serial)}
              </div>
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <strong>Type:</strong><br>
                  ${displayValue(item.type)}
                </div>
                <div class="col-md-6">
                  <strong>Status:</strong><br>
                  <span class="badge ${statusClass}">${escapeHtml(statusText)}</span>
                </div>
                <div class="col-md-6">
                  <strong>Keuring:</strong><br>
                  ${keuringBadgeHtml}
                  ${item.laatste_keuring ? `
                    <br><small class="text-muted">Laatste keuring: ${escapeHtml(item.laatste_keuring)}</small>
                  ` : ''}
                </div>
                <div class="col-md-6">
                  <strong>Toegewezen aan:</strong><br>
                  ${displayValue(item.assigned_to)}
                </div>
                <div class="col-md-6">
                  <strong>Werf:</strong><br>
                  ${displayValue(item.site)}
                </div>
                <div class="col-md-6">
                  <strong>Aankoopdatum:</strong><br>
                  ${displayValue(item.purchase_date)}
                </div>
                <div class="col-md-6">
                  <strong>Nummer op Materieel:</strong><br>
                  ${displayValue(item.nummer_op_materieel)}
                </div>
              </div>
              <div class="mb-3">
                <strong>Opmerking:</strong><br>
                ${displayValue(item.note)}
              </div>
              ${item.documentation_path ? `
                <div class="mb-3">
                  <strong>Documentatie:</strong><br>
                  <a href="/static/${escapeHtml(item.documentation_path)}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                    üìÑ Bekijk documentatie
                  </a>
                  <a href="/static/${escapeHtml(item.documentation_path)}" download class="btn btn-sm btn-outline-secondary me-2">
                    ‚¨áÔ∏è Download
                  </a>
                  <form method="post" action="{{ url_for('materiaal_document_verwijderen') }}" class="d-inline" onsubmit="return confirm('Weet je zeker dat je dit document wilt verwijderen?');">
                    <input type="hidden" name="serial" value="${escapeHtml(item.serial)}">
                    <input type="hidden" name="doc_type" value="documentation">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      üóëÔ∏è Verwijder
                    </button>
                  </form>
                </div>
              ` : ''}
              ${item.safety_sheet_path ? `
                <div class="mb-3">
                  <strong>Veiligheidsfiche:</strong><br>
                  <a href="/static/${escapeHtml(item.safety_sheet_path)}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                    üìÑ Bekijk veiligheidsfiche
                  </a>
                  <a href="/static/${escapeHtml(item.safety_sheet_path)}" download class="btn btn-sm btn-outline-secondary me-2">
                    ‚¨áÔ∏è Download
                  </a>
                  <form method="post" action="{{ url_for('materiaal_document_verwijderen') }}" class="d-inline" onsubmit="return confirm('Weet je zeker dat je dit document wilt verwijderen?');">
                    <input type="hidden" name="serial" value="${escapeHtml(item.serial)}">
                    <input type="hidden" name="doc_type" value="safety">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      üóëÔ∏è Verwijder
                    </button>
                  </form>
                </div>
              ` : ''}
            </div>
          `;
          
          // Show/hide stop button based on status
          const stopForm = document.getElementById('stop-gebruik-form');
          const stopBtn = document.getElementById('details-stop-btn');
          
          // Always hide first, then show if in use
          if (stopForm) {
            stopForm.style.setProperty('display', 'none', 'important');
          }
          if (stopBtn) {
            stopBtn.style.setProperty('display', 'none', 'important');
          }
          
          if (isInUse) {
            // Material is in use - show "Niet meer gebruiken" button
            if (stopForm) {
              stopForm.style.setProperty('display', 'inline-block', 'important');
            }
            // Set usage_id if available (from usageId parameter)
            if (usageId && document.getElementById('stop-usage-id')) {
              document.getElementById('stop-usage-id').value = usageId;
            }
          }
          
          // Set up edit button - populate edit modal with data from API
          if (editBtn) {
            editBtn.onclick = function() {
              if (materialDetailsModalInstance) {
                materialDetailsModalInstance.hide();
              }
              // Populate edit modal with the material data
              const editModal = new bootstrap.Modal(document.getElementById('editMaterieelModal'));
              document.getElementById('edit-original-serial').value = item.serial || '';
              document.getElementById('edit-serial').value = item.serial || '';
              document.getElementById('edit-name').value = item.name || '';
              document.getElementById('edit-type').value = item.type || '';
              document.getElementById('edit-purchase_date').value = item.purchase_date || '';
              document.getElementById('edit-assigned_to').value = item.assigned_to || '';
              document.getElementById('edit-site').value = item.site || '';
              document.getElementById('edit-note').value = item.note || '';
              
              // For keuring status: if status is "in gebruik", use inspection_status if available, otherwise default to "goedgekeurd"
              let keuringValue = 'goedgekeurd';
              if (item.status === 'in gebruik') {
                // Material is in use, check inspection_status for the original keuring
                keuringValue = item.inspection_status || 'goedgekeurd';
              } else {
                // Material is not in use, status is the keuring status
                keuringValue = item.status || 'goedgekeurd';
              }
              document.getElementById('edit-status').value = keuringValue;
              
              document.getElementById('edit-inspection_status').value = item.inspection_status || '';
              document.getElementById('edit-nummer_op_materieel').value = item.nummer_op_materieel || '';
              editModal.show();
            };
          }
        } else {
          modalBody.innerHTML = '<div class="alert alert-warning">Item niet gevonden.</div>';
        }
      })
      .catch(error => {
        console.error('Error loading material detail:', error);
        modalBody.innerHTML = '<div class="alert alert-danger">Er is een fout opgetreden bij het laden van de details.</div>';
      });
  };
  
  function escapeHtml(text) {
    if (!text) return '';
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }

});
</script>

<!-- Modal: Koppel aan werf -->
<div class="modal fade" id="assignToProjectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('materiaal_assign_to_project') }}">
        <div class="modal-header">
          <h5 class="modal-title">Materiaal koppelen aan werf</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="usage_id" id="assign-usage-id">
          <p>
            Koppel <strong id="assign-mat-name"></strong> 
            <span class="text-muted">(<span id="assign-mat-serial"></span>)</span>
            aan een werf:
          </p>
          <div class="mb-3">
            <label class="form-label">Selecteer werf*</label>
            <select name="project_id" class="form-select" required>
              <option value="">-- Kies een werf --</option>
              {% for p in projects %}
                <option value="{{ p.id }}">{{ p.name or ('Werf ' ~ p.id) }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button type="submit" class="btn btn-primary">Koppelen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const assignModal = document.getElementById('assignToProjectModal');
  if (assignModal) {
    assignModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      if (!button) return;

      const usageId = button.getAttribute('data-usage-id');
      const matName = button.getAttribute('data-mat-name') || 'dit materiaal';
      const matSerial = button.getAttribute('data-mat-serial') || '';

      document.getElementById('assign-usage-id').value = usageId;
      document.getElementById('assign-mat-name').textContent = matName;
      document.getElementById('assign-mat-serial').textContent = matSerial;
    });
  }
});
</script>

{% endblock %}
