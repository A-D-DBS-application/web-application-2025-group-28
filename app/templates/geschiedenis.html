{% extends "base.html" %}
{% block content %}

<div class="section-header">
  <div>
    <h2 class="h-title">Geschiedenis</h2>
    <div class="h-sub">Overzicht van alle activiteiten in het systeem</div>
  </div>

  <div class="d-flex gap-2">
    <a href="{{ url_for('dashboard.dashboard') }}" 
       class="btn btn-outline-secondary">
      ← Terug
    </a>
    <a href="{{ url_for('geschiedenis.geschiedenis_export', type=filter_type, user=filter_user, period=filter_period, q=search_q) }}" 
       class="btn btn-outline-primary d-inline-flex align-items-center gap-2">
      {% include 'partials/export_icon.html' with context %}
      <span>Export CSV</span>
    </a>
  </div>
</div>

<!-- Filters en Activiteiten in één scrollbaar blok -->
<div class="card panel mt-3">
  <form method="get" action="{{ url_for('geschiedenis.geschiedenis') }}" class="row g-3 align-items-end mb-3">
    <!-- Zoeken -->
    <div class="col-12 col-md-4">
      <label class="form-label">Zoeken</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text" name="q" class="form-control" 
               placeholder="Zoek op naam, serienummer of actie..."
               value="{{ search_q }}">
      </div>
    </div>

    <!-- Periode -->
    <div class="col-6 col-md-2">
      <label class="form-label">Periode</label>
      <select name="period" class="form-select">
        {% for key, p in period_filters.items() %}
          <option value="{{ p.value }}" {% if filter_period == p.value %}selected{% endif %}>{{ p.label }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Gebruiker -->
    <div class="col-6 col-md-3">
      <label class="form-label">Gebruiker</label>
      <select name="user" class="form-select">
        <option value="">Alle gebruikers</option>
        {% for user in users_list %}
          <option value="{{ user }}" {% if filter_user == user %}selected{% endif %}>{{ user }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Knoppen -->
    <div class="col-12 col-md-3">
      <button type="submit" class="btn btn-primary">Filteren</button>
      <a href="{{ url_for('geschiedenis.geschiedenis') }}" class="btn btn-outline-secondary">Reset</a>
    </div>
  </form>

  <!-- Categorie tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link {% if filter_type == 'all' %}active{% endif %}" 
         href="{{ url_for('geschiedenis.geschiedenis', type='all', user=filter_user, period=filter_period, q=search_q) }}">
        Alle ({{ all_count }})
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if filter_type == 'materiaal' %}active{% endif %}"
         href="{{ url_for('geschiedenis.geschiedenis', type='materiaal', user=filter_user, period=filter_period, q=search_q) }}">
        Materiaal ({{ materiaal_count }})
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if filter_type == 'gebruik' %}active{% endif %}"
         href="{{ url_for('geschiedenis.geschiedenis', type='gebruik', user=filter_user, period=filter_period, q=search_q) }}">
        Gebruik ({{ gebruik_count }})
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if filter_type == 'keuring' %}active{% endif %}"
         href="{{ url_for('geschiedenis.geschiedenis', type='keuring', user=filter_user, period=filter_period, q=search_q) }}">
        Keuringen ({{ keuring_count }})
      </a>
    </li>
  </ul>

  <!-- Activiteiten tabel in scrollbare container (4 items zichtbaar) -->
  <div class="table-responsive mt-3" style="max-height: 280px; overflow-y: auto;">
    <table class="table align-middle">
      <thead class="sticky-top bg-white">
        <tr>
          <th class="w-160">Datum & Tijd</th>
          <th>Actie</th>
          <th>Materiaal</th>
          <th>Serienummer</th>
          <th>Gebruiker</th>
        </tr>
      </thead>
      <tbody>
        {% if activities %}
          {% for act in activities %}
            <tr>
              <td>
                {% if act.created_at %}
                  <div>{{ act.created_at.strftime("%Y-%m-%d") }}</div>
                  <small class="text-muted">{{ act.created_at.strftime("%H:%M:%S") }}</small>
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% set action_lower = act.action|lower if act.action else '' %}
                {% if 'toegevoegd' in action_lower %}
                  <span class="badge bg-success">{{ act.action }}</span>
                {% elif 'verwijderd' in action_lower %}
                  <span class="badge bg-danger">{{ act.action }}</span>
                {% elif 'bewerkt' in action_lower %}
                  <span class="badge bg-info">{{ act.action }}</span>
                {% elif 'in gebruik' in action_lower and 'niet' not in action_lower %}
                  <span class="badge bg-primary">{{ act.action }}</span>
                {% elif 'niet meer in gebruik' in action_lower %}
                  <span class="badge bg-secondary">{{ act.action }}</span>
                {% elif 'keuring' in action_lower %}
                  <span class="badge bg-warning text-dark">{{ act.action }}</span>
                {% elif 'verplaatst' in action_lower or 'gekoppeld' in action_lower %}
                  <span class="badge bg-info">{{ act.action }}</span>
                {% else %}
                  <span class="badge bg-secondary">{{ act.action or '-' }}</span>
                {% endif %}
              </td>
              <td>{{ act.name or '-' }}</td>
              <td>
                {% if act.serial %}
                  <code>{{ act.serial }}</code>
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ act.user_name or '-' }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" class="text-muted text-center py-4">
              Geen activiteiten gevonden voor de geselecteerde filters.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  {% if activities|length >= 500 %}
    <div class="alert alert-info mt-3">
      <strong>Let op:</strong> Er worden maximaal 500 resultaten getoond. Gebruik de filters om specifiekere resultaten te krijgen.
    </div>
  {% endif %}
</div>

{% endblock %}




