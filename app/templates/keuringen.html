{% extends "base.html" %}
{% from 'partials/stat_card.html' import stat_card %}
{% block content %}

<div class="keuringen-header mb-6">
  <div class="keuringen-header-content">
    <div>
      <h1 class="keuringen-main-title mb-2">Keuringen & Inspecties</h1>
      <p class="keuringen-subtitle mb-6">Wat moet ik nu keuren?</p>
    </div>
    <button class="btn btn-dark btn-with-icon" 
            data-bs-toggle="modal"
            data-bs-target="#nieuweKeuringModal">
      <span class="btn-icon-large">+</span>
      <span>Keuring Plannen</span>
    </button>
  </div>
</div>

<!-- A. PRIORITEIT CARDS -->
<div class="grid grid-top mb-8">
  {{ stat_card(
    title="Te laat",
    value=te_laat_count or 0,
    subtitle="Keuringen die verlopen zijn",
    icon="bi bi-exclamation-triangle",
    color="warn",
    url=url_for('keuringen.keuringen', priority='te_laat', q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to)
  ) }}
  
  {{ stat_card(
    title="Te keuren vandaag",
    value=vandaag_count or 0,
    subtitle="Moeten vandaag gekeurd worden",
    icon="bi bi-calendar-event",
    color="warn",
    url=url_for('keuringen.keuringen', priority='vandaag', q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to)
  ) }}
  
  {{ stat_card(
    title="Binnen 30 dagen",
    value=binnen_30_dagen_count or 0,
    subtitle="Keuringen binnenkort",
    icon="bi bi-clock",
    color="warn",
    url=url_for('keuringen.keuringen', priority='binnen_30', q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to)
  ) }}
</div>

<!-- B. FILTER BAR -->
<div class="keuringen-overview-section">
  <div class="keuringen-overview-header">
    <h2 class="keuringen-overview-title">Keuringsoverzicht</h2>
    <p class="keuringen-overview-subtitle">{{ total_items }} keuring(en) gevonden</p>
  </div>

  <form method="get" action="{{ url_for('keuringen.keuringen') }}" id="filterForm" class="keuringen-filter-form">
    <!-- Preserve priority filter if set -->
    {% if priority_filter %}
    <input type="hidden" name="priority" value="{{ priority_filter }}">
    {% endif %}
    
    <div class="keuringen-filter-grid">
      <!-- Text Search -->
      <div class="keuringen-filter-item keuringen-filter-search">
        <div class="keuringen-search-wrapper">
          <span class="keuringen-search-icon"><i class="bi bi-search"></i></span>
          <input type="text" 
                 name="q" 
                 value="{{ search_q }}" 
                 class="keuringen-search-input" 
                 placeholder="Zoek op naam of serienummer...">
        </div>
      </div>

      <!-- Status Filter -->
      <div class="keuringen-filter-item">
        <select name="status" class="keuringen-filter-select">
          <option value="">Alle statussen</option>
          {% for filter_key, filter_data in keuring_status_filters.items() %}
          <option value="{{ filter_data.value }}" {% if status_filter == filter_data.value %}selected{% endif %}>{{ filter_data.label }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Werf/Location Filter -->
      <div class="keuringen-filter-item">
        <select name="werf" class="keuringen-filter-select">
          <option value="">Alle werven</option>
          {% for project in all_projects %}
          <option value="{{ project.id }}" {% if werf_filter == project.id|string %}selected{% endif %}>
            {{ project.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Type Filter -->
      <div class="keuringen-filter-item">
        <select name="type" class="keuringen-filter-select">
          <option value="">Alle types</option>
          {% for t in types_list %}
          <option value="{{ t }}" {% if type_filter == t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Performer Filter -->
      <div class="keuringen-filter-item">
        <select name="performer" class="keuringen-filter-select">
          <option value="">Alle keurders</option>
          {% for p in performers_list %}
          <option value="{{ p }}" {% if performer_filter == p %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Date Range -->
      <div class="keuringen-filter-item">
        <input type="date" 
               name="date_from" 
               value="{{ date_from }}" 
               class="keuringen-filter-select" 
               placeholder="Van datum">
      </div>
      <div class="keuringen-filter-item">
        <input type="date" 
               name="date_to" 
               value="{{ date_to }}" 
               class="keuringen-filter-select" 
               placeholder="Tot datum">
      </div>

      <!-- Buttons -->
      <div class="keuringen-filter-actions">
        <button type="submit" class="btn btn-primary keuringen-filter-btn">Filteren</button>
        <a href="{{ url_for('keuringen.keuringen') }}" class="btn btn-outline-secondary keuringen-filter-btn">Reset</a>
        <a href="{{ url_for('keuringen.keuringen_export', q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to, priority=priority_filter) }}" 
           class="btn btn-outline-primary keuringen-filter-btn d-inline-flex align-items-center gap-2">
          {% include 'partials/export_icon.html' with context %}
          <span>Export CSV</span>
        </a>
      </div>
    </div>
  </form>
</div>

<!-- C. MAIN TABLE -->
<div class="keuringen-table-container">
  <div class="table-responsive">
    <table class="keuringen-table">
      <thead>
        <tr>
          <th>
            <a href="{{ url_for('keuringen.keuringen', sort='materieel', order='asc' if sort_by != 'materieel' or sort_order == 'desc' else 'desc', q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to, priority=priority_filter) }}" 
               class="keuringen-table-header-link">
              MATERIEEL
              {% if sort_by == 'materieel' %}
                {% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
              {% endif %}
            </a>
          </th>
          <th>WERF / LOCATIE</th>
          <th>
            <a href="{{ url_for('keuringen.keuringen', sort='laatste_keuring', order='asc' if sort_by != 'laatste_keuring' or sort_order == 'desc' else 'desc', q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to, priority=priority_filter) }}" 
               class="keuringen-table-header-link">
              LAATSTE KEURING
              {% if sort_by == 'laatste_keuring' %}
                {% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
              {% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('keuringen.keuringen', sort='volgende_keuring', order='asc' if sort_by != 'volgende_keuring' or sort_order == 'desc' else 'desc', q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to, priority=priority_filter) }}" 
               class="keuringen-table-header-link">
              VOLGENDE KEURING
              {% if sort_by == 'volgende_keuring' %}
                {% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
              {% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('keuringen.keuringen', sort='resultaat', order='asc' if sort_by != 'resultaat' or sort_order == 'desc' else 'desc', q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to, priority=priority_filter) }}" 
               class="keuringen-table-header-link">
              RESULTAAT
              {% if sort_by == 'resultaat' %}
                {% if sort_order == 'asc' %}↑{% else %}↓{% endif %}
              {% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('keuringen.keuringen', sort='risk', order='desc' if sort_by != 'risk' or sort_order == 'asc' else 'asc', q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to, priority=priority_filter) }}" 
               class="keuringen-table-header-link">
              RISICO
              {% if sort_by == 'risk' %}
                {% if sort_order == 'desc' %}↑{% else %}↓{% endif %}
              {% endif %}
            </a>
          </th>
          <th>CERTIFICAAT</th>
          <th class="text-end">ACTIES</th>
        </tr>
      </thead>
      <tbody>
        {% if inspection_list and inspection_list|length > 0 %}
          {% for item in inspection_list %}
            {% set keuring = item.keuring %}
            {% set material = item.material %}
            <tr>
              <td>
                <button type="button"
                        class="keuringen-material-link"
                        data-material-serial="{{ material.serial }}"
                        data-material-id="{{ material.id }}"
                        onclick="showMaterialInspectionHistory(this.getAttribute('data-material-serial'), parseInt(this.getAttribute('data-material-id')))">
                  <div class="keuringen-material-name">{{ material.name or 'Onbekend' }}</div>
                  <div class="keuringen-material-serial">{{ material.serial }}</div>
                </button>
              </td>
              <td>
                {# 
                  BUG FIX: Previously showed material.site or material.project_id (default/initial location).
                  Now shows active usage location from materiaal_gebruik table.
                  - If material is "in gebruik" (has active materiaal_gebruik record): show werf name or locatie from active usage
                  - If material is "niet in gebruik": show "-"
                #}
                {% if item.in_gebruik and item.current_location %}
                  {{ item.current_location }}
                {% else %}
                  <span class="keuringen-table-empty-cell">-</span>
                {% endif %}
              </td>
              <td>
                {% if keuring.laatste_controle %}
                  {{ keuring.laatste_controle.strftime('%Y-%m-%d') }}
                {% else %}
                  <span class="keuringen-table-empty-cell">Nog niet uitgevoerd</span>
                {% endif %}
              </td>
              <td>
                {% if keuring.volgende_controle %}
                  <div>{{ keuring.volgende_controle.strftime('%Y-%m-%d') }}</div>
                  {% if item.dagen_verschil is not none %}
                    {% if item.dagen_verschil < 0 %}
                      <small class="keuringen-table-date-late">({{ -item.dagen_verschil }} dag{% if -item.dagen_verschil != 1 %}en{% endif %} te laat)</small>
                    {% elif item.dagen_verschil == 0 %}
                      <small class="keuringen-table-date-today">(Vandaag!)</small>
                    {% else %}
                      <small class="keuringen-table-date-upcoming">(over {{ item.dagen_verschil }} dag{% if item.dagen_verschil != 1 %}en{% endif %})</small>
                    {% endif %}
                  {% endif %}
                {% else %}
                  <span class="keuringen-table-empty-cell">-</span>
                {% endif %}
              </td>
              <td>
                {% if item.status_badge == 'te laat' %}
                  <span class="keuringen-badge keuringen-badge-te-laat"><i class="bi bi-exclamation-triangle me-1"></i>Te laat</span>
                {% elif item.status_badge == 'vandaag' %}
                  <span class="keuringen-badge keuringen-badge-vandaag"><i class="bi bi-calendar-event me-1"></i>Vandaag</span>
                {% elif item.status_badge == 'binnenkort' %}
                  <span class="keuringen-badge keuringen-badge-binnenkort"><i class="bi bi-clock me-1"></i>Binnenkort</span>
                {% elif item.status_badge == 'goedgekeurd' %}
                  <span class="keuringen-badge keuringen-badge-goedgekeurd"><i class="bi bi-check-circle me-1"></i>Goedgekeurd</span>
                {% elif item.status_badge == 'afgekeurd' %}
                  <span class="keuringen-badge keuringen-badge-afgekeurd"><i class="bi bi-x-circle me-1"></i>Afgekeurd</span>
                {% else %}
                  <span class="keuringen-badge keuringen-badge-gepland">Te Keuren</span>
                {% endif %}
              </td>
              <td>
                {% if item.risk_level == 'critical' %}
                  <span class="badge bg-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ item.risk_explanation }}">Kritiek ({{ item.risk_score }})</span>
                {% elif item.risk_level == 'high' %}
                  <span class="badge bg-warning text-dark" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ item.risk_explanation }}">Hoog ({{ item.risk_score }})</span>
                {% elif item.risk_level == 'medium' %}
                  <span class="badge bg-info text-dark" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ item.risk_explanation }}">Gemiddeld ({{ item.risk_score }})</span>
                {% else %}
                  <span class="badge bg-secondary" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ item.risk_explanation }}">Laag ({{ item.risk_score }})</span>
                {% endif %}
              </td>
              <td>
                {% if item.has_certificate and item.certificaat_url %}
                  <a href="{{ item.certificaat_url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Certificaat bekijken">
                    <i class="bi bi-file-earmark-text me-1"></i>Certificaat
                  </a>
                {% elif item.has_certificate %}
                  <span class="btn btn-sm btn-outline-secondary" title="Certificaat URL niet beschikbaar">
                    <i class="bi bi-file-earmark-text me-1"></i>Certificaat
                  </span>
                {% else %}
                  <span class="keuringen-table-empty-cell">-</span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="keuringen-action-buttons">
                  {% if not keuring.laatste_controle %}
                    <!-- Not yet inspected - show "Resultaat registreren" -->
                    <button type="button" 
                            class="keuringen-action-btn keuringen-action-btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#keuringResultaatModal"
                            data-keuring-id="{{ keuring.id }}"
                            onclick="openResultaatModal(parseInt(this.getAttribute('data-keuring-id')))">
                      Resultaat registreren
                    </button>
                    <button type="button" 
                            class="keuringen-action-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#bewerkKeuringModal"
                            data-keuring-id="{{ keuring.id }}"
                            data-serial="{{ material.serial }}"
                            data-volgende-datum="{{ keuring.volgende_controle.strftime('%Y-%m-%d') if keuring.volgende_controle else '' }}"
                            data-uitgevoerd-door="{{ (keuring.uitgevoerd_door or '')|replace("'", "&#39;") }}"
                            data-opmerking="{{ (keuring.opmerkingen or '')|replace("'", "&#39;")|replace('"', '&quot;') }}"
                            onclick="openEditKeuringModal(this)">
                      Bewerken
                    </button>
                  {% else %}
                    <!-- Already inspected - show certificate link if available -->
                    {% if item.has_certificate %}
                      <a href="{{ item.certificaat_url }}" target="_blank" class="keuringen-action-btn keuringen-action-btn-link" title="Certificaat">
                        Certificaat
                      </a>
                    {% endif %}
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="keuringen-table-empty-message">
              Geen keuringen gevonden. 
              {% if search_q or status_filter or werf_filter or type_filter or performer_filter or date_from or date_to %}
                <a href="{{ url_for('keuringen.keuringen') }}">Wis filters</a>
              {% endif %}
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

  <!-- Pagination -->
  {% if pagination and pagination.pages > 1 %}
  <nav aria-label="Keuringen paginatie" class="mt-3">
    <ul class="pagination justify-content-center">
      {% if pagination.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('keuringen.keuringen', page=pagination.prev_num, q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to, priority=priority_filter, sort=sort_by, order=sort_order) }}">Vorige</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">Vorige</span>
      </li>
      {% endif %}

      {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
        {% if page_num %}
          {% if page_num == pagination.page %}
          <li class="page-item active">
            <span class="page-link">{{ page_num }}</span>
          </li>
          {% else %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('keuringen.keuringen', page=page_num, q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to, priority=priority_filter, sort=sort_by, order=sort_order) }}">{{ page_num }}</a>
          </li>
          {% endif %}
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">…</span>
          </li>
        {% endif %}
      {% endfor %}

      {% if pagination.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('keuringen.keuringen', page=pagination.next_num, q=search_q, status=status_filter, werf=werf_filter, type=type_filter, performer=performer_filter, date_from=date_from, date_to=date_to, priority=priority_filter, sort=sort_by, order=sort_order) }}">Volgende</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">Volgende</span>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- MODALS (keep existing modals but improve them) -->
<!-- Modal: Nieuwe Keuring -->
<div class="modal fade" id="nieuweKeuringModal" tabindex="-1" aria-labelledby="nieuweKeuringModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="nieuweKeuringModalLabel">Keuring Plannen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('keuringen.keuring_toevoegen') }}" id="nieuweKeuringForm">
        <div class="modal-body">
          <div id="nieuweKeuringErrors" class="alert alert-danger error-container" style="display: none;"></div>
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Materieel <span class="text-danger">*</span></label>
              <input name="serial"
                     id="keuring-serial"
                     list="keuring-materiaal-serial"
                     class="form-control"
                     placeholder="Kies of typ een serienummer"
                     required>
              <datalist id="keuring-materiaal-serial">
                {% for m in all_materials %}
                  {% if m.serial %}
                    <option value="{{ m.serial }}">{{ m.name }} ({{ m.serial }})</option>
                  {% endif %}
                {% endfor %}
              </datalist>
              <small class="text-muted">Selecteer het materiaal dat gekeurd moet worden</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Keuring Datum <span class="text-danger">*</span></label>
              <input type="date"
                     name="keuring_datum"
                     id="keuring-datum"
                     class="form-control"
                     required>
              <small class="text-muted">Datum waarop de keuring plaatsvindt</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Uitgevoerd door <span class="text-danger">*</span></label>
              <input name="uitgevoerd_door"
                     class="form-control"
                     placeholder="Bv. Keuringsinstantie VINÇOTTE"
                     value="{{ current_user.Naam if current_user else '' }}"
                     required>
              <small class="text-muted">Wie voert de keuring uit</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="opmerking"
                        class="form-control"
                        rows="3"
                        placeholder="Extra informatie over de keuring..."></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button class="btn btn-primary" type="submit">Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Bewerk Keuring -->
<div class="modal fade" id="bewerkKeuringModal" tabindex="-1" aria-labelledby="bewerkKeuringModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bewerkKeuringModalLabel">Keuring Bewerken</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('keuringen.keuring_bewerken') }}" id="bewerkKeuringForm">
        <input type="hidden" name="keuring_id" id="edit-keuring-id">
        <div class="modal-body">
          <div id="bewerkKeuringErrors" class="alert alert-danger error-container" style="display: none;"></div>
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Materieel</label>
              <input name="serial"
                     id="edit-keuring-serial"
                     class="form-control"
                     readonly>
              <small class="text-muted">Serienummer van het materiaal</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Geplande Datum <span class="text-danger">*</span></label>
              <input type="date"
                     name="volgende_keuring_datum"
                     id="edit-volgende-keuring-datum"
                     class="form-control"
                     required>
              <small class="text-muted">Datum voor de volgende keuring</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Uitgevoerd door <span class="text-danger">*</span></label>
              <input name="uitgevoerd_door"
                     id="edit-keuring-uitgevoerd-door"
                     class="form-control"
                     placeholder="Bv. Keuringsinstantie VINÇOTTE"
                     required>
              <small class="text-muted">Wie voert de keuring uit</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="opmerking"
                        id="edit-keuring-opmerking"
                        class="form-control"
                        rows="3"
                        placeholder="Extra informatie over de keuring..."></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button class="btn btn-primary" type="submit">Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Keuring Resultaat Invoeren -->
<div class="modal fade" id="keuringResultaatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Resultaat Registreren</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('keuringen.keuring_resultaat') }}" enctype="multipart/form-data" id="keuringResultaatForm">
        <input type="hidden" name="keuring_id" id="resultaat-keuring-id">
        <div class="modal-body">
          <div id="keuringResultaatErrors" class="alert alert-danger error-container" style="display: none;"></div>
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Resultaat <span class="text-danger">*</span></label>
              <select name="resultaat" id="resultaat-select" class="form-select" required>
                <option value="">Selecteer resultaat</option>
                <option value="goedgekeurd">Goedgekeurd</option>
                <option value="afgekeurd">Afgekeurd</option>
                <option value="voorwaardelijk">Voorwaardelijk</option>
              </select>
              <small class="text-muted">Wat is het resultaat van de keuring?</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Keuring Datum <span class="text-danger">*</span></label>
              <input type="date"
                     name="keuring_datum"
                     id="resultaat-keuring-datum"
                     class="form-control"
                     required>
              <small class="text-muted">Wanneer is de keuring uitgevoerd?</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Uitgevoerd door <span class="text-danger">*</span></label>
              <input name="uitgevoerd_door"
                     id="resultaat-uitgevoerd-door"
                     class="form-control"
                     placeholder="Bv. Keuringsinstantie VINÇOTTE"
                     value="{{ current_user.Naam if current_user else '' }}"
                     required>
              <small class="text-muted">Wie heeft de keuring uitgevoerd?</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Volgende Keuring Datum</label>
              <input type="date"
                     name="volgende_keuring_datum"
                     id="resultaat-volgende-keuring-datum"
                     class="form-control">
              <small class="text-muted">Wanneer moet de volgende keuring plaatsvinden? (Laat leeg voor standaard 6 maanden)</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Certificaat (optioneel)</label>
              <input type="file"
                     name="certificaat"
                     id="resultaat-certificaat"
                     class="form-control"
                     accept=".pdf,.jpg,.jpeg,.png">
              <small class="text-muted">Upload het keuringscertificaat (PDF of afbeelding, max 10MB)</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="opmerking"
                        id="resultaat-opmerking"
                        class="form-control"
                        rows="3"
                        placeholder="Extra informatie over de keuring..."></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button class="btn btn-primary" type="submit">Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Materieel Inspectie Historiek -->
<div class="modal fade" id="materieelInspectieHistoriekModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historiek-material-name">Materieel Inspectie Historiek</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>
      <div class="modal-body" id="materieelInspectieHistoriekBody">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Laden...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" 
                id="modalBewerkenBtn" 
                class="btn btn-outline-secondary"
                onclick="enterEditMode()">
          Bewerken
        </button>
        <button type="button" 
                id="modalVerwijderenBtn" 
                class="btn btn-danger"
                onclick="confirmDeleteMaterial()"
                disabled>
          Verwijderen
        </button>
        <button type="button" 
                id="modalSluitenBtn" 
                class="btn btn-outline-secondary" 
                data-bs-dismiss="modal">
          Sluiten
        </button>
        <!-- Edit mode buttons (hidden by default) -->
        <div id="editModeButtons" style="display: none;">
          <button type="button" 
                  id="modalAnnulerenBtn" 
                  class="btn btn-outline-secondary"
                  onclick="cancelEdit()">
            Annuleren
          </button>
          <button type="button" 
                  id="modalOpslaanBtn" 
                  class="btn btn-primary"
                  onclick="saveMaterialEdit()">
            Opslaan
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Local CSS overrides for Keuringen page only */

/* Hide error containers when empty */
.error-container:empty {
  display: none !important;
}

/* 1. Summary indicator colors */
/* "Te keuren vandaag" - dark blue (#001F54) */
.grid.grid-top .kpi:nth-child(2) .kpi-title,
.grid.grid-top .kpi:nth-child(2) .kpi-title i,
.grid.grid-top .kpi:nth-child(2) .kpi-value {
  color: #001F54 !important;
}

/* "Binnen 30 dagen" - orange (#F4A100) */
.grid.grid-top .kpi:nth-child(3) .kpi-title,
.grid.grid-top .kpi:nth-child(3) .kpi-title i,
.grid.grid-top .kpi:nth-child(3) .kpi-value {
  color: #F4A100 !important;
}

/* 2. Reduce height of filter inputs and buttons */
.keuringen-filter-select {
  padding: 8px 12px !important;
  font-size: 14px !important;
  height: auto !important;
}

/* Move search icon to the right and adjust input padding */
.keuringen-search-icon {
  left: auto !important;
  right: 16px !important;
}

.keuringen-search-input {
  padding: 8px 40px 8px 12px !important;
  font-size: 14px !important;
  height: auto !important;
}

.keuringen-filter-btn {
  padding: 8px 16px !important;
  font-size: 14px !important;
  height: auto !important;
}

/* 3. Update badge colors - Keuringen page only */
/* Afgekeurd → Red (#D32F2F) */
.keuringen-badge-afgekeurd {
  background-color: #D32F2F !important;
  color: #ffffff !important;
}

/* Te laat → Orange (#F4A100) */
.keuringen-badge-te-laat {
  background-color: #F4A100 !important;
  color: #ffffff !important;
}

/* Te keuren (vandaag badge) → Yellow (#F6D500, dark text) */
.keuringen-badge-vandaag {
  background-color: #F6D500 !important;
  color: #111827 !important; /* dark text */
}

/* Goedgekeurd → Green (#2E7D32) */
.keuringen-badge-goedgekeurd {
  background-color: #2E7D32 !important;
  color: #ffffff !important;
}

/* Keuring gepland (gepland badge) → Blue (#1565C0) */
.keuringen-badge-gepland {
  background-color: #1565C0 !important;
  color: #ffffff !important;
}
</style>

<script>
// Cleanup modals
function cleanupModals() {
  const backdrops = document.querySelectorAll('.modal-backdrop');
  backdrops.forEach(backdrop => backdrop.remove());
  document.body.classList.remove('modal-open');
  document.body.style.overflow = '';
  document.body.style.paddingRight = '';
}

// Clear error containers when modals open
function clearErrorContainers() {
  const errorContainers = document.querySelectorAll('.error-container');
  errorContainers.forEach(container => {
    container.innerHTML = '';
    container.style.display = 'none';
  });
}

// Show error in container (only if error message exists and is non-empty)
function showErrorInContainer(containerId, errorMessage) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  // Only show if error message exists and has content
  if (errorMessage && typeof errorMessage === 'string' && errorMessage.trim().length > 0) {
    container.innerHTML = escapeHtml(errorMessage);
    container.style.display = 'block';
  } else {
    container.innerHTML = '';
    container.style.display = 'none';
  }
}

// Helper function to escape HTML
function escapeHtml(text) {
  if (!text) return '';
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.toString().replace(/[&<>"']/g, m => map[m]);
}

document.addEventListener('DOMContentLoaded', function() {
  cleanupModals();
  
  // Clear error containers on page load
  clearErrorContainers();
  
  const allModals = document.querySelectorAll('.modal');
  allModals.forEach(modal => {
    // Clear errors when modal opens
    modal.addEventListener('show.bs.modal', function() {
      clearErrorContainers();
    });
    
    // Cleanup when modal closes
    modal.addEventListener('hidden.bs.modal', function() {
      cleanupModals();
      clearErrorContainers();
    });
  });
  
  // Also handle form submissions to clear errors on retry
  const forms = document.querySelectorAll('#nieuweKeuringForm, #bewerkKeuringForm, #keuringResultaatForm');
  forms.forEach(form => {
    form.addEventListener('submit', function(e) {
      // Clear errors when form is submitted (user is retrying)
      const errorContainer = form.querySelector('.error-container');
      if (errorContainer) {
        errorContainer.innerHTML = '';
        errorContainer.style.display = 'none';
      }
    });
  });
  
  // Initialize Bootstrap tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

// Global state for modal
let currentMaterialData = null;
let currentMaterialId = null;
let currentHistoryData = null;
let deleteTarget = null; // { kind: 'historiek', id: number, materiaalId: number } | { kind: 'planning', serienummer: string } | null
let isEditMode = false;
let isDeleting = false;
let isLoading = false;

// Show material inspection history
window.showMaterialInspectionHistory = function(serial, materialId) {
  const modal = new bootstrap.Modal(document.getElementById('materieelInspectieHistoriekModal'));
  const modalBody = document.getElementById('materieelInspectieHistoriekBody');
  const modalTitle = document.getElementById('historiek-material-name');
  
  // Reset state
  isEditMode = false;
  currentMaterialData = null;
  currentMaterialId = materialId;
  currentHistoryData = null;
  deleteTarget = null;
  isDeleting = false;
  isLoading = true;
  exitEditMode();
  
  modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Laden...</span></div></div>';
  modal.show();
  
  // Fetch material info and history
  fetch(`/api/search?q=${encodeURIComponent(serial)}`)
    .then(response => response.json())
    .then(data => {
      if (data.error || !data.items || data.items.length === 0) {
        modalBody.innerHTML = '<div class="alert alert-warning">Materieel niet gevonden.</div>';
        return;
      }
      
      const material = data.items[0];
      currentMaterialData = material;
      modalTitle.textContent = `${material.name || 'Onbekend'} - Inspectie Historiek`;
      
      // Fetch inspection history
      fetch(`/api/keuring/historiek/${materialId}`)
        .then(response => response.json())
        .then(historyData => {
          isLoading = false;
          currentHistoryData = historyData;
          
          // Compute deleteTarget: can delete historiek or planned keuring
          deleteTarget = computeDeleteTarget(historyData, material, materialId);
          
          // Enable/disable delete button based on deleteTarget
          updateDeleteButtonState();
          
          // Determine status badge
          let statusBadgeClass = 'bg-secondary';
          let statusText = historyData.inspection_status || 'Onbekend';
          if (statusText === 'goedgekeurd') {
            statusBadgeClass = 'bg-success';
          } else if (statusText === 'afgekeurd') {
            statusBadgeClass = 'bg-danger';
          } else if (statusText === 'keuring verlopen' || statusText === 'keuring gepland') {
            statusBadgeClass = 'bg-warning';
          }
          
          // Calculate next inspection info
          let volgendeKeuringHtml = '';
          if (historyData.volgende_keuring_datum) {
            const dagen = historyData.dagen_verschil;
            if (dagen !== null && dagen !== undefined) {
              if (dagen < 0) {
                volgendeKeuringHtml = `<br><small class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>${Math.abs(dagen)} dag${Math.abs(dagen) !== 1 ? 'en' : ''} te laat</small>`;
              } else if (dagen === 0) {
                volgendeKeuringHtml = `<br><small class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Vandaag!</small>`;
              } else if (dagen <= 30) {
                volgendeKeuringHtml = `<br><small class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Nog ${dagen} dag${dagen !== 1 ? 'en' : ''} tot volgende keuring</small>`;
        } else {
                volgendeKeuringHtml = `<br><small class="text-muted">Nog ${dagen} dag${dagen !== 1 ? 'en' : ''} tot volgende keuring</small>`;
              }
            }
          }
          
          // Render view mode HTML
          renderViewMode(material, historyData, statusBadgeClass, statusText, volgendeKeuringHtml);
        })
        .catch(error => {
          isLoading = false;
          console.error('Error loading history:', error);
          modalBody.innerHTML = '<div class="alert alert-danger">Fout bij laden historiek.</div>';
          updateDeleteButtonState();
        });
    })
    .catch(error => {
      isLoading = false;
      console.error('Error loading material:', error);
      modalBody.innerHTML = '<div class="alert alert-danger">Fout bij laden materiaal.</div>';
      updateDeleteButtonState();
    });
};

// Open edit modal
  window.openEditKeuringModal = function(button) {
    const keuringId = button.getAttribute('data-keuring-id');
    const serial = button.getAttribute('data-serial') || '';
    const volgendeDatum = button.getAttribute('data-volgende-datum') || '';
    const uitgevoerdDoor = button.getAttribute('data-uitgevoerd-door') || '';
    const opmerking = button.getAttribute('data-opmerking') || '';
    
    document.getElementById('edit-keuring-id').value = keuringId || '';
  document.getElementById('edit-keuring-serial').value = serial || '';
  document.getElementById('edit-volgende-keuring-datum').value = volgendeDatum || '';
  document.getElementById('edit-keuring-uitgevoerd-door').value = uitgevoerdDoor || '';
  document.getElementById('edit-keuring-opmerking').value = opmerking || '';
};

// Open resultaat modal
window.openResultaatModal = function(keuringId) {
  document.getElementById('resultaat-keuring-id').value = keuringId || '';
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('resultaat-keuring-datum').value = today;
  
  // Set default volgende keuring (6 maanden later)
  const sixMonthsLater = new Date();
  sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
  const nextDate = sixMonthsLater.toISOString().split('T')[0];
  document.getElementById('resultaat-volgende-keuring-datum').value = nextDate;
  };

  function escapeHtml(text) {
    if (!text) return '';
    const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.toString().replace(/[&<>"']/g, m => map[m]);
}

// Render view mode (read-only)
function renderViewMode(material, historyData, statusBadgeClass, statusText, volgendeKeuringHtml) {
  const modalBody = document.getElementById('materieelInspectieHistoriekBody');
  
  let historyHtml = `
    <div class="mb-3" id="materialInfoView">
      <strong>Serienummer:</strong> <span id="view-serial">${escapeHtml(material.serial || '')}</span><br>
      <strong>Type:</strong> <span id="view-type">${escapeHtml(material.type || '')}</span><br>
      <strong>Locatie:</strong> <span id="view-locatie">${escapeHtml(material.site || '-')}</span>
    </div>
    <hr>
    <h6>Huidige Status</h6>
    <div class="mb-3">
      <span class="badge ${statusBadgeClass}">
        ${escapeHtml(statusText)}
      </span>
      ${historyData.volgende_keuring_datum ? `
        <div class="mt-2">
          <strong>Volgende keuring:</strong> <span id="view-volgende-keuring">${escapeHtml(historyData.volgende_keuring_datum)}</span>
          ${volgendeKeuringHtml}
        </div>
      ` : ''}
    </div>
    <hr>
    <h6>Inspectie Historiek</h6>
  `;
  
  if (historyData.historiek && historyData.historiek.length > 0) {
    historyHtml += '<div class="list-group">';
    historyData.historiek.forEach(hist => {
      const resultaatBadge = hist.resultaat === 'goedgekeurd' ? 'bg-success' : 
                             hist.resultaat === 'afgekeurd' ? 'bg-danger' : 'bg-warning';
      historyHtml += `
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${escapeHtml(hist.keuring_datum || '')}</strong>
              <span class="badge ${resultaatBadge} ms-2">${escapeHtml(hist.resultaat || '')}</span>
              <br>
              <small class="text-muted">
                Uitgevoerd door: ${escapeHtml(hist.uitgevoerd_door || '')}
                ${hist.volgende_keuring_datum ? ` | Volgende: ${escapeHtml(hist.volgende_keuring_datum)}` : ''}
              </small>
              ${hist.opmerkingen ? `<br><small>${escapeHtml(hist.opmerkingen)}</small>` : ''}
              ${hist.certificaat_url ? `
                <br><a href="${escapeHtml(hist.certificaat_url)}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">
                  <i class="bi bi-file-earmark-text me-1"></i>Certificaat
                </a>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    });
    historyHtml += '</div>';
  } else {
    historyHtml += '<p class="text-muted">Nog geen inspectie historiek beschikbaar.</p>';
  }
  
  modalBody.innerHTML = historyHtml;
}

// Render edit mode (editable form)
function renderEditMode(material, historyData) {
  const modalBody = document.getElementById('materieelInspectieHistoriekBody');
  
  const editHtml = `
    <form id="editMaterialForm">
      <div class="mb-3">
        <label class="form-label"><strong>Serienummer:</strong></label>
        <input type="text" 
               class="form-control" 
               id="edit-serial" 
               value="${escapeHtml(material.serial || '')}" 
               required>
      </div>
      <div class="mb-3">
        <label class="form-label"><strong>Type:</strong></label>
        <input type="text" 
               class="form-control" 
               id="edit-type" 
               value="${escapeHtml(material.type || '')}">
      </div>
      <div class="mb-3">
        <label class="form-label"><strong>Locatie:</strong></label>
        <input type="text" 
               class="form-control" 
               id="edit-locatie" 
               value="${escapeHtml(material.site || '')}">
      </div>
      ${historyData.volgende_keuring_datum ? `
        <div class="mb-3">
          <label class="form-label"><strong>Volgende keuring:</strong></label>
          <input type="date" 
                 class="form-control" 
                 id="edit-volgende-keuring" 
                 value="${escapeHtml(historyData.volgende_keuring_datum || '')}">
        </div>
      ` : ''}
    </form>
  `;
  
  modalBody.innerHTML = editHtml;
}

// Enter edit mode
function enterEditMode() {
  if (!currentMaterialData || !currentHistoryData) {
    alert('Geen materiaal data beschikbaar.');
    return;
  }
  
  isEditMode = true;
  renderEditMode(currentMaterialData, currentHistoryData);
  
  // Show/hide buttons
  document.getElementById('modalBewerkenBtn').style.display = 'none';
  document.getElementById('modalVerwijderenBtn').style.display = 'none';
  document.getElementById('modalSluitenBtn').style.display = 'none';
  document.getElementById('editModeButtons').style.display = 'block';
}

// Exit edit mode
function exitEditMode() {
  isEditMode = false;
  
  // Show/hide buttons
  document.getElementById('modalBewerkenBtn').style.display = 'inline-block';
  document.getElementById('modalVerwijderenBtn').style.display = 'inline-block';
  document.getElementById('modalSluitenBtn').style.display = 'inline-block';
  document.getElementById('editModeButtons').style.display = 'none';
}

// Cancel edit
function cancelEdit() {
  if (!currentMaterialData || !currentHistoryData) {
    return;
  }
  
  // Re-render view mode
  const statusBadgeClass = 'bg-secondary';
  const statusText = currentHistoryData.inspection_status || 'Onbekend';
  const volgendeKeuringHtml = '';
  
  renderViewMode(currentMaterialData, currentHistoryData, statusBadgeClass, statusText, volgendeKeuringHtml);
  exitEditMode();
}

// Save material edit
function saveMaterialEdit() {
  if (!currentMaterialId || !currentMaterialData) {
    alert('Geen materiaal ID beschikbaar.');
    return;
  }
  
  const serial = document.getElementById('edit-serial').value.trim();
  const type = document.getElementById('edit-type').value.trim();
  const locatie = document.getElementById('edit-locatie').value.trim();
  const volgendeKeuring = document.getElementById('edit-volgende-keuring')?.value || null;
  
  if (!serial) {
    alert('Serienummer is verplicht.');
    return;
  }
  
  // Disable save button
  const saveBtn = document.getElementById('modalOpslaanBtn');
  const originalText = saveBtn.textContent;
  saveBtn.disabled = true;
  saveBtn.textContent = 'Opslaan...';
  
  // Prepare update data
  const updateData = {
    serial: serial,
    type: type,
    locatie: locatie
  };
  
  if (volgendeKeuring) {
    updateData.volgende_keuring = volgendeKeuring;
  }
  
  // Send update request
  fetch(`/api/material/${currentMaterialId}/update`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(updateData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert('Fout bij opslaan: ' + data.error);
      saveBtn.disabled = false;
      saveBtn.textContent = originalText;
      return;
    }
    
    // Update local data
    currentMaterialData.serial = serial;
    currentMaterialData.type = type;
    currentMaterialData.site = locatie;
    if (currentHistoryData && volgendeKeuring) {
      currentHistoryData.volgende_keuring_datum = volgendeKeuring;
    }
    
    // Show success message
    showToast('Materiaal succesvol bijgewerkt.', 'success');
    
    // Re-render view mode
    const statusBadgeClass = 'bg-secondary';
    const statusText = currentHistoryData.inspection_status || 'Onbekend';
    const volgendeKeuringHtml = '';
    
    renderViewMode(currentMaterialData, currentHistoryData, statusBadgeClass, statusText, volgendeKeuringHtml);
    exitEditMode();
    
    // Refresh the keuringen table
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  })
  .catch(error => {
    console.error('Error saving material:', error);
    alert('Fout bij opslaan: ' + error.message);
    saveBtn.disabled = false;
    saveBtn.textContent = originalText;
  });
}

// Compute delete target based on available data
function computeDeleteTarget(historyData, material, materialId) {
  // Priority 1: If there's a historiek record, we can delete that
  if (historyData.historiek && historyData.historiek.length > 0) {
    const latestHistoriek = historyData.historiek[0];
    return {
      kind: 'historiek',
      id: latestHistoriek.id,
      materiaalId: materialId
    };
  }
  
  // Priority 2: If there's a planned keuring (volgende_keuring_datum exists)
  // This means there's a keuring_status with volgende_controle set, even if no historiek exists
  const serial = material.serial || historyData.serial;
  if (serial && historyData.volgende_keuring_datum) {
    // Check if there's a planned keuring (volgende_keuring_datum exists)
    // This can happen even without historiek (just a planned inspection)
    return {
      kind: 'planning',
      serienummer: serial
    };
  }
  
  // No deletable target
  return null;
}

// Update delete button state
function updateDeleteButtonState() {
  const deleteBtn = document.getElementById('modalVerwijderenBtn');
  if (!deleteBtn) return;
  
  const canDelete = !!deleteTarget && !isDeleting && !isLoading;
  
  deleteBtn.disabled = !canDelete;
  
  if (!canDelete) {
    if (isLoading) {
      deleteBtn.title = 'Laden...';
    } else if (isDeleting) {
      deleteBtn.title = 'Verwijderen...';
    } else {
      deleteBtn.title = 'Geen keuring om te verwijderen';
    }
  } else {
    deleteBtn.title = '';
  }
}

// Confirm delete keuring
function confirmDeleteMaterial() {
  if (!deleteTarget) {
    alert('Geen keuring om te verwijderen.');
    return;
  }
  
  // Dynamic confirmation message based on target type
  let confirmMessage = '';
  if (deleteTarget.kind === 'historiek') {
    confirmMessage = 'Keuring verwijderen?\n\nDit verwijdert enkel deze uitgevoerde keuring. Het materiaal blijft bestaan.';
  } else if (deleteTarget.kind === 'planning') {
    confirmMessage = 'Geplande keuring verwijderen?\n\nDit verwijdert enkel de planning. Het materiaal blijft bestaan.';
  } else {
    alert('Geen keuring om te verwijderen.');
    return;
  }
  
  if (confirm(confirmMessage)) {
    deleteKeuring();
  }
}

// Delete keuring
function deleteKeuring() {
  if (!deleteTarget) {
    return;
  }
  
  isDeleting = true;
  updateDeleteButtonState();
  
  // Disable delete button
  const deleteBtn = document.getElementById('modalVerwijderenBtn');
  const originalText = deleteBtn.textContent;
  deleteBtn.textContent = 'Verwijderen...';
  
  let apiUrl = '';
  let requestBody = {};
  
  if (deleteTarget.kind === 'historiek') {
    // Delete historiek record
    apiUrl = `/api/keuring/${deleteTarget.id}/delete`;
    requestBody = {
      material_id: deleteTarget.materiaalId
    };
  } else if (deleteTarget.kind === 'planning') {
    // Delete planned keuring (clear planning)
    apiUrl = `/api/keuring/planning/delete`;
    requestBody = {
      serienummer: deleteTarget.serienummer
    };
  } else {
    alert('Geen geldige keuring om te verwijderen.');
    isDeleting = false;
    updateDeleteButtonState();
    return;
  }
  
  // Send delete request
  fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestBody)
  })
  .then(response => response.json())
  .then(data => {
    isDeleting = false;
    
    if (data.error) {
      alert('Fout bij verwijderen: ' + data.error);
      deleteBtn.textContent = originalText;
      updateDeleteButtonState();
      return;
    }
    
    // Show success message
    showToast('Keuring verwijderd.', 'success');
    
    // Reload the modal content to show updated history
    if (currentMaterialData && currentMaterialData.serial && currentMaterialId) {
      // Re-fetch the history
      isLoading = true;
      updateDeleteButtonState();
      
      fetch(`/api/keuring/historiek/${currentMaterialId}`)
        .then(response => response.json())
        .then(historyData => {
          isLoading = false;
          currentHistoryData = historyData;
          
          // Recompute deleteTarget
          deleteTarget = computeDeleteTarget(historyData, currentMaterialData, currentMaterialId);
          updateDeleteButtonState();
          
          // Re-render view mode
          const statusBadgeClass = 'bg-secondary';
          const statusText = historyData.inspection_status || 'Onbekend';
          const volgendeKeuringHtml = '';
          
          renderViewMode(currentMaterialData, historyData, statusBadgeClass, statusText, volgendeKeuringHtml);
          
          // Close modal if no deletable target remains
          if (!deleteTarget) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('materieelInspectieHistoriekModal'));
            if (modal) {
              setTimeout(() => modal.hide(), 1500);
            }
          }
        })
        .catch(error => {
          isLoading = false;
          console.error('Error reloading history:', error);
          updateDeleteButtonState();
        });
    }
    
    // Refresh the keuringen table
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  })
  .catch(error => {
    isDeleting = false;
    console.error('Error deleting keuring:', error);
    alert('Fout bij verwijderen: ' + error.message);
    deleteBtn.textContent = originalText;
    updateDeleteButtonState();
  });
}

// Show toast notification
function showToast(message, type = 'info') {
  // Create toast element
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
  toast.style.zIndex = '9999';
  toast.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  
  document.body.appendChild(toast);
  
  // Auto remove after 3 seconds
  setTimeout(() => {
    if (toast.parentNode) {
      toast.remove();
    }
  }, 3000);
}
</script>

{% endblock %}
