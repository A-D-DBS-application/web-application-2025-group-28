{% extends "base.html" %}
{% block content %}

<div class="section-header">
  <div>
    <h2 class="h-title">Keuringen & Inspecties</h2>
    <div class="h-sub">Registratie en opvolging van materieelkeuringen</div>
  </div>
  <button class="btn btn-dark" 
          style="display: flex; align-items: center; gap: 8px;"
          data-bs-toggle="modal"
          data-bs-target="#nieuweKeuringModal">
    <span style="font-size: 18px; line-height: 1;">+</span>
    <span>Nieuwe Keuring</span>
  </button>
</div>

<!-- Notificaties: Aankomende keuringen binnen 30 dagen -->
{% if binnenkort_verlopen and binnenkort_verlopen|length > 0 %}
<div class="alert alert-warning mt-3" role="alert">
  <strong>‚ö†Ô∏è Aankomende keuringen:</strong> 
  {{ binnenkort_verlopen|length }} item(s) hebben binnen 30 dagen een keuring nodig.
  <ul class="mb-0 mt-2">
    {% for item in binnenkort_verlopen[:5] %}
      <li>
        <strong>{{ item.material.name or 'Onbekend' }}</strong> ({{ item.material.serial }}) 
        - over {{ item.dagen_tot }} dag{% if item.dagen_tot != 1 %}en{% endif %}
      </li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<!-- Items die Keuring Vereisen -->
<div class="card panel" style="margin-top:24px;">
  <div class="panel-title">Items die Keuring Vereisen</div>
  <div class="panel-sub">Materieel met status "keuring verlopen" of "keuring gepland"</div>

  <div class="mt-3">
    {% if afgekeurde_items %}
      {% for item in afgekeurde_items %}
        <div class="card mb-3" style="border: 1px solid #e5e7eb; border-radius: 8px;">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <!-- Naam klikbaar maken om details te tonen -->
                <button type="button"
                        class="btn btn-link p-0 fw-bold text-start"
                        style="text-decoration: none; color: inherit;"
                        onclick="showMaterialDetails('{{ item.serial }}', null)">
                  {{ item.name or 'Onbekend' }}
                </button>
                <small class="text-muted">
                  {{ item.serial }}
                  {% if item.site %}
                    ‚Ä¢ {{ item.site }}
                  {% endif %}
                </small>
              </div>
              <div class="d-flex align-items-center gap-2">
                {% if item.status == "keuring gepland" or (item.status == "in gebruik" and item.inspection_status == "keuring gepland") %}
                  <span class="badge" style="background-color: #a855f7; color: white;">Keuring gepland</span>
                {% else %}
                  <span class="badge bg-warning">Keuring verlopen</span>
                {% endif %}
                <button type="button"
                        class="btn btn-sm btn-dark"
                        data-bs-toggle="modal"
                        data-bs-target="#nieuweKeuringModal"
                        onclick="document.getElementById('keuring-serial').value = '{{ item.serial }}'">
                  Plan Keuring
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="text-center text-muted py-4">
        Geen items gevonden die keuring vereisen
      </div>
    {% endif %}
  </div>
</div>

<!-- Geplande Keuringen -->
<div class="card panel" style="margin-top:24px;">
  <div class="panel-title">Geplande Keuringen</div>
  <div class="panel-sub">Toekomstige keuringen die gepland zijn</div>

  <!-- Table -->
  <div class="table-responsive mt-3">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Materieel</th>
          <th>Geplande Datum</th>
          <th>Uitgevoerd door</th>
          <th>Opmerking</th>
          <th class="text-end">Acties</th>
        </tr>
      </thead>
      <tbody>
        {% if geplande_keuringen %}
          {% for keuring in geplande_keuringen %}
            {% set material = all_materials|selectattr("serial", "equalto", keuring.serienummer)|first %}
            {% set days_until = (keuring.volgende_controle - today).days if keuring.volgende_controle and today else 0 %}
            <tr>
              <td>
                {% if material %}
                  <strong>{{ material.name or 'Onbekend' }}</strong><br>
                  <small class="text-muted">{{ keuring.serienummer }}</small>
                {% else %}
                  <strong>Onbekend materiaal</strong><br>
                  <small class="text-muted">{{ keuring.serienummer }}</small>
                {% endif %}
              </td>
              <td>
                {{ keuring.volgende_controle.strftime('%Y-%m-%d') if keuring.volgende_controle else '-' }}
                {% if days_until > 0 %}
                  <br><small class="text-muted">(over {{ days_until }} dag{% if days_until != 1 %}en{% endif %})</small>
                {% endif %}
              </td>
              <td>{{ keuring.uitgevoerd_door or '-' }}</td>
              <td>{{ keuring.opmerkingen or '-' }}</td>
              <td class="text-end">
                <div class="btn-group">
                  <button type="button" 
                          class="btn btn-sm btn-outline-secondary"
                          data-bs-toggle="modal"
                          data-bs-target="#bewerkKeuringModal"
                          data-keuring-id="{{ keuring.id }}"
                          data-serial="{{ keuring.serienummer or '' }}"
                          data-volgende-datum="{{ keuring.volgende_controle.strftime('%Y-%m-%d') if keuring.volgende_controle else '' }}"
                          data-uitgevoerd-door="{{ keuring.uitgevoerd_door or '' }}"
                          data-opmerking="{{ keuring.opmerkingen or '' }}"
                          onclick="openEditKeuringModal(this)">
                    Bewerken
                  </button>
                  <button type="button" 
                          class="btn btn-sm btn-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#keuringResultaatModal"
                          data-keuring-id="{{ keuring.id }}"
                          onclick="openResultaatModal({{ keuring.id }})">
                    Resultaat invoeren
                  </button>
                  <button type="button" 
                          class="btn btn-sm btn-outline-danger"
                          onclick="verwijderKeuring({{ keuring.id }})">
                    Verwijderen
                  </button>
                </div>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              Nog geen geplande keuringen
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Statistieken Sectie -->
<div class="card panel" style="margin-top:24px;">
  <div class="panel-title">Statistieken & Rapporten</div>
  <div class="panel-sub">Overzicht van keuring activiteit</div>
  
  <div class="row g-3 mt-3">
    <div class="col-md-3">
      <div class="card kpi">
        <div class="kpi-title">Totaal Keuringen</div>
        <div class="kpi-value">{{ total_historiek or 0 }}</div>
        <div class="kpi-sub">Alle uitgevoerde keuringen</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card kpi">
        <div class="kpi-title">Goedgekeurd</div>
        <div class="kpi-value" style="color: #198754;">{{ goedgekeurd_historiek or 0 }}</div>
        <div class="kpi-sub">{{ ((goedgekeurd_historiek / total_historiek * 100) if total_historiek > 0 else 0)|round(1) }}% van totaal</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card kpi">
        <div class="kpi-title">Afgekeurd</div>
        <div class="kpi-value" style="color: #dc3545;">{{ afgekeurd_historiek or 0 }}</div>
        <div class="kpi-sub">{{ ((afgekeurd_historiek / total_historiek * 100) if total_historiek > 0 else 0)|round(1) }}% van totaal</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card kpi">
        <div class="kpi-title">Deze Maand</div>
        <div class="kpi-value">{{ keuringen_deze_maand or 0 }}</div>
        <div class="kpi-sub">Keuringen uitgevoerd</div>
      </div>
    </div>
  </div>
  
  {% if avg_days_between %}
  <div class="mt-3">
    <small class="text-muted">
      Gemiddelde tijd tussen keuringen: {{ avg_days_between|round(0)|int }} dagen
    </small>
  </div>
  {% endif %}
</div>

<!-- Keuringsoverzicht -->
<div class="card panel" style="margin-top:24px;">
  <div class="panel-title">
    Keuringsoverzicht
    {% if filter_serial and filtered_material %}
      <span class="badge bg-info ms-2">Gefilterd: {{ filtered_material.name or filter_serial }}</span>
      <a href="{{ url_for('keuringen') }}" class="btn btn-sm btn-outline-secondary ms-2">Filter wissen</a>
    {% endif %}
  </div>
  <div class="d-flex justify-content-between align-items-center">
    <div class="panel-sub">
      {% if filter_serial %}
        Keuring historiek voor {{ filtered_material.name if filtered_material else filter_serial }}
      {% else %}
        Alle uitgevoerde keuringen en inspecties
      {% endif %}
    </div>
    <a href="{{ url_for('keuringen_export') }}" class="btn btn-sm btn-outline-primary">
      üì• Export CSV
    </a>
  </div>

  <!-- Search and Filter -->
  <div class="row g-2 align-items-center mt-3 mb-3">
    <div class="col-12 col-md-8">
      <div class="input-group">
        <span class="input-group-text">üîç</span>
        <input type="text" 
               id="keuringSearchInput" 
               class="form-control" 
               placeholder="Zoek op materieel of keurder..."
               onkeyup="filterKeuringen()">
      </div>
    </div>
    <div class="col-12 col-md-4">
      <select id="keuringFilterSelect" class="form-select" onchange="filterKeuringen()">
        <option value="">Alle Resultaten</option>
        <option value="goedgekeurd">Goedgekeurd</option>
        <option value="afgekeurd">Afgekeurd</option>
        <option value="voorwaardelijk">Voorwaardelijk</option>
      </select>
    </div>
  </div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table align-middle" id="keuringHistoriekTable">
      <thead>
        <tr>
          <th>Materieel</th>
          <th>Keuringsdatum</th>
          <th>Uitgevoerd door</th>
          <th>Resultaat</th>
          <th>Volgende Keuring</th>
          <th class="text-end">Acties</th>
        </tr>
      </thead>
      <tbody id="keuringHistoriekTbody">
        {% if keuring_historiek and keuring_historiek|length > 0 %}
          {% for hist in keuring_historiek %}
            {% set material = hist.material_obj %}
            <tr class="keuring-row" 
                data-material-name="{{ (material.name if material else '')|lower }}" 
                data-serial="{{ hist.serienummer|lower }}"
                data-uitgevoerd-door="{{ (hist.uitgevoerd_door or '')|lower }}"
                data-resultaat="{{ hist.resultaat|lower }}">
              <td>
                {% if material %}
                  <strong>{{ material.name or 'Onbekend' }}</strong><br>
                  <small class="text-muted">{{ hist.serienummer }}</small>
                {% else %}
                  <strong>Onbekend materiaal</strong><br>
                  <small class="text-muted">{{ hist.serienummer }}</small>
                {% endif %}
              </td>
              <td>{{ hist.keuring_datum.strftime('%Y-%m-%d') if hist.keuring_datum else '-' }}</td>
              <td>{{ hist.uitgevoerd_door or '-' }}</td>
              <td>
                {% if hist.resultaat == 'goedgekeurd' %}
                  <span class="badge bg-success" style="display: inline-flex; align-items: center; gap: 4px;">
                    <span>‚úì</span> Goedgekeurd
                  </span>
                {% elif hist.resultaat == 'afgekeurd' %}
                  <span class="badge bg-danger" style="display: inline-flex; align-items: center; gap: 4px;">
                    <span>‚úó</span> Afgekeurd
                  </span>
                {% elif hist.resultaat == 'voorwaardelijk' %}
                  <span class="badge bg-warning" style="display: inline-flex; align-items: center; gap: 4px;">
                    <span>‚ö†</span> Voorwaardelijk
                  </span>
                {% else %}
                  <span class="badge bg-secondary">{{ hist.resultaat or '-' }}</span>
                {% endif %}
              </td>
              <td>{{ hist.volgende_keuring_datum.strftime('%Y-%m-%d') if hist.volgende_keuring_datum else '-' }}</td>
              <td class="text-end">
                <div class="btn-group">
                  <button type="button" 
                          class="btn btn-sm btn-outline-secondary"
                          data-bs-toggle="modal"
                          data-bs-target="#keuringDetailsModal"
                          data-keuring-id="{{ hist.id }}"
                          onclick="showKeuringDetails({{ hist.id }})">
                    Details
                  </button>
                  <a href="{{ url_for('keuring_dupliceer', historiek_id=hist.id) }}" 
                     class="btn btn-sm btn-outline-primary"
                     onclick="return confirm('Weet je zeker dat je deze keuring wilt dupliceren?');">
                    Dupliceer
                  </a>
                </div>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted py-4">
              Nog geen keuringen uitgevoerd. Historiek wordt automatisch aangemaakt wanneer een keuring wordt uitgevoerd.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal: Nieuwe Keuring -->
<div class="modal fade" id="nieuweKeuringModal" tabindex="-1" aria-labelledby="nieuweKeuringModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="nieuweKeuringModalLabel">Nieuwe Keuring Toevoegen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('keuring_toevoegen') }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Materieel*</label>
              <input name="serial"
                     id="keuring-serial"
                     list="keuring-materiaal-serial"
                     class="form-control"
                     placeholder="Kies of typ een serienummer"
                     required>
              <datalist id="keuring-materiaal-serial">
                {% for m in all_materials %}
                  {% if m.serial %}
                    <option value="{{ m.serial }}">{{ m.name }} ({{ m.serial }})</option>
                  {% endif %}
                {% endfor %}
              </datalist>
              <small class="text-muted">Selecteer het materiaal dat gekeurd moet worden</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Keuring Datum*</label>
              <input type="date"
                     name="keuring_datum"
                     class="form-control"
                     required>
              <small class="text-muted">Datum waarop de keuring plaatsvindt</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Uitgevoerd door*</label>
              <input name="uitgevoerd_door"
                     class="form-control"
                     placeholder="Bv. Keuringsinstantie VIN√áOTTE"
                     value="{{ current_user.Naam if current_user else '' }}"
                     required>
              <small class="text-muted">Wie voert de keuring uit</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="opmerking"
                        class="form-control"
                        rows="3"
                        placeholder="Extra informatie over de keuring..."></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button class="btn btn-primary" type="submit">Keuring Toevoegen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Bewerk Keuring -->
<div class="modal fade" id="bewerkKeuringModal" tabindex="-1" aria-labelledby="bewerkKeuringModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bewerkKeuringModalLabel">Keuring Bewerken</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('keuring_bewerken') }}" id="bewerkKeuringForm">
        <input type="hidden" name="keuring_id" id="edit-keuring-id">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Materieel*</label>
              <input name="serial"
                     id="edit-keuring-serial"
                     class="form-control"
                     readonly>
              <small class="text-muted">Serienummer van het materiaal</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Geplande Datum*</label>
              <input type="date"
                     name="volgende_keuring_datum"
                     id="edit-volgende-keuring-datum"
                     class="form-control"
                     required>
              <small class="text-muted">Datum voor de volgende keuring</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Uitgevoerd door*</label>
              <input name="uitgevoerd_door"
                     id="edit-keuring-uitgevoerd-door"
                     class="form-control"
                     placeholder="Bv. Keuringsinstantie VIN√áOTTE"
                     required>
              <small class="text-muted">Wie voert de keuring uit</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="opmerking"
                        id="edit-keuring-opmerking"
                        class="form-control"
                        rows="3"
                        placeholder="Extra informatie over de keuring..."></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button class="btn btn-primary" type="submit">Wijzigingen Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Keuring Details -->
<div class="modal fade" id="keuringDetailsModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Keuring Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>
      <div class="modal-body" id="keuringDetailsBody">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Laden...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Sluiten</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Keuring Resultaat Invoeren -->
<div class="modal fade" id="keuringResultaatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Keuring Resultaat Invoeren</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('keuring_resultaat') }}" enctype="multipart/form-data">
        <input type="hidden" name="keuring_id" id="resultaat-keuring-id">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Resultaat*</label>
              <select name="resultaat" id="resultaat-select" class="form-select" required>
                <option value="">Selecteer resultaat</option>
                <option value="goedgekeurd">Goedgekeurd</option>
                <option value="afgekeurd">Afgekeurd</option>
                <option value="voorwaardelijk">Voorwaardelijk</option>
              </select>
              <small class="text-muted">Wat is het resultaat van de keuring?</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Keuring Datum*</label>
              <input type="date"
                     name="keuring_datum"
                     id="resultaat-keuring-datum"
                     class="form-control"
                     required>
              <small class="text-muted">Wanneer is de keuring uitgevoerd?</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Uitgevoerd door*</label>
              <input name="uitgevoerd_door"
                     id="resultaat-uitgevoerd-door"
                     class="form-control"
                     placeholder="Bv. Keuringsinstantie VIN√áOTTE"
                     value="{{ current_user.Naam if current_user else '' }}"
                     required>
              <small class="text-muted">Wie heeft de keuring uitgevoerd?</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Volgende Keuring Datum (optioneel)</label>
              <input type="date"
                     name="volgende_keuring_datum"
                     id="resultaat-volgende-keuring-datum"
                     class="form-control">
              <small class="text-muted">Wanneer moet de volgende keuring plaatsvinden? (Laat leeg voor standaard 6 maanden)</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Certificaat (optioneel)</label>
              <input type="file"
                     name="certificaat"
                     id="resultaat-certificaat"
                     class="form-control"
                     accept=".pdf,.jpg,.jpeg,.png">
              <small class="text-muted">Upload het keuringscertificaat (PDF of afbeelding)</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="opmerking"
                        id="resultaat-opmerking"
                        class="form-control"
                        rows="3"
                        placeholder="Extra informatie over de keuring..."></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button class="btn btn-primary" type="submit">Resultaat Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Materieel Details -->
<div class="modal fade" id="materieelDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="details-material-name">Materieel Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>
      <div class="modal-body" id="materieelDetailsBody">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Laden...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Sluiten</button>
        <a href="#" id="details-edit-link" class="btn btn-primary" style="display: none;">Bewerken</a>
      </div>
    </div>
  </div>
</div>

<script>
// Algemene cleanup functie voor modals - voorkomt achtergebleven backdrops
function cleanupModals() {
  const backdrops = document.querySelectorAll('.modal-backdrop');
  backdrops.forEach(backdrop => backdrop.remove());
  document.body.classList.remove('modal-open');
  document.body.style.overflow = '';
  document.body.style.paddingRight = '';
}

// Voer cleanup uit bij page load
document.addEventListener('DOMContentLoaded', function() {
  cleanupModals();
  
  // Voeg event listeners toe aan alle modals voor cleanup
  const allModals = document.querySelectorAll('.modal');
  allModals.forEach(modal => {
    modal.addEventListener('hidden.bs.modal', function() {
      cleanupModals();
    });
  });
});

// Function to show material details
window.showMaterialDetails = function(serial, usageId) {
  const modal = new bootstrap.Modal(document.getElementById('materieelDetailsModal'));
  const modalBody = document.getElementById('materieelDetailsBody');
  const modalTitle = document.getElementById('details-material-name');
  const editLink = document.getElementById('details-edit-link');
  
  modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Laden...</span></div></div>';
  modal.show();
  
  fetch(`/api/search?q=${encodeURIComponent(serial)}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      if (data.items && data.items.length > 0) {
        const item = data.items[0];
        const isInUse = item.status === 'in gebruik';
        const statusClass = isInUse ? 'bg-success' : 'bg-danger';
        const statusText = isInUse ? 'In gebruik' : 'Niet in gebruik';
        
        // Keuring: based on original status (goedgekeurd/afgekeurd/keuring verlopen/keuring gepland)
        // If status is "in gebruik", check inspection_status for the original keuring status
        let keuringStatus = item.status;
        if (item.status === 'in gebruik' && item.inspection_status) {
          keuringStatus = item.inspection_status;
        }
        
        // Determine badge class and text based on keuring status
        let keuringClass = 'bg-secondary';
        let keuringText = 'Onbekend';
        
        if (keuringStatus === 'goedgekeurd') {
          keuringClass = 'bg-success';
          keuringText = 'Goedgekeurd';
        } else if (keuringStatus === 'afgekeurd') {
          keuringClass = 'bg-danger';
          keuringText = 'Afgekeurd';
        } else if (keuringStatus === 'keuring verlopen') {
          keuringClass = 'bg-warning';
          keuringText = 'Keuring verlopen';
        } else if (keuringStatus === 'keuring gepland') {
          keuringClass = '';
          keuringText = 'Keuring gepland';
        } else if (item.status === 'in gebruik') {
          // Default to goedgekeurd when in gebruik and no inspection_status
          keuringClass = 'bg-success';
          keuringText = 'Goedgekeurd';
        }
        
        // Create badge HTML for keuring status (white background with colored border and black text)
        let keuringBadgeHtml = '';
        let badgeStyle = '';
        
        if (keuringStatus === 'goedgekeurd') {
          badgeStyle = 'background-color: white; color: #212529; border: 1px solid #198754;';
        } else if (keuringStatus === 'afgekeurd') {
          badgeStyle = 'background-color: white; color: #212529; border: 1px solid #dc3545;';
        } else if (keuringStatus === 'keuring verlopen') {
          badgeStyle = 'background-color: white; color: #212529; border: 1px solid #ffc107;';
        } else if (keuringStatus === 'keuring gepland') {
          badgeStyle = 'background-color: white; color: #212529; border: 1px solid #a855f7;';
        } else {
          // Default to goedgekeurd style
          badgeStyle = 'background-color: white; color: #212529; border: 1px solid #198754;';
        }
        
        if (item.keuring_gepland) {
          keuringBadgeHtml = `<span class="badge" style="${badgeStyle}">Keuring gepland: ${escapeHtml(item.keuring_gepland)}</span>`;
        } else {
          keuringBadgeHtml = `<span class="badge" style="${badgeStyle}">${escapeHtml(keuringText)}</span>`;
        }
        
        const displayValue = (value) => value && value.trim() !== '' ? escapeHtml(value) : 'onbekend';
        
        modalTitle.textContent = escapeHtml(item.name || 'Onbekend');
        
        modalBody.innerHTML = `
          <div class="material-detail">
            <div class="mb-3">
              <strong>Serienummer:</strong> ${displayValue(item.serial)}
            </div>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <strong>Type:</strong><br>
                ${displayValue(item.type)}
              </div>
              <div class="col-md-6">
                <strong>Status:</strong><br>
                <span class="badge ${statusClass}">${escapeHtml(statusText)}</span>
              </div>
              <div class="col-md-6">
                <strong>Keuring:</strong><br>
                ${keuringBadgeHtml}
                ${item.laatste_keuring ? `
                  <br><small class="text-muted">Laatste keuring: ${escapeHtml(item.laatste_keuring)}</small>
                ` : ''}
              </div>
              <div class="col-md-6">
                <strong>Toegewezen aan:</strong><br>
                ${displayValue(item.assigned_to)}
              </div>
              <div class="col-md-6">
                <strong>Werf:</strong><br>
                ${displayValue(item.site)}
              </div>
              <div class="col-md-6">
                <strong>Aankoopdatum:</strong><br>
                ${displayValue(item.purchase_date)}
              </div>
            </div>
            <div class="mb-3">
              <strong>Opmerking:</strong><br>
              ${displayValue(item.note)}
            </div>
          </div>
        `;
        
        // Set edit link
        if (editLink) {
          editLink.href = `/materiaal?q=${encodeURIComponent(item.serial)}`;
          editLink.style.display = 'inline-block';
        }
      } else {
        modalBody.innerHTML = '<div class="alert alert-warning">Item niet gevonden.</div>';
      }
    })
    .catch(error => {
      console.error('Error loading material detail:', error);
      modalBody.innerHTML = '<div class="alert alert-danger">Er is een fout opgetreden bij het laden van de details.</div>';
    });
};

  // Function to open edit keuring modal
  window.openEditKeuringModal = function(button) {
    const keuringId = button.getAttribute('data-keuring-id');
    const serial = button.getAttribute('data-serial') || '';
    const volgendeDatum = button.getAttribute('data-volgende-datum') || '';
    const uitgevoerdDoor = button.getAttribute('data-uitgevoerd-door') || '';
    const opmerking = button.getAttribute('data-opmerking') || '';
    
    document.getElementById('edit-keuring-id').value = keuringId || '';
    document.getElementById('edit-keuring-serial').value = serial;
    document.getElementById('edit-volgende-keuring-datum').value = volgendeDatum;
    document.getElementById('edit-keuring-uitgevoerd-door').value = uitgevoerdDoor;
    document.getElementById('edit-keuring-opmerking').value = opmerking;
  };

  function escapeHtml(text) {
    if (!text) return '';
    const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

  // Function to open resultaat modal
  window.openResultaatModal = function(keuringId) {
    document.getElementById('resultaat-keuring-id').value = keuringId || '';
    // Set today's date as default voor keuring datum
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('resultaat-keuring-datum').value = today;
    
    // Set default volgende keuring (6 maanden later)
    const sixMonthsLater = new Date();
    sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
    const nextDate = sixMonthsLater.toISOString().split('T')[0];
    document.getElementById('resultaat-volgende-keuring-datum').value = nextDate;
  };

  // Function to show keuring details
  window.showKeuringDetails = function(historiekId) {
    const modalElement = document.getElementById('keuringDetailsModal');
    const modalBody = document.getElementById('keuringDetailsBody');
    
    // Verwijder eventuele achtergebleven backdrops eerst
    cleanupModals();
    
    // Maak nieuwe modal instance of gebruik bestaande
    let modal = bootstrap.Modal.getInstance(modalElement);
    if (!modal) {
      modal = new bootstrap.Modal(modalElement);
    }
    
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Laden...</span></div></div>';
    modal.show();
    
    // Fetch keuring details via API
    fetch(`/api/keuring/${historiekId}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        
        const displayValue = (value) => value && value !== '-' ? escapeHtml(value) : '<span class="text-muted">-</span>';
        
        modalBody.innerHTML = `
          <div class="keuring-detail">
            <div class="mb-3">
              <strong>Materieel:</strong><br>
              ${displayValue(data.material_name)}<br>
              <small class="text-muted">Serienummer: ${displayValue(data.serial)}</small>
            </div>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <strong>Keuringsdatum:</strong><br>
                ${displayValue(data.keuring_datum)}
              </div>
              <div class="col-md-6">
                <strong>Resultaat:</strong><br>
                ${data.resultaat_badge}
              </div>
              <div class="col-md-6">
                <strong>Uitgevoerd door:</strong><br>
                ${displayValue(data.uitgevoerd_door)}
              </div>
              <div class="col-md-6">
                <strong>Volgende Keuring:</strong><br>
                ${displayValue(data.volgende_keuring_datum)}
              </div>
            </div>
            <div class="mb-3">
              <strong>Opmerkingen:</strong><br>
              ${displayValue(data.opmerkingen)}
            </div>
            ${data.certificaat_path ? `
              <div class="mb-3">
                <strong>Certificaat:</strong><br>
                <a href="/static/${escapeHtml(data.certificaat_path)}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                  üìÑ Bekijk certificaat
                </a>
                <a href="/static/${escapeHtml(data.certificaat_path)}" download class="btn btn-sm btn-outline-secondary">
                  ‚¨áÔ∏è Download
                </a>
              </div>
            ` : ''}
            <div class="text-muted small">
              <strong>Geregistreerd op:</strong> ${displayValue(data.created_at)}
            </div>
          </div>
        `;
      })
      .catch(error => {
        console.error('Error loading keuring detail:', error);
        modalBody.innerHTML = '<div class="alert alert-danger">Er is een fout opgetreden bij het laden van de keuring details.</div>';
      });
  };

  // Function to verwijder keuring
  window.verwijderKeuring = function(keuringId) {
    if (!confirm('Weet je zeker dat je deze keuring wilt verwijderen?')) {
      return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("keuring_verwijderen") }}';
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'keuring_id';
    input.value = keuringId;
    form.appendChild(input);
    
    document.body.appendChild(form);
    form.submit();
  };

  // Function to filter keuringen
  window.filterKeuringen = function() {
    const searchInput = document.getElementById('keuringSearchInput');
    const filterSelect = document.getElementById('keuringFilterSelect');
    const rows = document.querySelectorAll('.keuring-row');
    
    const searchTerm = (searchInput.value || '').toLowerCase();
    const filterValue = (filterSelect.value || '').toLowerCase();
    
    rows.forEach(row => {
      const materialName = row.getAttribute('data-material-name') || '';
      const serial = row.getAttribute('data-serial') || '';
      const uitgevoerdDoor = row.getAttribute('data-uitgevoerd-door') || '';
      const resultaat = row.getAttribute('data-resultaat') || '';
      
      // Check search term
      const matchesSearch = !searchTerm || 
        materialName.includes(searchTerm) || 
        serial.includes(searchTerm) || 
        uitgevoerdDoor.includes(searchTerm);
      
      // Check filter
      const matchesFilter = !filterValue || resultaat === filterValue;
      
      // Show/hide row
      if (matchesSearch && matchesFilter) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  };
</script>

{% endblock %}
