{% extends "base.html" %}
{% block content %}

<div class="section-header">
  <div>
    <h2 class="h-title">Keuringen & Inspecties</h2>
    <div class="h-sub">Registratie en opvolging van materieelkeuringen</div>
  </div>
  <button class="btn btn-dark" 
          style="display: flex; align-items: center; gap: 8px;"
          data-bs-toggle="modal"
          data-bs-target="#nieuweKeuringModal">
    <span style="font-size: 18px; line-height: 1;">+</span>
    <span>Nieuwe Keuring</span>
  </button>
</div>

<!-- Items die Keuring Vereisen -->
<div class="card panel" style="margin-top:24px;">
  <div class="panel-title">Items die Keuring Vereisen</div>
  <div class="panel-sub">Materieel met status "keuring verlopen"</div>

  <div class="mt-3">
    {% if afgekeurde_items %}
      {% for item in afgekeurde_items %}
        <div class="card mb-3" style="border: 1px solid #e5e7eb; border-radius: 8px;">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <!-- Naam klikbaar maken om details te tonen -->
                <button type="button"
                        class="btn btn-link p-0 fw-bold text-start"
                        style="text-decoration: none; color: inherit;"
                        onclick="showMaterialDetails('{{ item.serial }}', null)">
                  {{ item.name or 'Onbekend' }}
                </button>
                <small class="text-muted">
                  {{ item.serial }}
                  {% if item.site %}
                    ‚Ä¢ {{ item.site }}
                  {% endif %}
                </small>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-warning">Keuring verlopen</span>
                <button type="button"
                        class="btn btn-sm btn-dark"
                        data-bs-toggle="modal"
                        data-bs-target="#nieuweKeuringModal"
                        onclick="document.getElementById('keuring-serial').value = '{{ item.serial }}'">
                  Plan Keuring
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="text-center text-muted py-4">
        Geen items met keuring verlopen gevonden
      </div>
    {% endif %}
  </div>
</div>

<!-- Geplande Keuringen -->
<div class="card panel" style="margin-top:24px;">
  <div class="panel-title">Geplande Keuringen</div>
  <div class="panel-sub">Toekomstige keuringen die gepland zijn</div>

  <!-- Table -->
  <div class="table-responsive mt-3">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Materieel</th>
          <th>Geplande Datum</th>
          <th>Uitgevoerd door</th>
          <th>Opmerking</th>
          <th class="text-end">Acties</th>
        </tr>
      </thead>
      <tbody>
        {% if geplande_keuringen %}
          {% for keuring in geplande_keuringen %}
            {% set material = all_materials|selectattr("serial", "equalto", keuring.serienummer)|first %}
            {% set days_until = (keuring.volgende_controle - today).days if keuring.volgende_controle and today else 0 %}
            <tr>
              <td>
                {% if material %}
                  <strong>{{ material.name or 'Onbekend' }}</strong><br>
                  <small class="text-muted">{{ keuring.serienummer }}</small>
                {% else %}
                  <strong>Onbekend materiaal</strong><br>
                  <small class="text-muted">{{ keuring.serienummer }}</small>
                {% endif %}
              </td>
              <td>
                {{ keuring.volgende_controle.strftime('%Y-%m-%d') if keuring.volgende_controle else '-' }}
                {% if days_until > 0 %}
                  <br><small class="text-muted">(over {{ days_until }} dag{% if days_until != 1 %}en{% endif %})</small>
                {% endif %}
              </td>
              <td>{{ keuring.uitgevoerd_door or '-' }}</td>
              <td>{{ keuring.opmerkingen or '-' }}</td>
              <td class="text-end">
                <button type="button" 
                        class="btn btn-sm btn-outline-secondary"
                        data-bs-toggle="modal"
                        data-bs-target="#bewerkKeuringModal"
                        data-keuring-id="{{ keuring.id }}"
                        data-serial="{{ keuring.serienummer or '' }}"
                        data-volgende-datum="{{ keuring.volgende_controle.strftime('%Y-%m-%d') if keuring.volgende_controle else '' }}"
                        data-uitgevoerd-door="{{ keuring.uitgevoerd_door or '' }}"
                        data-opmerking="{{ keuring.opmerkingen or '' }}"
                        onclick="openEditKeuringModal(this)">
                  Bewerken
                </button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              Nog geen geplande keuringen
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Keuringsoverzicht -->
<div class="card panel" style="margin-top:24px;">
  <div class="panel-title">Keuringsoverzicht</div>
  <div class="panel-sub">Alle uitgevoerde keuringen en inspecties</div>

  <!-- Search and Filter -->
  <div class="row g-2 align-items-center mt-3 mb-3">
    <div class="col-12 col-md-8">
      <div class="input-group">
        <span class="input-group-text">üîç</span>
        <input type="text" class="form-control" placeholder="Zoek op materieel of keurder...">
      </div>
    </div>
    <div class="col-12 col-md-4">
      <select class="form-select">
        <option>Alle Resultaten</option>
        <option>Goedgekeurd</option>
        <option>Afgekeurd</option>
        <option>Te Keuren</option>
      </select>
    </div>
  </div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Materieel</th>
          <th>Keuringsdatum</th>
          <th>Uitgevoerd door</th>
          <th>Resultaat</th>
          <th>Volgende Keuring</th>
          <th class="text-end">Acties</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <strong>Boormachine Bosch GBH 2-28</strong><br>
            <small class="text-muted">BH-2024-001</small>
          </td>
          <td>2024-09-15</td>
          <td>Keuringsinstantie VIN√áOTTE</td>
          <td>
            <span class="badge bg-dark" style="display: inline-flex; align-items: center; gap: 4px;">
              <span style="color: #10b981;">‚úì</span> Goedgekeurd
            </span>
          </td>
          <td>2025-03-15</td>
          <td class="text-end">
            <div class="btn-group">
              <a href="#" class="btn btn-sm btn-outline-secondary">Details bekijken</a>
              <a href="#" class="btn btn-sm btn-outline-secondary">Certificaat</a>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal: Nieuwe Keuring -->
<div class="modal fade" id="nieuweKeuringModal" tabindex="-1" aria-labelledby="nieuweKeuringModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="nieuweKeuringModalLabel">Nieuwe Keuring Toevoegen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('keuring_toevoegen') }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Materieel*</label>
              <input name="serial"
                     id="keuring-serial"
                     list="keuring-materiaal-serial"
                     class="form-control"
                     placeholder="Kies of typ een serienummer"
                     required>
              <datalist id="keuring-materiaal-serial">
                {% for m in all_materials %}
                  {% if m.serial %}
                    <option value="{{ m.serial }}">{{ m.name }} ({{ m.serial }})</option>
                  {% endif %}
                {% endfor %}
              </datalist>
              <small class="text-muted">Selecteer het materiaal dat gekeurd moet worden</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Keuring Datum*</label>
              <input type="date"
                     name="keuring_datum"
                     class="form-control"
                     required>
              <small class="text-muted">Datum waarop de keuring plaatsvindt</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Uitgevoerd door*</label>
              <input name="uitgevoerd_door"
                     class="form-control"
                     placeholder="Bv. Keuringsinstantie VIN√áOTTE"
                     value="{{ current_user.Naam if current_user else '' }}"
                     required>
              <small class="text-muted">Wie voert de keuring uit</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="opmerking"
                        class="form-control"
                        rows="3"
                        placeholder="Extra informatie over de keuring..."></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button class="btn btn-primary" type="submit">Keuring Toevoegen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Bewerk Keuring -->
<div class="modal fade" id="bewerkKeuringModal" tabindex="-1" aria-labelledby="bewerkKeuringModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-end modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bewerkKeuringModalLabel">Keuring Bewerken</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>

      <form method="post" action="{{ url_for('keuring_bewerken') }}" id="bewerkKeuringForm">
        <input type="hidden" name="keuring_id" id="edit-keuring-id">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Materieel*</label>
              <input name="serial"
                     id="edit-keuring-serial"
                     class="form-control"
                     readonly>
              <small class="text-muted">Serienummer van het materiaal</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Geplande Datum*</label>
              <input type="date"
                     name="volgende_keuring_datum"
                     id="edit-volgende-keuring-datum"
                     class="form-control"
                     required>
              <small class="text-muted">Datum voor de volgende keuring</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Uitgevoerd door*</label>
              <input name="uitgevoerd_door"
                     id="edit-keuring-uitgevoerd-door"
                     class="form-control"
                     placeholder="Bv. Keuringsinstantie VIN√áOTTE"
                     required>
              <small class="text-muted">Wie voert de keuring uit</small>
            </div>

            <div class="col-md-12">
              <label class="form-label">Opmerking (optioneel)</label>
              <textarea name="opmerking"
                        id="edit-keuring-opmerking"
                        class="form-control"
                        rows="3"
                        placeholder="Extra informatie over de keuring..."></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button class="btn btn-primary" type="submit">Wijzigingen Opslaan</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Materieel Details -->
<div class="modal fade" id="materieelDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="details-material-name">Materieel Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>
      <div class="modal-body" id="materieelDetailsBody">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Laden...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Sluiten</button>
        <a href="#" id="details-edit-link" class="btn btn-primary" style="display: none;">Bewerken</a>
      </div>
    </div>
  </div>
</div>

<script>
// Function to show material details
window.showMaterialDetails = function(serial, usageId) {
  const modal = new bootstrap.Modal(document.getElementById('materieelDetailsModal'));
  const modalBody = document.getElementById('materieelDetailsBody');
  const modalTitle = document.getElementById('details-material-name');
  const editLink = document.getElementById('details-edit-link');
  
  modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Laden...</span></div></div>';
  modal.show();
  
  fetch(`/api/search?q=${encodeURIComponent(serial)}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      if (data.items && data.items.length > 0) {
        const item = data.items[0];
        const isInUse = item.status === 'in gebruik';
        const statusClass = isInUse ? 'bg-success' : 'bg-danger';
        const statusText = isInUse ? 'In gebruik' : 'Niet in gebruik';
        
        // Keuring: based on original status (goedgekeurd/afgekeurd/keuring verlopen/keuring gepland)
        // If status is "in gebruik", check inspection_status for the original keuring status
        let keuringStatus = item.status;
        if (item.status === 'in gebruik' && item.inspection_status) {
          keuringStatus = item.inspection_status;
        }
        
        // Determine badge class and text based on keuring status
        let keuringClass = 'bg-secondary';
        let keuringText = 'Onbekend';
        
        if (keuringStatus === 'goedgekeurd') {
          keuringClass = 'bg-success';
          keuringText = 'Goedgekeurd';
        } else if (keuringStatus === 'afgekeurd') {
          keuringClass = 'bg-danger';
          keuringText = 'Afgekeurd';
        } else if (keuringStatus === 'keuring verlopen') {
          keuringClass = 'bg-warning';
          keuringText = 'Keuring verlopen';
        } else if (keuringStatus === 'keuring gepland') {
          keuringClass = '';
          keuringText = 'Keuring gepland';
        } else if (item.status === 'in gebruik') {
          // Default to goedgekeurd when in gebruik and no inspection_status
          keuringClass = 'bg-success';
          keuringText = 'Goedgekeurd';
        }
        
        // Create badge HTML for keuring status (white background with colored border and black text)
        let keuringBadgeHtml = '';
        let badgeStyle = '';
        
        if (keuringStatus === 'goedgekeurd') {
          badgeStyle = 'background-color: white; color: #212529; border: 1px solid #198754;';
        } else if (keuringStatus === 'afgekeurd') {
          badgeStyle = 'background-color: white; color: #212529; border: 1px solid #dc3545;';
        } else if (keuringStatus === 'keuring verlopen') {
          badgeStyle = 'background-color: white; color: #212529; border: 1px solid #ffc107;';
        } else if (keuringStatus === 'keuring gepland') {
          badgeStyle = 'background-color: white; color: #212529; border: 1px solid #a855f7;';
        } else {
          // Default to goedgekeurd style
          badgeStyle = 'background-color: white; color: #212529; border: 1px solid #198754;';
        }
        
        if (item.keuring_gepland) {
          keuringBadgeHtml = `<span class="badge" style="${badgeStyle}">Keuring gepland: ${escapeHtml(item.keuring_gepland)}</span>`;
        } else {
          keuringBadgeHtml = `<span class="badge" style="${badgeStyle}">${escapeHtml(keuringText)}</span>`;
        }
        
        const displayValue = (value) => value && value.trim() !== '' ? escapeHtml(value) : 'onbekend';
        
        modalTitle.textContent = escapeHtml(item.name || 'Onbekend');
        
        modalBody.innerHTML = `
          <div class="material-detail">
            <div class="mb-3">
              <strong>Serienummer:</strong> ${displayValue(item.serial)}
            </div>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <strong>Type:</strong><br>
                ${displayValue(item.type)}
              </div>
              <div class="col-md-6">
                <strong>Status:</strong><br>
                <span class="badge ${statusClass}">${escapeHtml(statusText)}</span>
              </div>
              <div class="col-md-6">
                <strong>Keuring:</strong><br>
                ${keuringBadgeHtml}
                ${item.laatste_keuring ? `
                  <br><small class="text-muted">Laatste keuring: ${escapeHtml(item.laatste_keuring)}</small>
                ` : ''}
              </div>
              <div class="col-md-6">
                <strong>Toegewezen aan:</strong><br>
                ${displayValue(item.assigned_to)}
              </div>
              <div class="col-md-6">
                <strong>Werf:</strong><br>
                ${displayValue(item.site)}
              </div>
              <div class="col-md-6">
                <strong>Aankoopdatum:</strong><br>
                ${displayValue(item.purchase_date)}
              </div>
            </div>
            <div class="mb-3">
              <strong>Opmerking:</strong><br>
              ${displayValue(item.note)}
            </div>
          </div>
        `;
        
        // Set edit link
        if (editLink) {
          editLink.href = `/materiaal?q=${encodeURIComponent(item.serial)}`;
          editLink.style.display = 'inline-block';
        }
      } else {
        modalBody.innerHTML = '<div class="alert alert-warning">Item niet gevonden.</div>';
      }
    })
    .catch(error => {
      console.error('Error loading material detail:', error);
      modalBody.innerHTML = '<div class="alert alert-danger">Er is een fout opgetreden bij het laden van de details.</div>';
    });
};

  // Function to open edit keuring modal
  window.openEditKeuringModal = function(button) {
    const keuringId = button.getAttribute('data-keuring-id');
    const serial = button.getAttribute('data-serial') || '';
    const volgendeDatum = button.getAttribute('data-volgende-datum') || '';
    const uitgevoerdDoor = button.getAttribute('data-uitgevoerd-door') || '';
    const opmerking = button.getAttribute('data-opmerking') || '';
    
    document.getElementById('edit-keuring-id').value = keuringId || '';
    document.getElementById('edit-keuring-serial').value = serial;
    document.getElementById('edit-volgende-keuring-datum').value = volgendeDatum;
    document.getElementById('edit-keuring-uitgevoerd-door').value = uitgevoerdDoor;
    document.getElementById('edit-keuring-opmerking').value = opmerking;
  };

  function escapeHtml(text) {
    if (!text) return '';
    const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}
</script>

{% endblock %}
