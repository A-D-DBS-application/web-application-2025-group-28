{% extends "base.html" %}
{% block content %}

<div class="section-header">
  <div>
    <h2 class="h-title">{{ project.name or 'Werf ' ~ project.id }}</h2>
    <div class="h-sub">
      {{ project.address or 'Adres onbekend' }}
    </div>
  </div>

  <a href="{{ url_for('werven.werven') }}" class="btn btn-outline-secondary">
    ‚Üê Terug naar werven
  </a>
</div>

<div class="row g-3 mt-1">
  <!-- Project details + bewerken -->
  <div class="col-12 col-lg-5">
    <div class="card panel h-100">
      <div class="panel-title">Werfgegevens</div>
      <div class="panel-sub">Bekijk en wijzig de basisgegevens van deze werf</div>

      <div class="mt-3">
        {% if project.image_url %}
          <div class="mb-3">
            {% set image_url = get_file_url(project.image_url) or url_for('static', filename=project.image_url) %}
            <img src="{{ image_url }}"
                 alt="Werf afbeelding"
                 class="img-cover-rounded">
          </div>
        {% endif %}

        <form method="post"
              action="{{ url_for('werven.werf_bewerken', project_id=project.id) }}"
              enctype="multipart/form-data">
          <div class="mb-2">
            <label class="form-label">Naam werf*</label>
            <input name="name" class="form-control" required value="{{ project.name }}">
          </div>
          <div class="mb-2">
            <label class="form-label">Type / omschrijving</label>
            <input name="type" class="form-control" value="{{ project.type or '' }}">
          </div>
          <div class="mb-2">
            <label class="form-label">Adres</label>
            <input name="address" class="form-control" value="{{ project.address or '' }}">
          </div>
          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="form-label">Startdatum*</label>
              <input type="date"
                     name="start_date"
                     class="form-control"
                     required
                     value="{{ project.start_date.strftime('%Y-%m-%d') if project.start_date else '' }}">
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label">Einddatum</label>
              <input type="date"
                     name="end_date"
                     class="form-control"
                     value="{{ project.end_date.strftime('%Y-%m-%d') if project.end_date else '' }}">
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label">Afbeelding (nieuw bestand)</label>
            <input name="image_file" type="file" accept="image/*" class="form-control">
            {% if project.image_url %}
              <small class="text-muted">Huidige afbeelding blijft behouden als je hier niets kiest.</small>
            {% endif %}
          </div>
          <div class="mb-3">
            <label class="form-label">Opmerking</label>
            <textarea name="note" class="form-control" rows="3">{{ project.note or '' }}</textarea>
          </div>

          {% set is_started = project.start_date and project.start_date <= today %}
          {% if project.start_date and project.start_date > today %}
            {% set days_to_start = (project.start_date - today).days %}
            <div class="alert alert-secondary py-2 small">
              Deze werf is nog niet gestart. Start op
              {{ project.start_date.strftime('%Y-%m-%d') }}
              (over {{ days_to_start }} dag{% if days_to_start != 1 %}en{% endif %}).
            </div>
          {% endif %}

          <button class="btn btn-primary" type="submit">Wijzigingen opslaan</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Materiaal op deze werf -->
  <div class="col-12 col-lg-7">
    <!-- Actief materiaal -->
    <div class="card panel mb-3">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="panel-title">Materiaal in gebruik op deze werf</div>
          <div class="panel-sub">Actieve sessies gelinkt aan dit project</div>
        </div>
        {% if active_usages %}
        <a href="{{ url_for('werven.werf_export_materiaal', project_id=project.id) }}" class="btn btn-sm btn-outline-primary">
          üì• Export CSV
        </a>
        {% endif %}
      </div>

      {% if active_usages %}
        <div class="table-responsive mt-2">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th>Serienummer</th>
                <th>Naam</th>
                <th>Gebruikt door</th>
                <th>In gebruik sinds</th>
                <th class="text-end">Acties</th>
              </tr>
            </thead>
            <tbody>
              {% for usage, mat in active_usages %}
                <tr>
                  <td>{{ mat.serial }}</td>
                  <td>{{ mat.name }}</td>
                  <td>{{ usage.used_by or '-' }}</td>
                  <td>
                    {% if usage.start_time %}
                      {{ usage.start_time.strftime("%Y-%m-%d %H:%M") }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <div class="btn-group" role="group">
                      {% if other_projects %}
                      <button type="button"
                              class="btn btn-sm btn-outline-primary"
                              data-bs-toggle="modal"
                              data-bs-target="#switchWerfModal"
                              data-usage-id="{{ usage.id }}"
                              data-mat-name="{{ mat.name }}"
                              data-mat-serial="{{ mat.serial }}">
                        Wissel van werf
                      </button>
                      {% endif %}
                      {% set is_own = current_user and current_user.Naam and usage.used_by and usage.used_by.lower() == current_user.Naam.lower() %}
                      {% if is_own or (current_user and current_user.is_admin) %}
                      <form method="post"
                            action="{{ url_for('werven.werf_stop_gebruik', project_id=project.id) }}"
                            class="d-inline"
                            onsubmit="return confirm('Materiaal niet meer in gebruik zetten op deze werf?');">
                        <input type="hidden" name="usage_id" value="{{ usage.id }}">
                        <button class="btn btn-sm btn-outline-secondary">
                          Niet meer gebruiken
                        </button>
                      </form>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-muted mt-2">
          Nog geen materiaal in gebruik op deze werf.
        </div>
      {% endif %}
    </div>

    <!-- Materiaal koppelen -->
    <div class="card panel mb-3">
      <div class="panel-title">Materiaal koppelen aan deze werf</div>
      <div class="panel-sub">Neem nieuw materiaal in gebruik rechtstreeks op deze werf</div>

      <form class="mt-2" method="post" action="{{ url_for('werven.werf_materiaal_gebruiken', project_id=project.id) }}">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Naam*</label>
            <input name="name"
                   list="werf-materiaal-namen"
                   class="form-control"
                   placeholder="Kies of typ een naam">
            <datalist id="werf-materiaal-namen">
              {# Eerst materialen die NIET in gebruik zijn #}
              {% for m in all_materials %}
                {% if m.name and m.id not in active_material_ids %}
                  <option value="{{ m.name }}">{{ m.name }}</option>
                {% endif %}
              {% endfor %}
              {# Dan materialen die WEL in gebruik zijn (onderaan) #}
              {% for m in all_materials %}
                {% if m.name and m.id in active_material_ids %}
                  <option value="{{ m.name }} (in gebruik)">{{ m.name }}</option>
                {% endif %}
              {% endfor %}
            </datalist>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nummer op materieel</label>
            <input name="nummer_op_materieel" class="form-control" placeholder="Sticker / nummer op toestel">
          </div>
          <div class="col-md-6">
            <label class="form-label">Gebruikt door</label>
            <input name="assigned_to"
                   class="form-control"
                   value="{{ current_user.Naam if current_user else '' }}">
          </div>
        </div>
        <div class="mt-3">
          <button class="btn btn-primary" type="submit">Materieel in gebruik nemen</button>
        </div>
      </form>
    </div>

  </div>
</div>

<!-- Modal: Materiaal wisselen naar andere werf -->
<div class="modal fade" id="switchWerfModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('werven.werf_switch_material', project_id=project.id) }}">
        <div class="modal-header">
          <h5 class="modal-title">Materiaal verplaatsen naar andere werf</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="usage_id" id="switch-usage-id">
          <p>
            Verplaats <strong id="switch-mat-name"></strong> 
            <span class="text-muted">(<span id="switch-mat-serial"></span>)</span>
            naar een andere werf:
          </p>
          <div class="mb-3">
            <label class="form-label">Selecteer doelwerf*</label>
            <select name="new_project_id" class="form-select" required>
              <option value="">-- Kies een werf --</option>
              {% for p in other_projects %}
                <option value="{{ p.id }}">{{ p.name or ('Werf ' ~ p.id) }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
          <button type="submit" class="btn btn-primary">Verplaatsen</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const switchModal = document.getElementById('switchWerfModal');
  if (switchModal) {
    switchModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      if (!button) return;

      const usageId = button.getAttribute('data-usage-id');
      const matName = button.getAttribute('data-mat-name') || 'dit materiaal';
      const matSerial = button.getAttribute('data-mat-serial') || '';

      document.getElementById('switch-usage-id').value = usageId;
      document.getElementById('switch-mat-name').textContent = matName;
      document.getElementById('switch-mat-serial').textContent = matSerial;
    });
  }
});
</script>

{% endblock %}
